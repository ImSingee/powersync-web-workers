var sr=Object.create;var je=Object.defineProperty;var or=Object.getOwnPropertyDescriptor;var ar=Object.getOwnPropertyNames;var cr=Object.getPrototypeOf,ur=Object.prototype.hasOwnProperty;var g=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var lr=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ar(e))!ur.call(r,i)&&i!==t&&je(r,i,{get:()=>e[i],enumerable:!(n=or(e,i))||n.enumerable});return r};var S=(r,e,t)=>(t=r!=null?sr(cr(r)):{},lr(e||!r||!r.__esModule?je(t,"default",{value:r,enumerable:!0}):t,r));var T=g((Ge,ee)=>{(function(r){"use strict";var e={};e.VERSION="1.6.1";var t,n={},i=function(a,c){return function(){return c.apply(a,arguments)}},o=function(){var a=arguments,c=a[0],d,h;for(h=1;h<a.length;h++)for(d in a[h])!(d in c)&&a[h].hasOwnProperty(d)&&(c[d]=a[h][d]);return c},s=function(a,c){return{value:a,name:c}};e.TRACE=s(1,"TRACE"),e.DEBUG=s(2,"DEBUG"),e.INFO=s(3,"INFO"),e.TIME=s(4,"TIME"),e.WARN=s(5,"WARN"),e.ERROR=s(8,"ERROR"),e.OFF=s(99,"OFF");var u=function(a){this.context=a,this.setLevel(a.filterLevel),this.log=this.info};u.prototype={setLevel:function(a){a&&"value"in a&&(this.context.filterLevel=a)},getLevel:function(){return this.context.filterLevel},enabledFor:function(a){var c=this.context.filterLevel;return a.value>=c.value},trace:function(){this.invoke(e.TRACE,arguments)},debug:function(){this.invoke(e.DEBUG,arguments)},info:function(){this.invoke(e.INFO,arguments)},warn:function(){this.invoke(e.WARN,arguments)},error:function(){this.invoke(e.ERROR,arguments)},time:function(a){typeof a=="string"&&a.length>0&&this.invoke(e.TIME,[a,"start"])},timeEnd:function(a){typeof a=="string"&&a.length>0&&this.invoke(e.TIME,[a,"end"])},invoke:function(a,c){t&&this.enabledFor(a)&&t(c,o({level:a},this.context))}};var l=new u({filterLevel:e.OFF});(function(){var a=e;a.enabledFor=i(l,l.enabledFor),a.trace=i(l,l.trace),a.debug=i(l,l.debug),a.time=i(l,l.time),a.timeEnd=i(l,l.timeEnd),a.info=i(l,l.info),a.warn=i(l,l.warn),a.error=i(l,l.error),a.log=a.info})(),e.setHandler=function(a){t=a},e.setLevel=function(a){l.setLevel(a);for(var c in n)n.hasOwnProperty(c)&&n[c].setLevel(a)},e.getLevel=function(){return l.getLevel()},e.get=function(a){return n[a]||(n[a]=new u(o({name:a},l.context)))},e.createDefaultHandler=function(a){a=a||{},a.formatter=a.formatter||function(p,f){f.name&&p.unshift("["+f.name+"]")};var c={},d=function(h,p){Function.prototype.apply.call(h,console,p)};return typeof console>"u"?function(){}:function(h,p){h=Array.prototype.slice.call(h);var f=console.log,m;p.level===e.TIME?(m=(p.name?"["+p.name+"] ":"")+h[0],h[1]==="start"?console.time?console.time(m):c[m]=new Date().getTime():console.timeEnd?console.timeEnd(m):d(f,[m+": "+(new Date().getTime()-c[m])+"ms"])):(p.level===e.WARN&&console.warn?f=console.warn:p.level===e.ERROR&&console.error?f=console.error:p.level===e.INFO&&console.info?f=console.info:p.level===e.DEBUG&&console.debug?f=console.debug:p.level===e.TRACE&&console.trace&&(f=console.trace),a.formatter(h,p),d(f,h))}},e.useDefaults=function(a){e.setLevel(a&&a.defaultLevel||e.DEBUG),e.setHandler(e.createDefaultHandler(a))},e.setDefaults=e.useDefaults,typeof define=="function"&&define.amd?define(e):typeof ee<"u"&&ee.exports?ee.exports=e:(e._prevLogger=r.Logger,e.noConflict=function(){return r.Logger=e._prevLogger,e},r.Logger=e)})(Ge)});var Qe=g(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});var _e=class{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;let t={value:e,done:!1};if(this.pullQueue.length){let n=this.pullQueue.shift();n&&n.resolve(t)}else this.pushQueue.push(Promise.resolve(t)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(let e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(let t of this.pullQueue)t.reject(e);this.pullQueue.length=0}else{let t=Promise.reject(e);t.catch(()=>{}),this.pushQueue.push(t)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{let t=this.pushQueue.shift();return t?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),t):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,i)=>{this.pullQueue.push({resolve:n,reject:i})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}},te=class{constructor(e,{highWaterMark:t=100,lowWaterMark:n=1}={}){let i=new _e;i.highWaterMark=t,i.lowWaterMark=n,i.removeCallback=e({push:o=>i.push(o),stop:()=>i.stop(),fail:o=>i.fail(o),on:(o,s)=>{i.eventHandlers[o]=s}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}};re.EventIterator=te;re.default=te});var Ye=g($=>{"use strict";Object.defineProperty($,"__esModule",{value:!0});var xe=Qe();$.EventIterator=xe.EventIterator;function xr(r,e,t){return new xe.EventIterator(({push:n})=>(this.addEventListener(r,n,e),()=>this.removeEventListener(r,n,e)),t)}$.subscribe=xr;$.default=xe.EventIterator});var ne=g(($n,Xe)=>{function Cr(r){var e=typeof r;return r!=null&&(e=="object"||e=="function")}Xe.exports=Cr});var Ze=g((qn,Ke)=>{var Tr=typeof global=="object"&&global&&global.Object===Object&&global;Ke.exports=Tr});var Ce=g((Bn,et)=>{var kr=Ze(),Or=typeof self=="object"&&self&&self.Object===Object&&self,Rr=kr||Or||Function("return this")();et.exports=Rr});var rt=g((Hn,tt)=>{var Lr=Ce(),Ar=function(){return Lr.Date.now()};tt.exports=Ar});var it=g((zn,nt)=>{var Ir=/\s/;function Dr(r){for(var e=r.length;e--&&Ir.test(r.charAt(e)););return e}nt.exports=Dr});var ot=g((Jn,st)=>{var Nr=it(),Fr=/^\s+/;function Mr(r){return r&&r.slice(0,Nr(r)+1).replace(Fr,"")}st.exports=Mr});var Te=g((Vn,at)=>{var Pr=Ce(),Ur=Pr.Symbol;at.exports=Ur});var dt=g((Gn,lt)=>{var ct=Te(),ut=Object.prototype,Wr=ut.hasOwnProperty,jr=ut.toString,q=ct?ct.toStringTag:void 0;function $r(r){var e=Wr.call(r,q),t=r[q];try{r[q]=void 0;var n=!0}catch{}var i=jr.call(r);return n&&(e?r[q]=t:delete r[q]),i}lt.exports=$r});var pt=g((Qn,ht)=>{var qr=Object.prototype,Br=qr.toString;function Hr(r){return Br.call(r)}ht.exports=Hr});var yt=g((Yn,gt)=>{var ft=Te(),zr=dt(),Jr=pt(),Vr="[object Null]",Gr="[object Undefined]",mt=ft?ft.toStringTag:void 0;function Qr(r){return r==null?r===void 0?Gr:Vr:mt&&mt in Object(r)?zr(r):Jr(r)}gt.exports=Qr});var vt=g((Xn,wt)=>{function Yr(r){return r!=null&&typeof r=="object"}wt.exports=Yr});var St=g((Kn,bt)=>{var Xr=yt(),Kr=vt(),Zr="[object Symbol]";function en(r){return typeof r=="symbol"||Kr(r)&&Xr(r)==Zr}bt.exports=en});var Ct=g((Zn,xt)=>{var tn=ot(),Et=ne(),rn=St(),_t=NaN,nn=/^[-+]0x[0-9a-f]+$/i,sn=/^0b[01]+$/i,on=/^0o[0-7]+$/i,an=parseInt;function cn(r){if(typeof r=="number")return r;if(rn(r))return _t;if(Et(r)){var e=typeof r.valueOf=="function"?r.valueOf():r;r=Et(e)?e+"":e}if(typeof r!="string")return r===0?r:+r;r=tn(r);var t=sn.test(r);return t||on.test(r)?an(r.slice(2),t?2:8):nn.test(r)?_t:+r}xt.exports=cn});var Ot=g((ei,kt)=>{var un=ne(),ke=rt(),Tt=Ct(),ln="Expected a function",dn=Math.max,hn=Math.min;function pn(r,e,t){var n,i,o,s,u,l,a=0,c=!1,d=!1,h=!0;if(typeof r!="function")throw new TypeError(ln);e=Tt(e)||0,un(t)&&(c=!!t.leading,d="maxWait"in t,o=d?dn(Tt(t.maxWait)||0,e):o,h="trailing"in t?!!t.trailing:h);function p(y){var O=n,j=i;return n=i=void 0,a=y,s=r.apply(j,O),s}function f(y){return a=y,u=setTimeout(F,e),c?p(y):s}function m(y){var O=y-l,j=y-a,We=e-O;return d?hn(We,o-j):We}function N(y){var O=y-l,j=y-a;return l===void 0||O>=e||O<0||d&&j>=o}function F(){var y=ke();if(N(y))return Ue(y);u=setTimeout(F,m(y))}function Ue(y){return u=void 0,h&&n?p(y):(n=i=void 0,s)}function nr(){u!==void 0&&clearTimeout(u),a=0,n=l=i=u=void 0}function ir(){return u===void 0?s:Ue(ke())}function ye(){var y=ke(),O=N(y);if(n=arguments,i=this,l=y,O){if(u===void 0)return f(l);if(d)return clearTimeout(u),u=setTimeout(F,e),p(l)}return u===void 0&&(u=setTimeout(F,e)),s}return ye.cancel=nr,ye.flush=ir,ye}kt.exports=pn});var Oe=g((ti,Rt)=>{var fn=Ot(),mn=ne(),gn="Expected a function";function yn(r,e,t){var n=!0,i=!0;if(typeof r!="function")throw new TypeError(gn);return mn(t)&&(n="leading"in t?!!t.leading:n,i="trailing"in t?!!t.trailing:i),fn(r,e,{leading:n,maxWait:e,trailing:i})}Rt.exports=yn});var $t=g((xi,jt)=>{jt.exports={}});var Bt=g((Ci,qt)=>{"use strict";var Sn=$t(),En=function(r){var e,t=!1;return new ReadableStream({start:function(n){var i=r.getReader();e=i;var o=new TextDecoder,s="";i.read().then(function u(l){if(l.done){if(t)return;if(s=s.trim(),s.length!==0)try{var a=JSON.parse(s);n.enqueue(a)}catch(m){n.error(m);return}n.close();return}var c=o.decode(l.value,{stream:!0});s+=c;for(var d=s.split(`
`),h=0;h<d.length-1;++h){var p=d[h].trim();if(p.length>0)try{var f=JSON.parse(p);n.enqueue(f)}catch(m){n.error(m),t=!0,i.cancel();return}}return s=d[d.length-1],i.read().then(u)})},cancel:function(n){console.log("Cancel registered due to ",n),t=!0,e.cancel()}})};qt.exports=Sn.ndjsonStream=En});var qe=Symbol("Comlink.proxy"),dr=Symbol("Comlink.endpoint"),be=Symbol("Comlink.releaseProxy"),we=Symbol("Comlink.finalizer"),G=Symbol("Comlink.thrown"),Be=r=>typeof r=="object"&&r!==null||typeof r=="function",hr={canHandle:r=>Be(r)&&r[qe],serialize(r){let{port1:e,port2:t}=new MessageChannel;return K(r,e),[t,[t]]},deserialize(r){return r.start(),A(r)}},pr={canHandle:r=>Be(r)&&G in r,serialize({value:r}){let e;return r instanceof Error?e={isError:!0,value:{message:r.message,name:r.name,stack:r.stack}}:e={isError:!1,value:r},[e,[]]},deserialize(r){throw r.isError?Object.assign(new Error(r.value.message),r.value):r.value}},He=new Map([["proxy",hr],["throw",pr]]);function fr(r,e){for(let t of r)if(e===t||t==="*"||t instanceof RegExp&&t.test(e))return!0;return!1}function K(r,e=globalThis,t=["*"]){e.addEventListener("message",function n(i){if(!i||!i.data)return;if(!fr(t,i.origin)){console.warn(`Invalid origin '${i.origin}' for comlink proxy`);return}let{id:o,type:s,path:u}=Object.assign({path:[]},i.data),l=(i.data.argumentList||[]).map(L),a;try{let c=u.slice(0,-1).reduce((h,p)=>h[p],r),d=u.reduce((h,p)=>h[p],r);switch(s){case"GET":a=d;break;case"SET":c[u.slice(-1)[0]]=L(i.data.value),a=!0;break;case"APPLY":a=d.apply(c,l);break;case"CONSTRUCT":{let h=new d(...l);a=Se(h)}break;case"ENDPOINT":{let{port1:h,port2:p}=new MessageChannel;K(r,p),a=vr(h,[h])}break;case"RELEASE":a=void 0;break;default:return}}catch(c){a={value:c,[G]:0}}Promise.resolve(a).catch(c=>({value:c,[G]:0})).then(c=>{let[d,h]=X(c);e.postMessage(Object.assign(Object.assign({},d),{id:o}),h),s==="RELEASE"&&(e.removeEventListener("message",n),ze(e),we in r&&typeof r[we]=="function"&&r[we]())}).catch(c=>{let[d,h]=X({value:new TypeError("Unserializable return value"),[G]:0});e.postMessage(Object.assign(Object.assign({},d),{id:o}),h)})}),e.start&&e.start()}function mr(r){return r.constructor.name==="MessagePort"}function ze(r){mr(r)&&r.close()}function A(r,e){return ve(r,[],e)}function V(r){if(r)throw new Error("Proxy has been released and is not useable")}function Je(r){return M(r,{type:"RELEASE"}).then(()=>{ze(r)})}var Q=new WeakMap,Y="FinalizationRegistry"in globalThis&&new FinalizationRegistry(r=>{let e=(Q.get(r)||0)-1;Q.set(r,e),e===0&&Je(r)});function gr(r,e){let t=(Q.get(e)||0)+1;Q.set(e,t),Y&&Y.register(r,e,r)}function yr(r){Y&&Y.unregister(r)}function ve(r,e=[],t=function(){}){let n=!1,i=new Proxy(t,{get(o,s){if(V(n),s===be)return()=>{yr(i),Je(r),n=!0};if(s==="then"){if(e.length===0)return{then:()=>i};let u=M(r,{type:"GET",path:e.map(l=>l.toString())}).then(L);return u.then.bind(u)}return ve(r,[...e,s])},set(o,s,u){V(n);let[l,a]=X(u);return M(r,{type:"SET",path:[...e,s].map(c=>c.toString()),value:l},a).then(L)},apply(o,s,u){V(n);let l=e[e.length-1];if(l===dr)return M(r,{type:"ENDPOINT"}).then(L);if(l==="bind")return ve(r,e.slice(0,-1));let[a,c]=$e(u);return M(r,{type:"APPLY",path:e.map(d=>d.toString()),argumentList:a},c).then(L)},construct(o,s){V(n);let[u,l]=$e(s);return M(r,{type:"CONSTRUCT",path:e.map(a=>a.toString()),argumentList:u},l).then(L)}});return gr(i,r),i}function wr(r){return Array.prototype.concat.apply([],r)}function $e(r){let e=r.map(X);return[e.map(t=>t[0]),wr(e.map(t=>t[1]))]}var Ve=new WeakMap;function vr(r,e){return Ve.set(r,e),r}function Se(r){return Object.assign(r,{[qe]:!0})}function X(r){for(let[e,t]of He)if(t.canHandle(r)){let[n,i]=t.serialize(r);return[{type:"HANDLER",name:e,value:n},i]}return[{type:"RAW",value:r},Ve.get(r)||[]]}function L(r){switch(r.type){case"HANDLER":return He.get(r.name).deserialize(r.value);case"RAW":return r.value}}function M(r,e,t){return new Promise(n=>{let i=br();r.addEventListener("message",function o(s){!s.data||!s.data.id||s.data.id!==i||(r.removeEventListener("message",o),n(s.data))}),r.start&&r.start(),r.postMessage(Object.assign({id:i},e),t)})}function br(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var tr=S(T());var Mn=new Error("timeout while waiting for mutex to become available"),Pn=new Error("mutex already locked"),Sr=new Error("request for lock canceled"),Er=function(r,e,t,n){function i(o){return o instanceof t?o:new t(function(s){s(o)})}return new(t||(t=Promise))(function(o,s){function u(c){try{a(n.next(c))}catch(d){s(d)}}function l(c){try{a(n.throw(c))}catch(d){s(d)}}function a(c){c.done?o(c.value):i(c.value).then(u,l)}a((n=n.apply(r,e||[])).next())})},Ee=class{constructor(e,t=Sr){this._value=e,this._cancelError=t,this._weightedQueues=[],this._weightedWaiters=[]}acquire(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((t,n)=>{this._weightedQueues[e-1]||(this._weightedQueues[e-1]=[]),this._weightedQueues[e-1].push({resolve:t,reject:n}),this._dispatch()})}runExclusive(e,t=1){return Er(this,void 0,void 0,function*(){let[n,i]=yield this.acquire(t);try{return yield e(n)}finally{i()}})}waitForUnlock(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise(t=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),this._weightedWaiters[e-1].push(t),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatch()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatch()}cancel(){this._weightedQueues.forEach(e=>e.forEach(t=>t.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var e;for(let t=this._value;t>0;t--){let n=(e=this._weightedQueues[t-1])===null||e===void 0?void 0:e.shift();if(!n)continue;let i=this._value,o=t;this._value-=t,t=this._value+1,n.resolve([i,this._newReleaser(o)])}this._drainUnlockWaiters()}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){for(let e=this._value;e>0;e--)this._weightedWaiters[e-1]&&(this._weightedWaiters[e-1].forEach(t=>t()),this._weightedWaiters[e-1]=[])}},_r=function(r,e,t,n){function i(o){return o instanceof t?o:new t(function(s){s(o)})}return new(t||(t=Promise))(function(o,s){function u(c){try{a(n.next(c))}catch(d){s(d)}}function l(c){try{a(n.throw(c))}catch(d){s(d)}}function a(c){c.done?o(c.value):i(c.value).then(u,l)}a((n=n.apply(r,e||[])).next())})},P=class{constructor(e){this._semaphore=new Ee(1,e)}acquire(){return _r(this,void 0,void 0,function*(){let[,e]=yield this._semaphore.acquire();return e})}runExclusive(e){return this._semaphore.runExclusive(()=>e())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}};var Fe=S(Ye()),Qt=S(T()),Yt=S(Oe());var Lt;(function(r){r[r.SQLITE_INSERT=18]="SQLITE_INSERT",r[r.SQLITE_DELETE=9]="SQLITE_DELETE",r[r.SQLITE_UPDATE=23]="SQLITE_UPDATE"})(Lt||(Lt={}));function Re(r){return"tables"in r}function At(r){return Re(r)?r.tables:[r.table]}var E=class{options;constructor(e){this.options=e}get connected(){return this.options.connected??!1}get lastSyncedAt(){return this.options.lastSyncedAt}get hasSynced(){return this.options.hasSynced}get dataFlowStatus(){return this.options.dataFlow??{downloading:!1,uploading:!1}}isEqual(e){return JSON.stringify(this.options)==JSON.stringify(e.options)}getMessage(){let e=this.dataFlowStatus;return`SyncStatus<connected: ${this.connected} lastSyncedAt: ${this.lastSyncedAt} hasSynced: ${this.hasSynced}. Downloading: ${e.downloading}. Uploading: ${e.uploading}`}toJSON(){return{connected:this.connected,dataFlow:this.dataFlowStatus,lastSyncedAt:this.lastSyncedAt,hasSynced:this.hasSynced}}};var B=class{count;size;constructor(e,t=null){this.count=e,this.size=t}toString(){return this.size==null?`UploadQueueStats<count:${this.count}>`:`UploadQueueStats<count: $count size: ${this.size/1024}kB>`}};var ie,wn=new Uint8Array(16);function Le(){if(!ie&&(ie=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ie))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ie(wn)}var b=[];for(let r=0;r<256;++r)b.push((r+256).toString(16).slice(1));function It(r,e=0){return b[r[e+0]]+b[r[e+1]]+b[r[e+2]]+b[r[e+3]]+"-"+b[r[e+4]]+b[r[e+5]]+"-"+b[r[e+6]]+b[r[e+7]]+"-"+b[r[e+8]]+b[r[e+9]]+"-"+b[r[e+10]]+b[r[e+11]]+b[r[e+12]]+b[r[e+13]]+b[r[e+14]]+b[r[e+15]]}var vn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ae={randomUUID:vn};function bn(r,e,t){if(Ae.randomUUID&&!e&&!r)return Ae.randomUUID();r=r||{};let n=r.random||(r.rng||Le)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){t=t||0;for(let i=0;i<16;++i)e[t+i]=n[i];return e}return It(n)}var H=bn;var x=class{listeners;constructor(){this.listeners={}}registerListener(e){let t=H();return this.listeners[t]=e,()=>{delete this.listeners[t]}}iterateListeners(e){for(let t in this.listeners)e(this.listeners[t])}};async function Ie(r,e,t){return new Promise((n,i)=>{let o=t?.timeoutMs,s=!1,u=o?setTimeout(()=>{s=!0,i(new Error("Timeout waiting for lock"))},o):void 0;r.runExclusive(async()=>{if(u&&clearTimeout(u),!s)try{n(await e())}catch(l){i(l)}})})}function Dt(r){return`"${r.replaceAll('"','""')}"`}var w;(function(r){r.DATA="ps_data",r.CRUD="ps_crud",r.BUCKETS="ps_buckets",r.OPLOG="ps_oplog",r.UNTYPED="ps_untyped"})(w||(w={}));var U=class{crud;haveMore;complete;constructor(e,t,n){this.crud=e,this.haveMore=t,this.complete=n}};var Nt;(function(r){r.PUT="PUT",r.PATCH="PATCH",r.DELETE="DELETE"})(Nt||(Nt={}));var R=class r{clientId;id;op;opData;table;transactionId;static fromRow(e){let t=JSON.parse(e.data);return new r(parseInt(e.id),t.op,t.type,t.id,e.tx_id,t.data)}constructor(e,t,n,i,o,s){this.clientId=e,this.id=i,this.op=t,this.opData=s,this.table=n,this.transactionId=o}toJSON(){return{op_id:this.clientId,op:this.op,type:this.table,id:this.id,tx_id:this.transactionId,data:this.opData}}equals(e){return JSON.stringify(this.toComparisonArray())==JSON.stringify(e.toComparisonArray())}hashCode(){return JSON.stringify(this.toComparisonArray())}toComparisonArray(){return[this.transactionId,this.clientId,this.op,this.table,this.id,this.opData]}};var se=class extends U{crud;complete;transactionId;constructor(e,t,n){super(e,!1,t),this.crud=e,this.complete=t,this.transactionId=n}};var Ht=S(Oe()),zt=S(T());function Ft(r){return r.data!=null}function Mt(r){return r.token_expires_in!=null}function Pt(r){return r.checkpoint!=null}function Ut(r){return r.checkpoint_complete!=null}function Wt(r){return r.checkpoint_diff!=null}var Jt=S(Bt());var I;(function(r){r[r.CLEAR=1]="CLEAR",r[r.MOVE=2]="MOVE",r[r.PUT=3]="PUT",r[r.REMOVE=4]="REMOVE"})(I||(I={}));var oe=class r{value;static fromJSON(e){return new r(I[e])}constructor(e){this.value=e}toJSON(){return Object.entries(I).find(([,e])=>e===this.value)[0]}};var ae=class r{op_id;op;checksum;subkey;object_type;object_id;data;static fromRow(e){return new r(e.op_id,oe.fromJSON(e.op),e.checksum,typeof e.subkey=="string"?e.subkey:JSON.stringify(e.subkey),e.object_type,e.object_id,e.data)}constructor(e,t,n,i,o,s,u){this.op_id=e,this.op=t,this.checksum=n,this.subkey=i,this.object_type=o,this.object_id=s,this.data=u}toJSON(){return{op_id:this.op_id,op:this.op.toJSON(),object_type:this.object_type,object_id:this.object_id,checksum:this.checksum,data:this.data,subkey:JSON.stringify(this.subkey)}}};var z=class r{bucket;data;has_more;after;next_after;static fromRow(e){return new r(e.bucket,e.data.map(t=>ae.fromRow(t)),e.has_more??!1,e.after,e.next_after)}constructor(e,t,n,i,o){this.bucket=e,this.data=t,this.has_more=n,this.after=i,this.next_after=o}toJSON(){return{bucket:this.bucket,has_more:this.has_more,after:this.after,next_after:this.next_after,data:this.data.map(e=>e.toJSON())}}};var C=class r extends Error{reason;constructor(e){super(e),this.reason=e,Object.setPrototypeOf(this,r.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,r)}};var W;(function(r){r.CRUD="crud",r.SYNC="sync"})(W||(W={}));var De=1e3,_n={retryDelayMs:5e3,logger:zt.default.get("PowerSyncStream"),crudUploadThrottleMs:De},ce=class extends x{_lastSyncedAt;options;abortController;crudUpdateListener;streamingSyncPromise;syncStatus;triggerCrudUpload;constructor(e){super(),this.options={..._n,...e},this.syncStatus=new E({connected:!1,lastSyncedAt:void 0,dataFlow:{uploading:!1,downloading:!1}}),this.abortController=null,this.triggerCrudUpload=(0,Ht.default)(()=>{!this.syncStatus.connected||this.syncStatus.dataFlowStatus.uploading||this._uploadAllCrud()},this.options.crudUploadThrottleMs,{trailing:!0})}async waitForReady(){}waitForStatus(e){return new Promise(t=>{let n=this.registerListener({statusChanged:i=>{let o=(s,u)=>Object.entries(s).every(([l,a])=>{let c=u[l];return typeof a=="object"&&typeof c=="object"?o(a,c):a==c});o(e,i.toJSON())&&(t(),n?.())}})})}get lastSyncedAt(){let e=this.syncStatus.lastSyncedAt;return e&&new Date(e)}get isConnected(){return this.syncStatus.connected}get logger(){return this.options.logger}async dispose(){this.crudUpdateListener?.(),this.crudUpdateListener=void 0}async hasCompletedSync(){return this.options.adapter.hasCompletedSync()}async getWriteCheckpoint(){return(await this.options.remote.get("/write-checkpoint2.json")).data.write_checkpoint}async _uploadAllCrud(){return this.obtainLock({type:W.CRUD,callback:async()=>{for(this.updateSyncStatus({dataFlow:{uploading:!0}});;)try{if(await this.uploadCrudBatch())break}catch{this.updateSyncStatus({connected:!1,dataFlow:{uploading:!1}}),await this.delayRetry();break}finally{this.updateSyncStatus({dataFlow:{uploading:!1}})}}})}async uploadCrudBatch(){return await this.options.adapter.hasCrud()?(await this.options.uploadCrud(),!1):(await this.options.adapter.updateLocalTarget(()=>this.getWriteCheckpoint()),!0)}async connect(){return this.abortController&&await this.disconnect(),this.abortController=new AbortController,this.streamingSyncPromise=this.streamingSync(this.abortController.signal),new Promise(e=>{let t=this.registerListener({statusUpdated:n=>{typeof n.connected>"u"||(n.connected==!1&&this.logger.warn("Initial connect attempt did not successfully connect to server"),e(),t())}})})}async disconnect(){if(this.abortController){this.abortController.signal.aborted||this.abortController.abort(new C("Disconnect has been requested"));try{await this.streamingSyncPromise}catch(e){this.logger.warn(e)}this.streamingSyncPromise=void 0,this.abortController=null,this.updateSyncStatus({connected:!1})}}async streamingSync(e){e||(this.abortController=new AbortController,e=this.abortController.signal),this.crudUpdateListener=this.options.adapter.registerListener({crudUpdate:()=>this.triggerCrudUpload()});let t=new AbortController;for(e.addEventListener("abort",()=>{t.abort(e?.reason??new C("Received command to disconnect from upstream")),this.crudUpdateListener?.(),this.crudUpdateListener=void 0,this.updateSyncStatus({connected:!1,dataFlow:{downloading:!1}})});;)try{if(e?.aborted)break;let{retry:n}=await this.streamingSyncIteration(t.signal);if(!n)break}catch(n){n instanceof C?this.logger.warn(n):this.logger.error(n),await this.delayRetry()}finally{e.aborted||(t.abort(new C("Closing sync stream network requests before retry.")),t=new AbortController),this.updateSyncStatus({connected:!1})}this.updateSyncStatus({connected:!1})}async streamingSyncIteration(e,t){return await this.obtainLock({type:W.SYNC,signal:e,callback:async()=>{this.logger.debug("Streaming sync iteration started"),this.options.adapter.startSession();let n=await this.options.adapter.getBucketStates(),i=new Map;n.forEach(c=>{i.set(c.bucket,c.op_id)});let o=Array.from(i.entries()).map(([c,d])=>({name:c,after:d})),s=null,u=null,l=null,a=new Set(i.keys());for await(let c of this.streamingSyncRequest({buckets:o,include_checksum:!0,raw_data:!0},e)){if(Pt(c)){s=c.checkpoint;let d=new Set(a),h=new Set;for(let p of c.checkpoint.buckets)h.add(p.bucket),d.delete(p.bucket);d.size>0&&this.logger.debug("Removing buckets",[...d]),a=h,await this.options.adapter.removeBuckets([...d]),await this.options.adapter.setTargetCheckpoint(s)}else if(Ut(c)){this.logger.debug("Checkpoint complete",s);let d=await this.options.adapter.syncLocalDatabase(s);if(d.checkpointValid)d.ready&&(l=s,this.logger.debug("validated checkpoint",l),this.updateSyncStatus({connected:!0,lastSyncedAt:new Date,dataFlow:{downloading:!1}}));else return await new Promise(h=>setTimeout(h,50)),{retry:!0};u=s}else if(Wt(c)){if(s==null)throw new Error("Checkpoint diff without previous checkpoint");let d=c.checkpoint_diff,h=new Map;for(let m of s.buckets)h.set(m.bucket,m);for(let m of d.updated_buckets)h.set(m.bucket,m);for(let m of d.removed_buckets)h.delete(m);s={last_op_id:d.last_op_id,buckets:[...h.values()],write_checkpoint:d.write_checkpoint},a=new Set(h.keys());let f=d.removed_buckets;f.length>0&&this.logger.debug("Remove buckets",f),await this.options.adapter.removeBuckets(f),await this.options.adapter.setTargetCheckpoint(s)}else if(Ft(c)){let{data:d}=c;this.updateSyncStatus({dataFlow:{downloading:!0}}),await this.options.adapter.saveSyncData({buckets:[z.fromRow(d)]})}else if(Mt(c)){if(c.token_expires_in==0)return this.logger.debug("Token expiring; reconnect"),{retry:!0};this.triggerCrudUpload()}else if(this.logger.debug("Sync complete"),s===l)this.updateSyncStatus({connected:!0,lastSyncedAt:new Date});else if(u===s){let d=await this.options.adapter.syncLocalDatabase(s);if(d.checkpointValid)d.ready&&(l=s,this.updateSyncStatus({connected:!0,lastSyncedAt:new Date,dataFlow:{downloading:!1}}));else return await new Promise(h=>setTimeout(h,50)),{retry:!1}}t?.()}return this.logger.debug("Stream input empty"),{retry:!0}}})}async*streamingSyncRequest(e,t){let n=await this.options.remote.postStreaming("/sync/stream",e,{},t);Promise.resolve().then(()=>this.triggerCrudUpload()),this.updateSyncStatus({connected:!0});let o=(0,Jt.default)(n).getReader();try{for(;;){let{done:s,value:u}=await o.read();if(s)return;yield u}}finally{o.releaseLock()}}updateSyncStatus(e){let t=new E({connected:e.connected??this.syncStatus.connected,lastSyncedAt:e.lastSyncedAt??this.syncStatus.lastSyncedAt,dataFlow:{...this.syncStatus.dataFlowStatus,...e.dataFlow}});this.syncStatus.isEqual(t)||(this.syncStatus=t,this.iterateListeners(n=>n.statusChanged?.(t))),this.iterateListeners(n=>n.statusUpdated?.(e))}async delayRetry(){return new Promise(e=>setTimeout(e,this.options.retryDelayMs))}};var Ne=/(^ps_data__|^ps_data_local__)/,xn={clearLocal:!0},Cn={disconnect:!0},Tn=30,kn={retryDelay:5e3,logger:Qt.default.get("PowerSyncDatabase"),crudUploadThrottleMs:De},Vt=12e4,Gt=class r extends x{options;static transactionMutex=new P;closed;ready;currentStatus;syncStreamImplementation;sdkVersion;bucketStorageAdapter;syncStatusListenerDisposer;_isReadyPromise;hasSyncedWatchDisposer;_schema;constructor(e){super(),this.options=e,this.bucketStorageAdapter=this.generateBucketStorageAdapter(),this.closed=!1,this.currentStatus=new E({}),this.options={...kn,...e},this._schema=e.schema,this.ready=!1,this.sdkVersion="",this._isReadyPromise=this.initialize()}get schema(){return this._schema}get database(){return this.options.database}get connected(){return this.currentStatus?.connected||!1}async waitForReady(){this.ready||await this._isReadyPromise}async waitForFirstSync(e){if(!this.currentStatus.hasSynced)return new Promise(t=>{let n=this.registerListener({statusChanged:i=>{i.hasSynced&&(n(),t())}});e?.addEventListener("abort",()=>{n(),t()})})}async initialize(){await this._initialize(),await this.bucketStorageAdapter.init();let e=await this.options.database.execute("SELECT powersync_rs_version()");this.sdkVersion=e.rows?.item(0)["powersync_rs_version()"]??"",await this.updateSchema(this.options.schema),this.updateHasSynced(),await this.database.execute("PRAGMA RECURSIVE_TRIGGERS=TRUE"),this.ready=!0,this.iterateListeners(t=>t.initialized?.())}async updateHasSynced(){let e="SELECT 1 FROM ps_buckets WHERE last_applied_op > 0 LIMIT 1",t=new AbortController;this.hasSyncedWatchDisposer=()=>t.abort(),this.watch(e,[],{onResult:n=>{let i=!!n.rows?.length;i!=this.currentStatus.hasSynced&&(this.currentStatus=new E({...this.currentStatus.toJSON(),hasSynced:i}),this.iterateListeners(o=>o.statusChanged?.(this.currentStatus))),i&&t.abort()},onError:n=>{this.options.logger?.warn("Failure while watching synced state",n),t.abort()}},{rawTableNames:!0,signal:t.signal})}async updateSchema(e){if(this.syncStreamImplementation)throw new Error("Cannot update schema while connected");try{e.validate()}catch(t){this.options.logger?.warn("Schema validation failed. Unexpected behaviour could occur",t)}this._schema=e,await this.database.execute("SELECT powersync_replace_schema(?)",[JSON.stringify(this.schema.toJSON())])}async init(){return this.waitForReady()}async connect(e){if(await this.waitForReady(),await this.disconnect(),this.closed)throw new Error("Cannot connect using a closed client");this.syncStreamImplementation=this.generateSyncStreamImplementation(e),this.syncStatusListenerDisposer=this.syncStreamImplementation.registerListener({statusChanged:t=>{this.currentStatus=new E({...t.toJSON(),hasSynced:this.currentStatus?.hasSynced}),this.iterateListeners(n=>n.statusChanged?.(this.currentStatus))}}),await this.syncStreamImplementation.waitForReady(),this.syncStreamImplementation.triggerCrudUpload(),await this.syncStreamImplementation.connect()}async disconnect(){await this.waitForReady(),await this.syncStreamImplementation?.disconnect(),this.syncStatusListenerDisposer?.(),await this.syncStreamImplementation?.dispose(),this.syncStreamImplementation=void 0}async disconnectAndClear(e=xn){await this.disconnect(),await this.waitForReady();let{clearLocal:t}=e;await this.database.writeTransaction(async n=>{await n.execute(`DELETE FROM ${w.OPLOG}`),await n.execute(`DELETE FROM ${w.CRUD}`),await n.execute(`DELETE FROM ${w.BUCKETS}`),await n.execute(`DELETE FROM ${w.UNTYPED}`);let i=t?"ps_data_*":"ps_data__*",o=await n.execute(`
      SELECT name FROM sqlite_master WHERE type='table' AND name GLOB ?
      `,[i]);if(o.rows?.length)for(let s of o.rows._array)await n.execute(`DELETE FROM ${Dt(s.name)} WHERE 1`)})}async close(e=Cn){await this.waitForReady(),this.hasSyncedWatchDisposer?.();let{disconnect:t}=e;t&&await this.disconnect(),await this.syncStreamImplementation?.dispose(),this.database.close(),this.closed=!0}async getUploadQueueStats(e){return this.readTransaction(async t=>{if(e){let i=(await t.execute(`SELECT SUM(cast(data as blob) + 20) as size, count(*) as count FROM ${w.CRUD}`)).rows.item(0);return new B(i?.count??0,i?.size??0)}else{let i=(await t.execute(`SELECT count(*) as count FROM ${w.CRUD}`)).rows.item(0);return new B(i?.count??0)}})}async getCrudBatch(e){let n=(await this.getAll(`SELECT id, tx_id, data FROM ${w.CRUD} ORDER BY id ASC LIMIT ?`,[e+1])).map(s=>R.fromRow(s))??[],i=!1;if(n.length>e&&(n.pop(),i=!0),n.length==0)return null;let o=n[n.length-1];return new U(n,i,async s=>this.handleCrudCheckpoint(o.clientId,s))}async getNextCrudTransaction(){return await this.readTransaction(async e=>{let t=await e.getOptional(`SELECT id, tx_id, data FROM ${w.CRUD} ORDER BY id ASC LIMIT 1`);if(!t)return null;let n=t.tx_id,i;n?i=(await e.getAll(`SELECT id, tx_id, data FROM ${w.CRUD} WHERE tx_id = ? ORDER BY id ASC`,[n])).map(u=>R.fromRow(u)):i=[R.fromRow(t)];let o=i[i.length-1];return new se(i,async s=>this.handleCrudCheckpoint(o.clientId,s),n)})}async handleCrudCheckpoint(e,t){return this.writeTransaction(async n=>{await n.execute(`DELETE FROM ${w.CRUD} WHERE id <= ?`,[e]),t?(await n.execute(`SELECT 1 FROM ${w.CRUD} LIMIT 1`)).rows?.length||await n.execute(`UPDATE ${w.BUCKETS} SET target_op = ? WHERE name='$local'`,[t]):await n.execute(`UPDATE ${w.BUCKETS} SET target_op = ? WHERE name='$local'`,[this.bucketStorageAdapter.getMaxOpId()])})}async execute(e,t){return await this.waitForReady(),this.database.execute(e,t)}async executeBatch(e,t){return await this.waitForReady(),this.database.executeBatch(e,t)}async getAll(e,t){return await this.waitForReady(),this.database.getAll(e,t)}async getOptional(e,t){return await this.waitForReady(),this.database.getOptional(e,t)}async get(e,t){return await this.waitForReady(),this.database.get(e,t)}async readLock(e){return await this.waitForReady(),Ie(r.transactionMutex,()=>e(this.database))}async writeLock(e){return await this.waitForReady(),Ie(r.transactionMutex,async()=>await e(this.database))}async readTransaction(e,t=Vt){return await this.waitForReady(),this.database.readTransaction(async n=>{let i=await e({...n});return await n.rollback(),i},{timeoutMs:t})}async writeTransaction(e,t=Vt){return await this.waitForReady(),this.database.writeTransaction(async n=>{let i=await e(n);return await n.commit(),i},{timeoutMs:t})}watch(e,t,n,i){if(n&&typeof n=="object"&&"onResult"in n){let s=n,u=i;return this.watchWithCallback(e,t,s,u)}let o=n;return this.watchWithAsyncGenerator(e,t,o)}watchWithCallback(e,t,n,i){let{onResult:o,onError:s=u=>this.options.logger?.error(u)}=n??{};if(!o)throw new Error("onResult is required");(async()=>{try{let u=await this.resolveTables(e,t,i),l=await this.executeReadOnly(e,t);o(l),this.onChangeWithCallback({onChange:async()=>{try{let a=await this.executeReadOnly(e,t);o(a)}catch(a){s?.(a)}},onError:s},{...i??{},tables:u})}catch(u){s?.(u)}})()}watchWithAsyncGenerator(e,t,n){return new Fe.EventIterator(i=>{(async()=>{let o=await this.resolveTables(e,t,n);i.push(await this.executeReadOnly(e,t));for await(let s of this.onChangeWithAsyncGenerator({...n??{},tables:o}))i.push(await this.executeReadOnly(e,t))})()})}async resolveTables(e,t,n){let i=n?.tables?[...n.tables]:[];if(!n?.tables){let s=(await this.getAll(`EXPLAIN ${e}`,t)).filter(l=>l.opcode=="OpenRead"&&l.p3==0&&typeof l.p2=="number").map(l=>l.p2),u=await this.getAll("SELECT DISTINCT tbl_name FROM sqlite_master WHERE rootpage IN (SELECT json_each.value FROM json_each(?))",[JSON.stringify(s)]);for(let l of u)i.push(l.tbl_name.replace(Ne,""))}return i}onChange(e,t){if(e&&typeof e=="object"&&"onChange"in e){let i=e,o=t;return this.onChangeWithCallback(i,o)}let n=e;return this.onChangeWithAsyncGenerator(n)}onChangeWithCallback(e,t){let{onChange:n,onError:i=d=>this.options.logger?.error(d)}=e??{};if(!n)throw new Error("onChange is required");let o=t??{},s=new Set(o.tables??[]),u=new Set,l=o.throttleMs??Tn,a=(0,Yt.default)(()=>this.handleTableChanges(u,s,d=>{o?.signal?.aborted||n({changedTables:d})}),l,{leading:!1,trailing:!0}),c=this.database.registerListener({tablesUpdated:async d=>{try{let{rawTableNames:h}=o;this.processTableUpdates(d,h,u),a()}catch(h){i?.(h)}}});return o.signal?.addEventListener("abort",()=>{c()}),()=>c()}onChangeWithAsyncGenerator(e){let t=e??{};return new Fe.EventIterator(n=>{let i=this.onChangeWithCallback({onChange:o=>{n.push(o)},onError:o=>{n.fail(o)}},e);return t.signal?.addEventListener("abort",()=>{n.stop()}),()=>i()})}handleTableChanges(e,t,n){if(e.size>0){let i=Array.from(e.values()).filter(o=>t.has(o));i.length&&n(i)}e.clear()}processTableUpdates(e,t,n){let i=Re(e)?e.tables:[e.table],o=t?i:i.filter(u=>!!u.match(Ne));if(!o.length)return;let s=t?o:o.map(u=>u.replace(Ne,""));for(let u of s)n.add(u)}async executeReadOnly(e,t){return await this.waitForReady(),this.database.readLock(n=>n.execute(e,t))}};var On=S(T());var Xt=S(T());var Me=1e3,ue=class r extends x{db;mutex;logger;static MAX_OP_ID="9223372036854775807";tableNames;pendingBucketDeletes;_hasCompletedSync;updateListener;compactCounter=Me;constructor(e,t,n=Xt.default.get("SqliteBucketStorage")){super(),this.db=e,this.mutex=t,this.logger=n,this._hasCompletedSync=!1,this.pendingBucketDeletes=!0,this.tableNames=new Set,this.updateListener=e.registerListener({tablesUpdated:i=>{At(i).includes(w.CRUD)&&this.iterateListeners(s=>s.crudUpdate?.())}})}async init(){this._hasCompletedSync=!1;let e=await this.db.execute("SELECT name FROM sqlite_master WHERE type='table' AND name GLOB 'ps_data_*'");for(let t of e.rows?._array??[])this.tableNames.add(t.name)}async dispose(){this.updateListener?.()}getMaxOpId(){return r.MAX_OP_ID}startSession(){}async getBucketStates(){return(await this.db.execute("SELECT name as bucket, cast(last_op as TEXT) as op_id FROM ps_buckets WHERE pending_delete = 0")).rows?._array??[]}async saveSyncData(e){await this.writeTransaction(async t=>{let n=0;for(let i of e.buckets){let o=await t.execute("INSERT INTO powersync_operations(op, data) VALUES(?, ?)",["save",JSON.stringify({buckets:[i.toJSON()]})]);this.logger.debug("saveSyncData",JSON.stringify(o)),n+=i.data.length}this.compactCounter+=n})}async removeBuckets(e){for(let t of e)await this.deleteBucket(t)}async deleteBucket(e){let t=`$delete_${e}_${H()}`;this.logger.debug("Deleting bucket",e),await this.writeTransaction(async n=>{await n.execute(`UPDATE ps_oplog SET op=${I.REMOVE}, data=NULL WHERE op=${I.PUT} AND superseded=0 AND bucket=?`,[e]),await n.execute("UPDATE ps_oplog SET bucket=? WHERE bucket=?",[t,e]),await n.execute("DELETE FROM ps_buckets WHERE name = ?",[e]),await n.execute("INSERT INTO ps_buckets(name, pending_delete, last_op) SELECT ?, 1, IFNULL(MAX(op_id), 0) FROM ps_oplog WHERE bucket = ?",[t,t])}),this.logger.debug("done deleting bucket"),this.pendingBucketDeletes=!0}async hasCompletedSync(){if(this._hasCompletedSync)return!0;let t=!!(await this.db.execute("SELECT name, last_applied_op FROM ps_buckets WHERE last_applied_op > 0 LIMIT 1")).rows?.length;return t&&(this._hasCompletedSync=!0),t}async syncLocalDatabase(e){let t=await this.validateChecksums(e);if(!t.checkpointValid){this.logger.error("Checksums failed for",t.checkpointFailures);for(let o of t.checkpointFailures??[])await this.deleteBucket(o);return{ready:!1,checkpointValid:!1,checkpointFailures:t.checkpointFailures}}let n=e.buckets.map(o=>o.bucket);return await this.writeTransaction(async o=>{await o.execute("UPDATE ps_buckets SET last_op = ? WHERE name IN (SELECT json_each.value FROM json_each(?))",[e.last_op_id,JSON.stringify(n)]),e.write_checkpoint&&await o.execute("UPDATE ps_buckets SET last_op = ? WHERE name = '$local'",[e.write_checkpoint])}),await this.updateObjectsFromBuckets(e)?(await this.forceCompact(),{ready:!0,checkpointValid:!0}):(this.logger.debug("Not at a consistent checkpoint - cannot update local db"),{ready:!1,checkpointValid:!0})}async updateObjectsFromBuckets(e){return this.writeTransaction(async t=>{let{insertId:n}=await t.execute("INSERT INTO powersync_operations(op, data) VALUES(?, ?)",["sync_local",""]);return n==1})}async validateChecksums(e){let n=(await this.db.execute("SELECT powersync_validate_checkpoint(?) as result",[JSON.stringify(e)])).rows?.item(0);if(this.logger.debug("validateChecksums result item",n),!n)return{checkpointValid:!1,ready:!1,checkpointFailures:[]};let i=JSON.parse(n.result);return i.valid?{ready:!0,checkpointValid:!0}:{checkpointValid:!1,ready:!1,checkpointFailures:i.failed_buckets}}async forceCompact(){this.compactCounter=Me,this.pendingBucketDeletes=!0,await this.autoCompact()}async autoCompact(){await this.deletePendingBuckets(),await this.clearRemoveOps()}async deletePendingBuckets(){this.pendingBucketDeletes!==!1&&(await this.writeTransaction(async e=>{await e.execute("DELETE FROM ps_oplog WHERE bucket IN (SELECT name FROM ps_buckets WHERE pending_delete = 1 AND last_applied_op = last_op AND last_op >= target_op)"),await e.execute("DELETE FROM ps_buckets WHERE pending_delete = 1 AND last_applied_op = last_op AND last_op >= target_op")}),this.pendingBucketDeletes=!1)}async clearRemoveOps(){this.compactCounter<Me||(await this.writeTransaction(async e=>{await e.execute("INSERT INTO powersync_operations(op, data) VALUES (?, ?)",["clear_remove_ops",""])}),this.compactCounter=0)}async updateLocalTarget(e){if(!(await this.db.execute("SELECT target_op FROM ps_buckets WHERE name = '$local' AND target_op = ?",[r.MAX_OP_ID])).rows?.length)return!1;let n=await this.db.execute("SELECT seq FROM sqlite_sequence WHERE name = 'ps_crud'");if(!n.rows?.length)return!1;let i=n.rows?.item(0).seq,o=await e();return this.logger.debug(`[updateLocalTarget] Updating target to checkpoint ${o}`),this.writeTransaction(async s=>{if((await s.execute("SELECT 1 FROM ps_crud LIMIT 1")).rows?.length)return this.logger.debug("updateLocalTarget","ps crud is not empty"),!1;let l=await s.execute("SELECT seq FROM sqlite_sequence WHERE name = 'ps_crud'");if(!l.rows?.length)throw new Error("SQlite Sequence should not be empty");let a=l.rows?.item(0).seq;if(this.logger.debug("seqAfter",JSON.stringify(l.rows?.item(0))),a!=i)return this.logger.debug("seqAfter != seqBefore",a,i),!1;let c=await s.execute("UPDATE ps_buckets SET target_op = ? WHERE name='$local'",[o]);return this.logger.debug(["[updateLocalTarget] Response from updating target_op ",JSON.stringify(c)]),!0})}async hasCrud(){return!!(await this.db.execute("SELECT 1 FROM ps_crud LIMIT 1")).rows?.length}async getCrudBatch(e=100){if(!await this.hasCrud())return null;let t=await this.db.execute("SELECT * FROM ps_crud ORDER BY id ASC LIMIT ?",[e]),n=[];for(let o of t.rows?._array??[])n.push(R.fromRow(o));if(n.length===0)return null;let i=n[n.length-1];return{crud:n,haveMore:!0,complete:async o=>this.writeTransaction(async s=>{await s.execute("DELETE FROM ps_crud WHERE id <= ?",[i.clientId]),o?(await s.execute("SELECT 1 FROM ps_crud LIMIT 1")).rows?.length&&await s.execute("UPDATE ps_buckets SET target_op = ? WHERE name='$local'",[o]):await s.execute("UPDATE ps_buckets SET target_op = ? WHERE name='$local'",[this.getMaxOpId()])})}}async writeTransaction(e,t){return this.db.writeTransaction(e,t)}async setTargetCheckpoint(e){}};var Kt=S(T()),Rn=3e4,Ln=Kt.default.get("PowerSyncRemote"),le=class{connector;logger;credentials=null;constructor(e,t=Ln){this.connector=e,this.logger=t}async getCredentials(){let{expiresAt:e}=this.credentials??{};return e&&e>new Date(new Date().valueOf()+Rn)?this.credentials:(this.credentials=await this.connector.fetchCredentials(),this.credentials)}async buildRequest(e){let t=await this.getCredentials();if(t!=null&&(t.endpoint==null||t.endpoint==""))throw new Error("PowerSync endpoint not configured");if(t?.token==null||t?.token==""){let n=new Error("Not signed in");throw n.status=401,n}return{url:t.endpoint+e,headers:{"content-type":"application/json",Authorization:`Token ${t.token}`}}}isAvailable(){return!0}};var D;(function(r){r.TEXT="TEXT",r.INTEGER="INTEGER",r.REAL="REAL"})(D||(D={}));var _s={type:D.TEXT},xs={type:D.INTEGER},Cs={type:D.REAL};var de=class extends ce{constructor(e){super(e)}get webOptions(){return this.options}obtainLock(e){let t=`streaming-sync-${e.type}-${this.webOptions.identifier}`;return e.type==W.SYNC&&console.debug("requesting lock for ",t),navigator.locks.request(t,{signal:e.signal},e.callback)}};var J=function(r,e,t,n){function i(o){return o instanceof t?o:new t(function(s){s(o)})}return new(t||(t=Promise))(function(o,s){function u(c){try{a(n.next(c))}catch(d){s(d)}}function l(c){try{a(n.throw(c))}catch(d){s(d)}}function a(c){c.done?o(c.value):i(c.value).then(u,l)}a((n=n.apply(r,e||[])).next())})},he=class extends le{post(e,t){return J(this,arguments,void 0,function*(n,i,o={}){let s=yield this.buildRequest(n),u=yield fetch(s.url,{method:"POST",headers:Object.assign(Object.assign({},o),s.headers),body:JSON.stringify(i)});if(!u.ok)throw new Error(`Received ${u.status} - ${u.statusText} when posting to ${n}: ${yield u.text()}}`);return u.json()})}get(e,t){return J(this,void 0,void 0,function*(){let n=yield this.buildRequest(e),i=yield fetch(n.url,{method:"GET",headers:Object.assign(Object.assign({},t),n.headers)});if(!i.ok)throw new Error(`Received ${i.status} - ${i.statusText} when getting from ${e}: ${yield i.text()}}`);return i.json()})}postStreaming(e,t){return J(this,arguments,void 0,function*(n,i,o={},s){let u=yield this.buildRequest(n),l=new AbortController,a=!1;s?.addEventListener("abort",()=>{var f;a||l.abort((f=s.reason)!==null&&f!==void 0?f:new C("Cancelling network request before it resolves. Abort signal has been received."))});let c=yield fetch(u.url,{method:"POST",headers:Object.assign(Object.assign({},o),u.headers),body:JSON.stringify(i),signal:l.signal,cache:"no-store"}).catch(f=>{throw f.name=="AbortError"?new C(`Pending fetch request to ${u.url} has been aborted.`):f});if(!c)throw new Error("Fetch request was aborted");if(a=!0,!c.ok||!c.body){let f=yield c.text();this.logger.error(`Could not POST streaming to ${n} - ${c.status} - ${c.statusText}: ${f}`);let m=new Error(`HTTP ${c.statusText}: ${f}`);throw m.status=c.status,m}let d=c.body.getReader(),h=()=>J(this,void 0,void 0,function*(){try{yield d.cancel()}catch{}d.releaseLock()});s?.addEventListener("abort",()=>{h()});let p=new ReadableStream({start:f=>{J(this,void 0,void 0,function*(){for(;!s?.aborted;)try{let{done:N,value:F}=yield d.read();if(N)break;f.enqueue(F)}catch(N){this.logger.error("Caught exception when reading sync stream",N);break}s?.aborted||(yield h()),f.close()})}});return new Response(p).body})}};var er=S(T());function In(r,e=!0){return e?new SharedWorker(new URL("./SharedWASQLiteDB.worker.js",import.meta.url),{name:`shared-DB-worker-${r}`,type:"module"}).port:new Worker(new URL("./WASQLiteDB.worker.js",import.meta.url),{name:`DB-worker-${r}`,type:"module"})}function Zt(r,e=!0){return A(In(r,e))}var v=function(r,e,t,n){function i(o){return o instanceof t?o:new t(function(s){s(o)})}return new(t||(t=Promise))(function(o,s){function u(c){try{a(n.next(c))}catch(d){s(d)}}function l(c){try{a(n.throw(c))}catch(d){s(d)}}function a(c){c.done?o(c.value):i(c.value).then(u,l)}a((n=n.apply(r,e||[])).next())})},pe=class extends x{constructor(e){super(),this.options=e,this._execute=(t,n)=>v(this,void 0,void 0,function*(){yield this.initialized;let i=yield this.workerMethods.execute(t,n);return Object.assign(Object.assign({},i),{rows:Object.assign(Object.assign({},i.rows),{item:o=>i.rows._array[o]})})}),this._executeBatch=(t,n)=>v(this,void 0,void 0,function*(){yield this.initialized;let i=yield this.workerMethods.executeBatch(t,n);return Object.assign(Object.assign({},i),{rows:void 0})}),this.logger=er.default.get("WASQLite"),this.dbGetHelpers=null,this.workerMethods=null,this.initialized=this.init(),this.dbGetHelpers=this.generateDBHelpers({execute:this._execute.bind(this)})}get name(){return this.options.dbFilename}get flags(){var e;return(e=this.options.flags)!==null&&e!==void 0?e:{}}getWorker(){}init(){return v(this,void 0,void 0,function*(){let{enableMultiTabs:e}=this.flags;e||this.logger.warn("Multiple tabs are not enabled in this browser");let t=this.options.workerPort?A(this.options.workerPort):Zt(this.options.dbFilename,e);this.workerMethods=yield t(this.options.dbFilename),this.workerMethods.registerOnTableChange(Se((n,i,o)=>{this.iterateListeners(s=>{var u;return(u=s.tablesUpdated)===null||u===void 0?void 0:u.call(s,{opType:n,table:i,rowId:o})})}))})}execute(e,t){return v(this,void 0,void 0,function*(){return this.writeLock(n=>n.execute(e,t))})}executeBatch(e,t){return v(this,void 0,void 0,function*(){return this.writeLock(n=>this._executeBatch(e,t))})}close(){var e,t;(t=(e=this.workerMethods)===null||e===void 0?void 0:e.close)===null||t===void 0||t.call(e)}getAll(e,t){return v(this,void 0,void 0,function*(){return yield this.initialized,this.dbGetHelpers.getAll(e,t)})}getOptional(e,t){return v(this,void 0,void 0,function*(){return yield this.initialized,this.dbGetHelpers.getOptional(e,t)})}get(e,t){return v(this,void 0,void 0,function*(){return yield this.initialized,this.dbGetHelpers.get(e,t)})}readLock(e,t){return v(this,void 0,void 0,function*(){return yield this.initialized,this.acquireLock(()=>v(this,void 0,void 0,function*(){return e(this.generateDBHelpers({execute:this._execute}))}))})}writeLock(e,t){return v(this,void 0,void 0,function*(){return yield this.initialized,this.acquireLock(()=>v(this,void 0,void 0,function*(){return e(this.generateDBHelpers({execute:this._execute}))}))})}acquireLock(e){return navigator.locks.request(`db-lock-${this.options.dbFilename}`,e)}readTransaction(e,t){return v(this,void 0,void 0,function*(){return this.readLock(this.wrapTransaction(e))})}writeTransaction(e,t){return this.writeLock(this.wrapTransaction(e))}wrapTransaction(e){return t=>v(this,void 0,void 0,function*(){yield this._execute("BEGIN TRANSACTION");let n=!1,i=()=>v(this,void 0,void 0,function*(){return n?{rowsAffected:0}:(n=!0,this._execute("COMMIT"))}),o=()=>(n=!0,this._execute("ROLLBACK"));try{let s=yield e(Object.assign(Object.assign({},t),{commit:i,rollback:o}));return n||(yield i()),s}catch(s){throw this.logger.debug("Caught ex in transaction",s),yield o(),s}})}generateDBHelpers(e){return Object.assign(Object.assign({},e),{getAll(t,n){return v(this,void 0,void 0,function*(){var i,o;return(o=(i=(yield e.execute(t,n)).rows)===null||i===void 0?void 0:i._array)!==null&&o!==void 0?o:[]})},getOptional(t,n){return v(this,void 0,void 0,function*(){var i,o;return(o=(i=(yield e.execute(t,n)).rows)===null||i===void 0?void 0:i.item(0))!==null&&o!==void 0?o:null})},get(t,n){return v(this,void 0,void 0,function*(){var i;let s=(i=(yield e.execute(t,n)).rows)===null||i===void 0?void 0:i.item(0);if(!s)throw new Error("Result set is empty");return s})}})}};var k=S(T()),Dn=function(r,e,t,n){function i(o){return o instanceof t?o:new t(function(s){s(o)})}return new(t||(t=Promise))(function(o,s){function u(c){try{a(n.next(c))}catch(d){s(d)}}function l(c){try{a(n.throw(c))}catch(d){s(d)}}function a(c){c.done?o(c.value):i(c.value).then(u,l)}a((n=n.apply(r,e||[])).next())})},fe=class{constructor(e){this.clients=e,this.TRACE=k.default.TRACE,this.DEBUG=k.default.DEBUG,this.INFO=k.default.INFO,this.TIME=k.default.TIME,this.WARN=k.default.WARN,this.ERROR=k.default.ERROR,this.OFF=k.default.OFF}trace(...e){console.trace(...e);let t=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.trace(...t))}debug(...e){console.debug(...e);let t=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.debug(...t))}info(...e){console.info(...e);let t=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.info(...t))}log(...e){console.log(...e);let t=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.log(...t))}warn(...e){console.warn(...e);let t=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.warn(...t))}error(...e){console.error(...e);let t=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.error(...t))}time(e){console.time(e),this.iterateClients(t=>t.clientProvider.time(e))}timeEnd(e){console.timeEnd(e),this.iterateClients(t=>t.clientProvider.timeEnd(e))}setLevel(e){}getLevel(){return k.default.INFO}enabledFor(e){return!0}iterateClients(e){return Dn(this,void 0,void 0,function*(){for(let t of this.clients)try{yield e(t)}catch(n){console.error("Caught exception when iterating client",n)}})}sanitizeArgs(e){return e.map(n=>{try{return structuredClone(n)}catch(i){return console.error(i),"Could not serialize log params. Check shared worker logs for more details."}})}};var _=function(r,e,t,n){function i(o){return o instanceof t?o:new t(function(s){s(o)})}return new(t||(t=Promise))(function(o,s){function u(c){try{a(n.next(c))}catch(d){s(d)}}function l(c){try{a(n.throw(c))}catch(d){s(d)}}function a(c){c.done?o(c.value):i(c.value).then(u,l)}a((n=n.apply(r,e||[])).next())})},me;(function(r){r.CLOSE_CLIENT="close-client"})(me||(me={}));var ge=class extends x{constructor(){super(),this.ports=[],this.isInitialized=new Promise(e=>{let t=this.registerListener({initialized:()=>{e(),t?.()}})}),this.syncStatus=new E({}),this.broadCastLogger=new fe(this.ports)}waitForStatus(e){return _(this,void 0,void 0,function*(){return yield this.waitForReady(),this.syncStreamClient.waitForStatus(e)})}get lastSyncedAt(){var e;return(e=this.syncStreamClient)===null||e===void 0?void 0:e.lastSyncedAt}get isConnected(){var e,t;return(t=(e=this.syncStreamClient)===null||e===void 0?void 0:e.isConnected)!==null&&t!==void 0?t:!1}waitForReady(){return _(this,void 0,void 0,function*(){return this.isInitialized})}init(e,t){return _(this,void 0,void 0,function*(){var n,i;if(this.syncStreamClient)return;let o=!((i=(n=t.streamOptions)===null||n===void 0?void 0:n.flags)===null||i===void 0)&&i.broadcastLogs?this.broadCastLogger:tr.default.get("shared-sync");self.onerror=s=>{o.error("Uncaught exception in PowerSync shared sync worker",s)},this.syncStreamClient=new de(Object.assign(Object.assign({adapter:new ue(new pe({dbFilename:t.dbName,workerPort:e,flags:{enableMultiTabs:!0},logger:o}),new P,o),remote:new he({fetchCredentials:()=>_(this,void 0,void 0,function*(){let s=this.ports[this.ports.length-1];return new Promise((u,l)=>_(this,void 0,void 0,function*(){let a=new AbortController;this.fetchCredentialsController={controller:a,activePort:s},a.signal.onabort=l;try{u(yield s.clientProvider.fetchCredentials())}catch(c){l(c)}finally{this.fetchCredentialsController=void 0}}))})}),uploadCrud:()=>_(this,void 0,void 0,function*(){let s=this.ports[this.ports.length-1];return new Promise((u,l)=>_(this,void 0,void 0,function*(){let a=new AbortController;this.uploadDataController={controller:a,activePort:s},a.signal.onabort=()=>u();try{u(yield s.clientProvider.uploadCrud())}catch(c){l(c)}finally{this.uploadDataController=void 0}}))})},t.streamOptions),{logger:o})),this.syncStreamClient.registerListener({statusChanged:s=>{this.updateAllStatuses(s.toJSON())}}),this.iterateListeners(s=>{var u;return(u=s.initialized)===null||u===void 0?void 0:u.call(s)})})}dispose(){return _(this,void 0,void 0,function*(){var e,t;return yield this.waitForReady(),(e=this.statusListener)===null||e===void 0||e.call(this),(t=this.syncStreamClient)===null||t===void 0?void 0:t.dispose()})}connect(){return _(this,void 0,void 0,function*(){return yield this.waitForReady(),navigator.locks.request("shared-sync-connect",()=>{var e;return(e=this.syncStreamClient)===null||e===void 0?void 0:e.connect()})})}disconnect(){return _(this,void 0,void 0,function*(){return yield this.waitForReady(),navigator.locks.request("shared-sync-connect",()=>{var e;return(e=this.syncStreamClient)===null||e===void 0?void 0:e.disconnect()})})}addPort(e){var t;let n={port:e,clientProvider:A(e)};this.ports.push(n);let i=(t=this.syncStreamClient)===null||t===void 0?void 0:t.syncStatus;i&&n.clientProvider.statusChanged(i.toJSON())}removePort(e){let t=this.ports.findIndex(i=>i.port==e);if(t<0){console.warn(`Could not remove port ${e} since it is not present in active ports.`);return}this.ports[t].clientProvider[be](),this.ports.splice(t,1),[this.fetchCredentialsController,this.uploadDataController].forEach(i=>{i?.activePort.port==e&&i.controller.abort(new C("Closing pending requests after client port is removed"))})}triggerCrudUpload(){this.waitForReady().then(()=>{var e;return(e=this.syncStreamClient)===null||e===void 0?void 0:e.triggerCrudUpload()})}obtainLock(e){return _(this,void 0,void 0,function*(){return yield this.waitForReady(),this.syncStreamClient.obtainLock(e)})}hasCompletedSync(){return _(this,void 0,void 0,function*(){return yield this.waitForReady(),this.syncStreamClient.hasCompletedSync()})}getWriteCheckpoint(){return _(this,void 0,void 0,function*(){return yield this.waitForReady(),this.syncStreamClient.getWriteCheckpoint()})}updateAllStatuses(e){this.syncStatus=new E(e),this.ports.forEach(t=>t.clientProvider.statusChanged(e))}_testUpdateAllStatuses(e){this.syncStreamClient||console.warn("no stream client has been initialized yet"),this.syncStreamClient.syncStatus=new E(e),this.updateAllStatuses(e)}};var rr=S(T()),Nn=self;rr.default.useDefaults();var Pe=new ge;Nn.onconnect=function(r){let e=r.ports[0];e.addEventListener("message",t=>{let n=t.data;n?.event==me.CLOSE_CLIENT&&(console.log("closing shared for port",e),Pe.removePort(e))}),K(Pe,e),Pe.addPort(e)};
