var Ka=Object.create;var Fi=Object.defineProperty;var Za=Object.getOwnPropertyDescriptor;var el=Object.getOwnPropertyNames;var tl=Object.getPrototypeOf,rl=Object.prototype.hasOwnProperty;var P=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var nl=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of el(e))!rl.call(t,i)&&i!==r&&Fi(t,i,{get:()=>e[i],enumerable:!(n=Za(e,i))||n.enumerable});return t};var Y=(t,e,r)=>(r=t!=null?Ka(tl(t)):{},nl(e||!t||!t.__esModule?Fi(r,"default",{value:t,enumerable:!0}):r,t));var _e=P((ki,wr)=>{(function(t){"use strict";var e={};e.VERSION="1.6.1";var r,n={},i=function(a,c){return function(){return c.apply(a,arguments)}},s=function(){var a=arguments,c=a[0],h,d;for(d=1;d<a.length;d++)for(h in a[d])!(h in c)&&a[d].hasOwnProperty(h)&&(c[h]=a[d][h]);return c},o=function(a,c){return{value:a,name:c}};e.TRACE=o(1,"TRACE"),e.DEBUG=o(2,"DEBUG"),e.INFO=o(3,"INFO"),e.TIME=o(4,"TIME"),e.WARN=o(5,"WARN"),e.ERROR=o(8,"ERROR"),e.OFF=o(99,"OFF");var u=function(a){this.context=a,this.setLevel(a.filterLevel),this.log=this.info};u.prototype={setLevel:function(a){a&&"value"in a&&(this.context.filterLevel=a)},getLevel:function(){return this.context.filterLevel},enabledFor:function(a){var c=this.context.filterLevel;return a.value>=c.value},trace:function(){this.invoke(e.TRACE,arguments)},debug:function(){this.invoke(e.DEBUG,arguments)},info:function(){this.invoke(e.INFO,arguments)},warn:function(){this.invoke(e.WARN,arguments)},error:function(){this.invoke(e.ERROR,arguments)},time:function(a){typeof a=="string"&&a.length>0&&this.invoke(e.TIME,[a,"start"])},timeEnd:function(a){typeof a=="string"&&a.length>0&&this.invoke(e.TIME,[a,"end"])},invoke:function(a,c){r&&this.enabledFor(a)&&r(c,s({level:a},this.context))}};var l=new u({filterLevel:e.OFF});(function(){var a=e;a.enabledFor=i(l,l.enabledFor),a.trace=i(l,l.trace),a.debug=i(l,l.debug),a.time=i(l,l.time),a.timeEnd=i(l,l.timeEnd),a.info=i(l,l.info),a.warn=i(l,l.warn),a.error=i(l,l.error),a.log=a.info})(),e.setHandler=function(a){r=a},e.setLevel=function(a){l.setLevel(a);for(var c in n)n.hasOwnProperty(c)&&n[c].setLevel(a)},e.getLevel=function(){return l.getLevel()},e.get=function(a){return n[a]||(n[a]=new u(s({name:a},l.context)))},e.createDefaultHandler=function(a){a=a||{},a.formatter=a.formatter||function(p,m){m.name&&p.unshift("["+m.name+"]")};var c={},h=function(d,p){Function.prototype.apply.call(d,console,p)};return typeof console>"u"?function(){}:function(d,p){d=Array.prototype.slice.call(d);var m=console.log,w;p.level===e.TIME?(w=(p.name?"["+p.name+"] ":"")+d[0],d[1]==="start"?console.time?console.time(w):c[w]=new Date().getTime():console.timeEnd?console.timeEnd(w):h(m,[w+": "+(new Date().getTime()-c[w])+"ms"])):(p.level===e.WARN&&console.warn?m=console.warn:p.level===e.ERROR&&console.error?m=console.error:p.level===e.INFO&&console.info?m=console.info:p.level===e.DEBUG&&console.debug?m=console.debug:p.level===e.TRACE&&console.trace&&(m=console.trace),a.formatter(d,p),h(m,d))}},e.useDefaults=function(a){e.setLevel(a&&a.defaultLevel||e.DEBUG),e.setHandler(e.createDefaultHandler(a))},e.setDefaults=e.useDefaults,typeof define=="function"&&define.amd?define(e):typeof wr<"u"&&wr.exports?wr.exports=e:(e._prevLogger=t.Logger,e.noConflict=function(){return t.Logger=e._prevLogger,e},t.Logger=e)})(ki)});var Pi=P(br=>{"use strict";Object.defineProperty(br,"__esModule",{value:!0});var En=class{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(e){if(this.isStopped)return;let r={value:e,done:!1};if(this.pullQueue.length){let n=this.pullQueue.shift();n&&n.resolve(r)}else this.pushQueue.push(Promise.resolve(r)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(let e of this.pullQueue)e.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(e){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(let r of this.pullQueue)r.reject(e);this.pullQueue.length=0}else{let r=Promise.reject(e);r.catch(()=>{}),this.pushQueue.push(r)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:e=>{let r=this.pushQueue.shift();return r?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),r):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((n,i)=>{this.pullQueue.push({resolve:n,reject:i})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}},Sr=class{constructor(e,{highWaterMark:r=100,lowWaterMark:n=1}={}){let i=new En;i.highWaterMark=r,i.lowWaterMark=n,i.removeCallback=e({push:s=>i.push(s),stop:()=>i.stop(),fail:s=>i.fail(s),on:(s,o)=>{i.eventHandlers[s]=o}})||(()=>{}),this[Symbol.asyncIterator]=()=>i[Symbol.asyncIterator](),Object.freeze(this)}};br.EventIterator=Sr;br.default=Sr});var qi=P(qt=>{"use strict";Object.defineProperty(qt,"__esModule",{value:!0});var wn=Pi();qt.EventIterator=wn.EventIterator;function yl(t,e,r){return new wn.EventIterator(({push:n})=>(this.addEventListener(t,n,e),()=>this.removeEventListener(t,n,e)),r)}qt.subscribe=yl;qt.default=wn.EventIterator});var Tr=P((Yf,$i)=>{function El(t){var e=typeof t;return t!=null&&(e=="object"||e=="function")}$i.exports=El});var zi=P((Xf,ji)=>{var wl=typeof global=="object"&&global&&global.Object===Object&&global;ji.exports=wl});var Sn=P((Kf,Hi)=>{var Sl=zi(),bl=typeof self=="object"&&self&&self.Object===Object&&self,Tl=Sl||bl||Function("return this")();Hi.exports=Tl});var Vi=P((Zf,Wi)=>{var Rl=Sn(),_l=function(){return Rl.Date.now()};Wi.exports=_l});var Qi=P((ed,Ji)=>{var vl=/\s/;function Ol(t){for(var e=t.length;e--&&vl.test(t.charAt(e)););return e}Ji.exports=Ol});var Yi=P((td,Gi)=>{var Nl=Qi(),Al=/^\s+/;function Il(t){return t&&t.slice(0,Nl(t)+1).replace(Al,"")}Gi.exports=Il});var bn=P((rd,Xi)=>{var Fl=Sn(),xl=Fl.Symbol;Xi.exports=xl});var ts=P((nd,es)=>{var Ki=bn(),Zi=Object.prototype,Ll=Zi.hasOwnProperty,Bl=Zi.toString,$t=Ki?Ki.toStringTag:void 0;function Cl(t){var e=Ll.call(t,$t),r=t[$t];try{t[$t]=void 0;var n=!0}catch{}var i=Bl.call(t);return n&&(e?t[$t]=r:delete t[$t]),i}es.exports=Cl});var ns=P((id,rs)=>{var Dl=Object.prototype,Ul=Dl.toString;function Ml(t){return Ul.call(t)}rs.exports=Ml});var as=P((sd,os)=>{var is=bn(),kl=ts(),Pl=ns(),ql="[object Null]",$l="[object Undefined]",ss=is?is.toStringTag:void 0;function jl(t){return t==null?t===void 0?$l:ql:ss&&ss in Object(t)?kl(t):Pl(t)}os.exports=jl});var us=P((od,ls)=>{function zl(t){return t!=null&&typeof t=="object"}ls.exports=zl});var hs=P((ad,cs)=>{var Hl=as(),Wl=us(),Vl="[object Symbol]";function Jl(t){return typeof t=="symbol"||Wl(t)&&Hl(t)==Vl}cs.exports=Jl});var ms=P((ld,ps)=>{var Ql=Yi(),fs=Tr(),Gl=hs(),ds=NaN,Yl=/^[-+]0x[0-9a-f]+$/i,Xl=/^0b[01]+$/i,Kl=/^0o[0-7]+$/i,Zl=parseInt;function eu(t){if(typeof t=="number")return t;if(Gl(t))return ds;if(fs(t)){var e=typeof t.valueOf=="function"?t.valueOf():t;t=fs(e)?e+"":e}if(typeof t!="string")return t===0?t:+t;t=Ql(t);var r=Xl.test(t);return r||Kl.test(t)?Zl(t.slice(2),r?2:8):Yl.test(t)?ds:+t}ps.exports=eu});var Es=P((ud,ys)=>{var tu=Tr(),Tn=Vi(),gs=ms(),ru="Expected a function",nu=Math.max,iu=Math.min;function su(t,e,r){var n,i,s,o,u,l,a=0,c=!1,h=!1,d=!0;if(typeof t!="function")throw new TypeError(ru);e=gs(e)||0,tu(r)&&(c=!!r.leading,h="maxWait"in r,s=h?nu(gs(r.maxWait)||0,e):s,d="trailing"in r?!!r.trailing:d);function p(N){var v=n,$=i;return n=i=void 0,a=N,o=t.apply($,v),o}function m(N){return a=N,u=setTimeout(A,e),c?p(N):o}function w(N){var v=N-l,$=N-a,U=e-v;return h?iu(U,s-$):U}function F(N){var v=N-l,$=N-a;return l===void 0||v>=e||v<0||h&&$>=s}function A(){var N=Tn();if(F(N))return O(N);u=setTimeout(A,w(N))}function O(N){return u=void 0,d&&n?p(N):(n=i=void 0,o)}function V(){u!==void 0&&clearTimeout(u),a=0,n=l=i=u=void 0}function _(){return u===void 0?o:O(Tn())}function B(){var N=Tn(),v=F(N);if(n=arguments,i=this,l=N,v){if(u===void 0)return m(l);if(h)return clearTimeout(u),u=setTimeout(A,e),p(l)}return u===void 0&&(u=setTimeout(A,e)),o}return B.cancel=V,B.flush=_,B}ys.exports=su});var Rn=P((cd,ws)=>{var ou=Es(),au=Tr(),lu="Expected a function";function uu(t,e,r){var n=!0,i=!0;if(typeof t!="function")throw new TypeError(lu);return au(r)&&(n="leading"in r?!!r.leading:n,i="trailing"in r?!!r.trailing:i),ou(t,e,{leading:n,maxWait:e,trailing:i})}ws.exports=uu});var Ms=P((je,Us)=>{var Ir=typeof globalThis<"u"&&globalThis||typeof self<"u"&&self||typeof global<"u"&&global,Fr=function(){function t(){this.fetch=!1,this.DOMException=Ir.DOMException}return t.prototype=Ir,new t}();(function(t){var e=function(r){var n=typeof t<"u"&&t||typeof self<"u"&&self||typeof n<"u"&&n,i={searchParams:"URLSearchParams"in n,iterable:"Symbol"in n&&"iterator"in Symbol,blob:"FileReader"in n&&"Blob"in n&&function(){try{return new Blob,!0}catch{return!1}}(),formData:"FormData"in n,arrayBuffer:"ArrayBuffer"in n};function s(f){return f&&DataView.prototype.isPrototypeOf(f)}if(i.arrayBuffer)var o=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],u=ArrayBuffer.isView||function(f){return f&&o.indexOf(Object.prototype.toString.call(f))>-1};function l(f){if(typeof f!="string"&&(f=String(f)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(f)||f==="")throw new TypeError('Invalid character in header field name: "'+f+'"');return f.toLowerCase()}function a(f){return typeof f!="string"&&(f=String(f)),f}function c(f){var g={next:function(){var b=f.shift();return{done:b===void 0,value:b}}};return i.iterable&&(g[Symbol.iterator]=function(){return g}),g}function h(f){this.map={},f instanceof h?f.forEach(function(g,b){this.append(b,g)},this):Array.isArray(f)?f.forEach(function(g){this.append(g[0],g[1])},this):f&&Object.getOwnPropertyNames(f).forEach(function(g){this.append(g,f[g])},this)}h.prototype.append=function(f,g){f=l(f),g=a(g);var b=this.map[f];this.map[f]=b?b+", "+g:g},h.prototype.delete=function(f){delete this.map[l(f)]},h.prototype.get=function(f){return f=l(f),this.has(f)?this.map[f]:null},h.prototype.has=function(f){return this.map.hasOwnProperty(l(f))},h.prototype.set=function(f,g){this.map[l(f)]=a(g)},h.prototype.forEach=function(f,g){for(var b in this.map)this.map.hasOwnProperty(b)&&f.call(g,this.map[b],b,this)},h.prototype.keys=function(){var f=[];return this.forEach(function(g,b){f.push(b)}),c(f)},h.prototype.values=function(){var f=[];return this.forEach(function(g){f.push(g)}),c(f)},h.prototype.entries=function(){var f=[];return this.forEach(function(g,b){f.push([b,g])}),c(f)},i.iterable&&(h.prototype[Symbol.iterator]=h.prototype.entries);function d(f){if(f.bodyUsed)return Promise.reject(new TypeError("Already read"));f.bodyUsed=!0}function p(f){return new Promise(function(g,b){f.onload=function(){g(f.result)},f.onerror=function(){b(f.error)}})}function m(f){var g=new FileReader,b=p(g);return g.readAsArrayBuffer(f),b}function w(f){var g=new FileReader,b=p(g);return g.readAsText(f),b}function F(f){for(var g=new Uint8Array(f),b=new Array(g.length),k=0;k<g.length;k++)b[k]=String.fromCharCode(g[k]);return b.join("")}function A(f){if(f.slice)return f.slice(0);var g=new Uint8Array(f.byteLength);return g.set(new Uint8Array(f)),g.buffer}function O(){return this.bodyUsed=!1,this._initBody=function(f){this.bodyUsed=this.bodyUsed,this._bodyInit=f,f?typeof f=="string"?this._bodyText=f:i.blob&&Blob.prototype.isPrototypeOf(f)?this._bodyBlob=f:i.formData&&FormData.prototype.isPrototypeOf(f)?this._bodyFormData=f:i.searchParams&&URLSearchParams.prototype.isPrototypeOf(f)?this._bodyText=f.toString():i.arrayBuffer&&i.blob&&s(f)?(this._bodyArrayBuffer=A(f.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):i.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(f)||u(f))?this._bodyArrayBuffer=A(f):this._bodyText=f=Object.prototype.toString.call(f):this._bodyText="",this.headers.get("content-type")||(typeof f=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):i.searchParams&&URLSearchParams.prototype.isPrototypeOf(f)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},i.blob&&(this.blob=function(){var f=d(this);if(f)return f;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){if(this._bodyArrayBuffer){var f=d(this);return f||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}else return this.blob().then(m)}),this.text=function(){var f=d(this);if(f)return f;if(this._bodyBlob)return w(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(F(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},i.formData&&(this.formData=function(){return this.text().then(N)}),this.json=function(){return this.text().then(JSON.parse)},this}var V=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function _(f){var g=f.toUpperCase();return V.indexOf(g)>-1?g:f}function B(f,g){if(!(this instanceof B))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');g=g||{};var b=g.body;if(f instanceof B){if(f.bodyUsed)throw new TypeError("Already read");this.url=f.url,this.credentials=f.credentials,g.headers||(this.headers=new h(f.headers)),this.method=f.method,this.mode=f.mode,this.signal=f.signal,!b&&f._bodyInit!=null&&(b=f._bodyInit,f.bodyUsed=!0)}else this.url=String(f);if(this.credentials=g.credentials||this.credentials||"same-origin",(g.headers||!this.headers)&&(this.headers=new h(g.headers)),this.method=_(g.method||this.method||"GET"),this.mode=g.mode||this.mode||null,this.signal=g.signal||this.signal,this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&b)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(b),(this.method==="GET"||this.method==="HEAD")&&(g.cache==="no-store"||g.cache==="no-cache")){var k=/([?&])_=[^&]*/;if(k.test(this.url))this.url=this.url.replace(k,"$1_="+new Date().getTime());else{var H=/\?/;this.url+=(H.test(this.url)?"&":"?")+"_="+new Date().getTime()}}}B.prototype.clone=function(){return new B(this,{body:this._bodyInit})};function N(f){var g=new FormData;return f.trim().split("&").forEach(function(b){if(b){var k=b.split("="),H=k.shift().replace(/\+/g," "),z=k.join("=").replace(/\+/g," ");g.append(decodeURIComponent(H),decodeURIComponent(z))}}),g}function v(f){var g=new h,b=f.replace(/\r?\n[\t ]+/g," ");return b.split("\r").map(function(k){return k.indexOf(`
`)===0?k.substr(1,k.length):k}).forEach(function(k){var H=k.split(":"),z=H.shift().trim();if(z){var ht=H.join(":").trim();g.append(z,ht)}}),g}O.call(B.prototype);function $(f,g){if(!(this instanceof $))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');g||(g={}),this.type="default",this.status=g.status===void 0?200:g.status,this.ok=this.status>=200&&this.status<300,this.statusText=g.statusText===void 0?"":""+g.statusText,this.headers=new h(g.headers),this.url=g.url||"",this._initBody(f)}O.call($.prototype),$.prototype.clone=function(){return new $(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new h(this.headers),url:this.url})},$.error=function(){var f=new $(null,{status:0,statusText:""});return f.type="error",f};var U=[301,302,303,307,308];$.redirect=function(f,g){if(U.indexOf(g)===-1)throw new RangeError("Invalid status code");return new $(null,{status:g,headers:{location:f}})},r.DOMException=n.DOMException;try{new r.DOMException}catch{r.DOMException=function(g,b){this.message=g,this.name=b;var k=Error(g);this.stack=k.stack},r.DOMException.prototype=Object.create(Error.prototype),r.DOMException.prototype.constructor=r.DOMException}function I(f,g){return new Promise(function(b,k){var H=new B(f,g);if(H.signal&&H.signal.aborted)return k(new r.DOMException("Aborted","AbortError"));var z=new XMLHttpRequest;function ht(){z.abort()}z.onload=function(){var ne={status:z.status,statusText:z.statusText,headers:v(z.getAllResponseHeaders()||"")};ne.url="responseURL"in z?z.responseURL:ne.headers.get("X-Request-URL");var qe="response"in z?z.response:z.responseText;setTimeout(function(){b(new $(qe,ne))},0)},z.onerror=function(){setTimeout(function(){k(new TypeError("Network request failed"))},0)},z.ontimeout=function(){setTimeout(function(){k(new TypeError("Network request failed"))},0)},z.onabort=function(){setTimeout(function(){k(new r.DOMException("Aborted","AbortError"))},0)};function hr(ne){try{return ne===""&&n.location.href?n.location.href:ne}catch{return ne}}z.open(H.method,hr(H.url),!0),H.credentials==="include"?z.withCredentials=!0:H.credentials==="omit"&&(z.withCredentials=!1),"responseType"in z&&(i.blob?z.responseType="blob":i.arrayBuffer&&H.headers.get("Content-Type")&&H.headers.get("Content-Type").indexOf("application/octet-stream")!==-1&&(z.responseType="arraybuffer")),g&&typeof g.headers=="object"&&!(g.headers instanceof h)?Object.getOwnPropertyNames(g.headers).forEach(function(ne){z.setRequestHeader(ne,a(g.headers[ne]))}):H.headers.forEach(function(ne,qe){z.setRequestHeader(qe,ne)}),H.signal&&(H.signal.addEventListener("abort",ht),z.onreadystatechange=function(){z.readyState===4&&H.signal.removeEventListener("abort",ht)}),z.send(typeof H._bodyInit>"u"?null:H._bodyInit)})}return I.polyfill=!0,n.fetch||(n.fetch=I,n.Headers=h,n.Request=B,n.Response=$),r.Headers=h,r.Request=B,r.Response=$,r.fetch=I,r}({})})(Fr);Fr.fetch.ponyfill=!0;delete Fr.fetch.polyfill;var gt=Ir.fetch?Ir:Fr;je=gt.fetch;je.default=gt.fetch;je.fetch=gt.fetch;je.Headers=gt.Headers;je.Request=gt.Request;je.Response=gt.Response;Us.exports=je});var $s=P((sp,qs)=>{qs.exports={}});var zs=P((op,js)=>{"use strict";var yu=$s(),Eu=function(t){var e,r=!1;return new ReadableStream({start:function(n){var i=t.getReader();e=i;var s=new TextDecoder,o="";i.read().then(function u(l){if(l.done){if(r)return;if(o=o.trim(),o.length!==0)try{var a=JSON.parse(o);n.enqueue(a)}catch(w){n.error(w);return}n.close();return}var c=s.decode(l.value,{stream:!0});o+=c;for(var h=o.split(`
`),d=0;d<h.length-1;++d){var p=h[d].trim();if(p.length>0)try{var m=JSON.parse(p);n.enqueue(m)}catch(w){n.error(w),r=!0,i.cancel();return}}return o=h[h.length-1],i.read().then(u)})},cancel:function(n){console.log("Cancel registered due to ",n),r=!0,e.cancel()}})};js.exports=yu.ndjsonStream=Eu});var be=P(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});re.Frame=re.Lengths=re.Flags=re.FrameTypes=void 0;var Fn;(function(t){t[t.RESERVED=0]="RESERVED",t[t.SETUP=1]="SETUP",t[t.LEASE=2]="LEASE",t[t.KEEPALIVE=3]="KEEPALIVE",t[t.REQUEST_RESPONSE=4]="REQUEST_RESPONSE",t[t.REQUEST_FNF=5]="REQUEST_FNF",t[t.REQUEST_STREAM=6]="REQUEST_STREAM",t[t.REQUEST_CHANNEL=7]="REQUEST_CHANNEL",t[t.REQUEST_N=8]="REQUEST_N",t[t.CANCEL=9]="CANCEL",t[t.PAYLOAD=10]="PAYLOAD",t[t.ERROR=11]="ERROR",t[t.METADATA_PUSH=12]="METADATA_PUSH",t[t.RESUME=13]="RESUME",t[t.RESUME_OK=14]="RESUME_OK",t[t.EXT=63]="EXT"})(Fn=re.FrameTypes||(re.FrameTypes={}));var Hs;(function(t){t[t.NONE=0]="NONE",t[t.COMPLETE=64]="COMPLETE",t[t.FOLLOWS=128]="FOLLOWS",t[t.IGNORE=512]="IGNORE",t[t.LEASE=64]="LEASE",t[t.METADATA=256]="METADATA",t[t.NEXT=32]="NEXT",t[t.RESPOND=128]="RESPOND",t[t.RESUME_ENABLE=128]="RESUME_ENABLE"})(Hs=re.Flags||(re.Flags={}));(function(t){function e(a){return(a&t.METADATA)===t.METADATA}t.hasMetadata=e;function r(a){return(a&t.COMPLETE)===t.COMPLETE}t.hasComplete=r;function n(a){return(a&t.NEXT)===t.NEXT}t.hasNext=n;function i(a){return(a&t.FOLLOWS)===t.FOLLOWS}t.hasFollows=i;function s(a){return(a&t.IGNORE)===t.IGNORE}t.hasIgnore=s;function o(a){return(a&t.RESPOND)===t.RESPOND}t.hasRespond=o;function u(a){return(a&t.LEASE)===t.LEASE}t.hasLease=u;function l(a){return(a&t.RESUME_ENABLE)===t.RESUME_ENABLE}t.hasResume=l})(Hs=re.Flags||(re.Flags={}));var wu;(function(t){t[t.FRAME=3]="FRAME",t[t.HEADER=6]="HEADER",t[t.METADATA=3]="METADATA",t[t.REQUEST=3]="REQUEST"})(wu=re.Lengths||(re.Lengths={}));var Su;(function(t){function e(n){return n.streamId===0}t.isConnection=e;function r(n){return Fn.REQUEST_RESPONSE<=n.type&&n.type<=Fn.REQUEST_CHANNEL}t.isRequest=r})(Su=re.Frame||(re.Frame={}))});var Ln=P(L=>{"use strict";var bu=L&&L.__generator||function(t,e){var r={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,o;return o={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function u(a){return function(c){return l([a,c])}}function l(a){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(s=a[0]&2?i.return:a[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,a[1])).done)return s;switch(i=0,s&&(a=[a[0]&2,s.value]),a[0]){case 0:case 1:s=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,i=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(s=r.trys,!(s=s.length>0&&s[s.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!s||a[1]>s[0]&&a[1]<s[3])){r.label=a[1];break}if(a[0]===6&&r.label<s[1]){r.label=s[1],s=a;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(a);break}s[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(c){a=[6,c],i=0}finally{n=s=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};Object.defineProperty(L,"__esModule",{value:!0});L.Deserializer=L.sizeOfFrame=L.serializeFrame=L.deserializeFrame=L.serializeFrameWithLength=L.deserializeFrames=L.deserializeFrameWithLength=L.writeUInt64BE=L.readUInt64BE=L.writeUInt24BE=L.readUInt24BE=L.MAX_VERSION=L.MAX_TTL=L.MAX_STREAM_ID=L.MAX_RESUME_LENGTH=L.MAX_REQUEST_N=L.MAX_REQUEST_COUNT=L.MAX_MIME_LENGTH=L.MAX_METADATA_LENGTH=L.MAX_LIFETIME=L.MAX_KEEPALIVE=L.MAX_CODE=L.FRAME_TYPE_OFFFSET=L.FLAGS_MASK=void 0;var x=be();L.FLAGS_MASK=1023;L.FRAME_TYPE_OFFFSET=10;L.MAX_CODE=2147483647;L.MAX_KEEPALIVE=2147483647;L.MAX_LIFETIME=2147483647;L.MAX_METADATA_LENGTH=16777215;L.MAX_MIME_LENGTH=255;L.MAX_REQUEST_COUNT=2147483647;L.MAX_REQUEST_N=2147483647;L.MAX_RESUME_LENGTH=65535;L.MAX_STREAM_ID=2147483647;L.MAX_TTL=2147483647;L.MAX_VERSION=65535;var xn=4294967296;function Lr(t,e){var r=t.readUInt8(e)<<16,n=t.readUInt8(e+1)<<8,i=t.readUInt8(e+2);return r|n|i}L.readUInt24BE=Lr;function xr(t,e,r){return r=t.writeUInt8(e>>>16,r),r=t.writeUInt8(e>>>8&255,r),t.writeUInt8(e&255,r)}L.writeUInt24BE=xr;function Wt(t,e){var r=t.readUInt32BE(e),n=t.readUInt32BE(e+4);return r*xn+n}L.readUInt64BE=Wt;function Vt(t,e,r){var n=e/xn|0,i=e%xn;return r=t.writeUInt32BE(n,r),t.writeUInt32BE(i,r)}L.writeUInt64BE=Vt;var j=6,ze=3;function Ws(t){var e=Lr(t,0);return Br(t.slice(ze,ze+e))}L.deserializeFrameWithLength=Ws;function Vs(t){var e,r,n,i,s,o;return bu(this,function(u){switch(u.label){case 0:e=0,u.label=1;case 1:return e+ze<t.length?(r=Lr(t,e),n=e+ze,i=n+r,i>t.length?[3,3]:(s=t.slice(n,i),o=Br(s),e=i,[4,[o,e]])):[3,3];case 2:return u.sent(),[3,1];case 3:return[2]}})}L.deserializeFrames=Vs;function Tu(t){var e=Js(t),r=Buffer.allocUnsafe(e.length+ze);return xr(r,e.length,0),e.copy(r,ze),r}L.serializeFrameWithLength=Tu;function Br(t){var e=0,r=t.readInt32BE(e);e+=4;var n=t.readUInt16BE(e);e+=2;var i=n>>>L.FRAME_TYPE_OFFFSET,s=n&L.FLAGS_MASK;switch(i){case x.FrameTypes.SETUP:return Ou(t,r,s);case x.FrameTypes.PAYLOAD:return tc(t,r,s);case x.FrameTypes.ERROR:return Iu(t,r,s);case x.FrameTypes.KEEPALIVE:return Lu(t,r,s);case x.FrameTypes.REQUEST_FNF:return qu(t,r,s);case x.FrameTypes.REQUEST_RESPONSE:return $u(t,r,s);case x.FrameTypes.REQUEST_STREAM:return Wu(t,r,s);case x.FrameTypes.REQUEST_CHANNEL:return Vu(t,r,s);case x.FrameTypes.METADATA_PUSH:return ju(t,r,s);case x.FrameTypes.REQUEST_N:return Gu(t,r,s);case x.FrameTypes.RESUME:return ic(t,r,s);case x.FrameTypes.RESUME_OK:return ac(t,r,s);case x.FrameTypes.CANCEL:return Ku(t,r,s);case x.FrameTypes.LEASE:return Du(t,r,s);default:}}L.deserializeFrame=Br;function Js(t){switch(t.type){case x.FrameTypes.SETUP:return _u(t);case x.FrameTypes.PAYLOAD:return Zu(t);case x.FrameTypes.ERROR:return Nu(t);case x.FrameTypes.KEEPALIVE:return Fu(t);case x.FrameTypes.REQUEST_FNF:case x.FrameTypes.REQUEST_RESPONSE:return Uu(t);case x.FrameTypes.REQUEST_STREAM:case x.FrameTypes.REQUEST_CHANNEL:return zu(t);case x.FrameTypes.METADATA_PUSH:return ku(t);case x.FrameTypes.REQUEST_N:return Ju(t);case x.FrameTypes.RESUME:return rc(t);case x.FrameTypes.RESUME_OK:return sc(t);case x.FrameTypes.CANCEL:return Yu(t);case x.FrameTypes.LEASE:return Bu(t);default:}}L.serializeFrame=Js;function Ru(t){switch(t.type){case x.FrameTypes.SETUP:return vu(t);case x.FrameTypes.PAYLOAD:return ec(t);case x.FrameTypes.ERROR:return Au(t);case x.FrameTypes.KEEPALIVE:return xu(t);case x.FrameTypes.REQUEST_FNF:case x.FrameTypes.REQUEST_RESPONSE:return Mu(t);case x.FrameTypes.REQUEST_STREAM:case x.FrameTypes.REQUEST_CHANNEL:return Hu(t);case x.FrameTypes.METADATA_PUSH:return Pu(t);case x.FrameTypes.REQUEST_N:return Qu(t);case x.FrameTypes.RESUME:return nc(t);case x.FrameTypes.RESUME_OK:return oc(t);case x.FrameTypes.CANCEL:return Xu(t);case x.FrameTypes.LEASE:return Cu(t);default:}}L.sizeOfFrame=Ru;var Qs=14,Gs=2;function _u(t){var e=t.resumeToken!=null?t.resumeToken.byteLength:0,r=t.metadataMimeType!=null?Buffer.byteLength(t.metadataMimeType,"ascii"):0,n=t.dataMimeType!=null?Buffer.byteLength(t.dataMimeType,"ascii"):0,i=He(t),s=Buffer.allocUnsafe(j+Qs+(e?Gs+e:0)+r+n+i),o=ye(t,s);return o=s.writeUInt16BE(t.majorVersion,o),o=s.writeUInt16BE(t.minorVersion,o),o=s.writeUInt32BE(t.keepAlive,o),o=s.writeUInt32BE(t.lifetime,o),t.flags&x.Flags.RESUME_ENABLE&&(o=s.writeUInt16BE(e,o),t.resumeToken!=null&&(o+=t.resumeToken.copy(s,o))),o=s.writeUInt8(r,o),t.metadataMimeType!=null&&(o+=s.write(t.metadataMimeType,o,o+r,"ascii")),o=s.writeUInt8(n,o),t.dataMimeType!=null&&(o+=s.write(t.dataMimeType,o,o+n,"ascii")),Cr(t,s,o),s}function vu(t){var e=t.resumeToken!=null?t.resumeToken.byteLength:0,r=t.metadataMimeType!=null?Buffer.byteLength(t.metadataMimeType,"ascii"):0,n=t.dataMimeType!=null?Buffer.byteLength(t.dataMimeType,"ascii"):0,i=He(t);return j+Qs+(e?Gs+e:0)+r+n+i}function Ou(t,e,r){var n=t.length,i=j,s=t.readUInt16BE(i);i+=2;var o=t.readUInt16BE(i);i+=2;var u=t.readInt32BE(i);i+=4;var l=t.readInt32BE(i);i+=4;var a=null;if(r&x.Flags.RESUME_ENABLE){var c=t.readInt16BE(i);i+=2,a=t.slice(i,i+c),i+=c}var h=t.readUInt8(i);i+=1;var d=t.toString("ascii",i,i+h);i+=h;var p=t.readUInt8(i);i+=1;var m=t.toString("ascii",i,i+p);i+=p;var w={data:null,dataMimeType:m,flags:r,keepAlive:u,lifetime:l,majorVersion:s,metadata:null,metadataMimeType:d,minorVersion:o,resumeToken:a,streamId:0,type:x.FrameTypes.SETUP};return yt(t,w,i),w}var Ys=4;function Nu(t){var e=t.message!=null?Buffer.byteLength(t.message,"utf8"):0,r=Buffer.allocUnsafe(j+Ys+e),n=ye(t,r);return n=r.writeUInt32BE(t.code,n),t.message!=null&&r.write(t.message,n,n+e,"utf8"),r}function Au(t){var e=t.message!=null?Buffer.byteLength(t.message,"utf8"):0;return j+Ys+e}function Iu(t,e,r){var n=t.length,i=j,s=t.readInt32BE(i);i+=4;var o=t.length-i,u="";return o>0&&(u=t.toString("utf8",i,i+o),i+=o),{code:s,flags:r,message:u,streamId:e,type:x.FrameTypes.ERROR}}var Xs=8;function Fu(t){var e=t.data!=null?t.data.byteLength:0,r=Buffer.allocUnsafe(j+Xs+e),n=ye(t,r);return n=Vt(r,t.lastReceivedPosition,n),t.data!=null&&t.data.copy(r,n),r}function xu(t){var e=t.data!=null?t.data.byteLength:0;return j+Xs+e}function Lu(t,e,r){var n=t.length,i=j,s=Wt(t,i);i+=8;var o=null;return i<t.length&&(o=t.slice(i,t.length)),{data:o,flags:r,lastReceivedPosition:s,streamId:0,type:x.FrameTypes.KEEPALIVE}}var Ks=8;function Bu(t){var e=t.metadata!=null?t.metadata.byteLength:0,r=Buffer.allocUnsafe(j+Ks+e),n=ye(t,r);return n=r.writeUInt32BE(t.ttl,n),n=r.writeUInt32BE(t.requestCount,n),t.metadata!=null&&t.metadata.copy(r,n),r}function Cu(t){var e=t.metadata!=null?t.metadata.byteLength:0;return j+Ks+e}function Du(t,e,r){var n=j,i=t.readUInt32BE(n);n+=4;var s=t.readUInt32BE(n);n+=4;var o=null;return n<t.length&&(o=t.slice(n,t.length)),{flags:r,metadata:o,requestCount:s,streamId:0,ttl:i,type:x.FrameTypes.LEASE}}function Uu(t){var e=He(t),r=Buffer.allocUnsafe(j+e),n=ye(t,r);return Cr(t,r,n),r}function Mu(t){var e=He(t);return j+e}function ku(t){var e=t.metadata;if(e!=null){var r=Buffer.allocUnsafe(j+e.byteLength),n=ye(t,r);return e.copy(r,n),r}else{var r=Buffer.allocUnsafe(j);return ye(t,r),r}}function Pu(t){return j+(t.metadata!=null?t.metadata.byteLength:0)}function qu(t,e,r){var n=t.length,i={data:null,flags:r,metadata:null,streamId:e,type:x.FrameTypes.REQUEST_FNF};return yt(t,i,j),i}function $u(t,e,r){var n={data:null,flags:r,metadata:null,streamId:e,type:x.FrameTypes.REQUEST_RESPONSE};return yt(t,n,j),n}function ju(t,e,r){return{flags:r,metadata:length===j?null:t.slice(j,length),streamId:0,type:x.FrameTypes.METADATA_PUSH}}var Zs=4;function zu(t){var e=He(t),r=Buffer.allocUnsafe(j+Zs+e),n=ye(t,r);return n=r.writeUInt32BE(t.requestN,n),Cr(t,r,n),r}function Hu(t){var e=He(t);return j+Zs+e}function Wu(t,e,r){var n=t.length,i=j,s=t.readInt32BE(i);i+=4;var o={data:null,flags:r,metadata:null,requestN:s,streamId:e,type:x.FrameTypes.REQUEST_STREAM};return yt(t,o,i),o}function Vu(t,e,r){var n=t.length,i=j,s=t.readInt32BE(i);i+=4;var o={data:null,flags:r,metadata:null,requestN:s,streamId:e,type:x.FrameTypes.REQUEST_CHANNEL};return yt(t,o,i),o}var eo=4;function Ju(t){var e=Buffer.allocUnsafe(j+eo),r=ye(t,e);return e.writeUInt32BE(t.requestN,r),e}function Qu(t){return j+eo}function Gu(t,e,r){var n=t.length,i=t.readInt32BE(j);return{flags:r,requestN:i,streamId:e,type:x.FrameTypes.REQUEST_N}}function Yu(t){var e=Buffer.allocUnsafe(j);return ye(t,e),e}function Xu(t){return j}function Ku(t,e,r){var n=t.length;return{flags:r,streamId:e,type:x.FrameTypes.CANCEL}}function Zu(t){var e=He(t),r=Buffer.allocUnsafe(j+e),n=ye(t,r);return Cr(t,r,n),r}function ec(t){var e=He(t);return j+e}function tc(t,e,r){var n=t.length,i={data:null,flags:r,metadata:null,streamId:e,type:x.FrameTypes.PAYLOAD};return yt(t,i,j),i}var to=22;function rc(t){var e=t.resumeToken.byteLength,r=Buffer.allocUnsafe(j+to+e),n=ye(t,r);return n=r.writeUInt16BE(t.majorVersion,n),n=r.writeUInt16BE(t.minorVersion,n),n=r.writeUInt16BE(e,n),n+=t.resumeToken.copy(r,n),n=Vt(r,t.serverPosition,n),Vt(r,t.clientPosition,n),r}function nc(t){var e=t.resumeToken.byteLength;return j+to+e}function ic(t,e,r){var n=t.length,i=j,s=t.readUInt16BE(i);i+=2;var o=t.readUInt16BE(i);i+=2;var u=t.readInt16BE(i);i+=2;var l=t.slice(i,i+u);i+=u;var a=Wt(t,i);i+=8;var c=Wt(t,i);return i+=8,{clientPosition:c,flags:r,majorVersion:s,minorVersion:o,resumeToken:l,serverPosition:a,streamId:0,type:x.FrameTypes.RESUME}}var ro=8;function sc(t){var e=Buffer.allocUnsafe(j+ro),r=ye(t,e);return Vt(e,t.clientPosition,r),e}function oc(t){return j+ro}function ac(t,e,r){var n=t.length,i=Wt(t,j);return{clientPosition:i,flags:r,streamId:0,type:x.FrameTypes.RESUME_OK}}function ye(t,e){var r=e.writeInt32BE(t.streamId,0);return e.writeUInt16BE(t.type<<L.FRAME_TYPE_OFFFSET|t.flags&L.FLAGS_MASK,r)}function He(t){var e=0;return t.data!=null&&(e+=t.data.byteLength),x.Flags.hasMetadata(t.flags)&&(e+=ze,t.metadata!=null&&(e+=t.metadata.byteLength)),e}function Cr(t,e,r){if(x.Flags.hasMetadata(t.flags))if(t.metadata!=null){var n=t.metadata.byteLength;r=xr(e,n,r),r+=t.metadata.copy(e,r)}else r=xr(e,0,r);t.data!=null&&t.data.copy(e,r)}function yt(t,e,r){if(x.Flags.hasMetadata(e.flags)){var n=Lr(t,r);r+=ze,n>0&&(e.metadata=t.slice(r,r+n),r+=n)}r<t.length&&(e.data=t.slice(r,t.length))}var lc=function(){function t(){}return t.prototype.deserializeFrame=function(e){return Br(e)},t.prototype.deserializeFrameWithLength=function(e){return Ws(e)},t.prototype.deserializeFrames=function(e){return Vs(e)},t}();L.Deserializer=lc});var io=P(no=>{"use strict";Object.defineProperty(no,"__esModule",{value:!0})});var Bn=P(Et=>{"use strict";var so=Et&&Et.__values||function(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Et,"__esModule",{value:!0});Et.Deferred=void 0;var uc=function(){function t(){this._done=!1,this.onCloseCallbacks=[]}return Object.defineProperty(t.prototype,"done",{get:function(){return this._done},enumerable:!1,configurable:!0}),t.prototype.close=function(e){var r,n,i,s;if(this.done){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}if(this._done=!0,this._error=e,e){try{for(var o=so(this.onCloseCallbacks),u=o.next();!u.done;u=o.next()){var l=u.value;l(e)}}catch(h){r={error:h}}finally{try{u&&!u.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return}try{for(var a=so(this.onCloseCallbacks),c=a.next();!c.done;c=a.next()){var l=c.value;l()}}catch(h){i={error:h}}finally{try{c&&!c.done&&(s=a.return)&&s.call(a)}finally{if(i)throw i.error}}},t.prototype.onClose=function(e){if(this._done){e(this._error);return}this.onCloseCallbacks.push(e)},t}();Et.Deferred=uc});var Ce=P(Be=>{"use strict";var cc=Be&&Be.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(n[s]=i[s])},t(e,r)};return function(e,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r);function n(){this.constructor=e}e.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(Be,"__esModule",{value:!0});Be.ErrorCodes=Be.RSocketError=void 0;var hc=function(t){cc(e,t);function e(r,n){var i=t.call(this,n)||this;return i.code=r,i}return e}(Error);Be.RSocketError=hc;var fc;(function(t){t[t.RESERVED=0]="RESERVED",t[t.INVALID_SETUP=1]="INVALID_SETUP",t[t.UNSUPPORTED_SETUP=2]="UNSUPPORTED_SETUP",t[t.REJECTED_SETUP=3]="REJECTED_SETUP",t[t.REJECTED_RESUME=4]="REJECTED_RESUME",t[t.CONNECTION_CLOSE=258]="CONNECTION_CLOSE",t[t.CONNECTION_ERROR=257]="CONNECTION_ERROR",t[t.APPLICATION_ERROR=513]="APPLICATION_ERROR",t[t.REJECTED=514]="REJECTED",t[t.CANCELED=515]="CANCELED",t[t.INVALID=516]="INVALID",t[t.RESERVED_EXTENSION=4294967295]="RESERVED_EXTENSION"})(fc=Be.ErrorCodes||(Be.ErrorCodes={}))});var ao=P(oo=>{"use strict";Object.defineProperty(oo,"__esModule",{value:!0})});var Cn=P(ee=>{"use strict";var lo=ee&&ee.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(n[s]=i[s])},t(e,r)};return function(e,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r);function n(){this.constructor=e}e.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}(),dc=ee&&ee.__awaiter||function(t,e,r,n){function i(s){return s instanceof r?s:new r(function(o){o(s)})}return new(r||(r=Promise))(function(s,o){function u(c){try{a(n.next(c))}catch(h){o(h)}}function l(c){try{a(n.throw(c))}catch(h){o(h)}}function a(c){c.done?s(c.value):i(c.value).then(u,l)}a((n=n.apply(t,e||[])).next())})},pc=ee&&ee.__generator||function(t,e){var r={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,o;return o={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function u(a){return function(c){return l([a,c])}}function l(a){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(s=a[0]&2?i.return:a[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,a[1])).done)return s;switch(i=0,s&&(a=[a[0]&2,s.value]),a[0]){case 0:case 1:s=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,i=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(s=r.trys,!(s=s.length>0&&s[s.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!s||a[1]>s[0]&&a[1]<s[3])){r.label=a[1];break}if(a[0]===6&&r.label<s[1]){r.label=s[1],s=a;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(a);break}s[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(c){a=[6,c],i=0}finally{n=s=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};Object.defineProperty(ee,"__esModule",{value:!0});ee.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer=ee.ResumableClientServerInputMultiplexerDemultiplexer=ee.ClientServerInputMultiplexerDemultiplexer=ee.StreamIdGenerator=void 0;var Q=wt(),uo=Bn(),Dr=Ce(),Ur=be(),mc;(function(t){function e(n){return new r(n)}t.create=e;var r=function(){function n(i){this.currentId=i}return n.prototype.next=function(i){var s=this.currentId+2;i(s)&&(this.currentId=s)},n}()})(mc=ee.StreamIdGenerator||(ee.StreamIdGenerator={}));var co=function(t){lo(e,t);function e(r,n,i){var s=t.call(this)||this;return s.streamIdSupplier=r,s.outbound=n,s.closeable=i,s.registry={},i.onClose(s.close.bind(s)),s}return e.prototype.handle=function(r){if(Ur.Frame.isConnection(r)){if(r.type===Q.FrameTypes.RESERVED)return;this.connectionFramesHandler.handle(r)}else if(Ur.Frame.isRequest(r)){if(this.registry[r.streamId])return;this.requestFramesHandler.handle(r,this)}else{var n=this.registry[r.streamId];if(!n)return;n.handle(r)}},e.prototype.connectionInbound=function(r){if(this.connectionFramesHandler)throw new Error("Connection frame handler has already been installed");this.connectionFramesHandler=r},e.prototype.handleRequestStream=function(r){if(this.requestFramesHandler)throw new Error("Stream handler has already been installed");this.requestFramesHandler=r},e.prototype.send=function(r){this.outbound.send(r)},Object.defineProperty(e.prototype,"connectionOutbound",{get:function(){return this},enumerable:!1,configurable:!0}),e.prototype.createRequestStream=function(r){var n=this;if(this.done){r.handleReject(new Error("Already closed"));return}var i=this.registry;this.streamIdSupplier.next(function(s){return r.handleReady(s,n)},Object.keys(i))},e.prototype.connect=function(r){this.registry[r.streamId]=r},e.prototype.disconnect=function(r){delete this.registry[r.streamId]},e.prototype.close=function(r){if(this.done){t.prototype.close.call(this,r);return}for(var n in this.registry){var i=this.registry[n];i.close(new Error("Closed. ".concat(r?"Original cause [".concat(r,"]."):"")))}t.prototype.close.call(this,r)},e}(uo.Deferred);ee.ClientServerInputMultiplexerDemultiplexer=co;var gc=function(t){lo(e,t);function e(r,n,i,s,o,u,l){var a=t.call(this,r,n,new uo.Deferred)||this;return a.frameStore=s,a.token=o,a.sessionTimeout=l,u instanceof Function?a.reconnector=u:a.sessionStore=u,i.onClose(a.handleConnectionClose.bind(a)),a}return e.prototype.send=function(r){if(Ur.Frame.isConnection(r)){if(r.type===Q.FrameTypes.KEEPALIVE)r.lastReceivedPosition=this.frameStore.lastReceivedFramePosition;else if(r.type===Q.FrameTypes.ERROR){this.outbound.send(r),this.sessionStore&&delete this.sessionStore[this.token],t.prototype.close.call(this,new Dr.RSocketError(r.code,r.message));return}}else this.frameStore.store(r);this.outbound.send(r)},e.prototype.handle=function(r){if(Ur.Frame.isConnection(r)){if(r.type===Q.FrameTypes.KEEPALIVE)try{this.frameStore.dropTo(r.lastReceivedPosition)}catch(n){this.outbound.send({type:Q.FrameTypes.ERROR,streamId:0,flags:Q.Flags.NONE,code:n.code,message:n.message}),this.close(n)}else if(r.type===Q.FrameTypes.ERROR){t.prototype.handle.call(this,r),this.sessionStore&&delete this.sessionStore[this.token],t.prototype.close.call(this,new Dr.RSocketError(r.code,r.message));return}}else this.frameStore.record(r);t.prototype.handle.call(this,r)},e.prototype.resume=function(r,n,i){switch(this.outbound=n,r.type){case Q.FrameTypes.RESUME:{if(clearTimeout(this.timeoutId),this.frameStore.lastReceivedFramePosition<r.clientPosition){var s=new Dr.RSocketError(Q.ErrorCodes.REJECTED_RESUME,"Impossible to resume since first available client frame position is greater than last received server frame position");this.outbound.send({type:Q.FrameTypes.ERROR,streamId:0,flags:Q.Flags.NONE,code:s.code,message:s.message}),this.close(s);return}try{this.frameStore.dropTo(r.serverPosition)}catch(o){this.outbound.send({type:Q.FrameTypes.ERROR,streamId:0,flags:Q.Flags.NONE,code:o.code,message:o.message}),this.close(o);return}this.outbound.send({type:Q.FrameTypes.RESUME_OK,streamId:0,flags:Q.Flags.NONE,clientPosition:this.frameStore.lastReceivedFramePosition});break}case Q.FrameTypes.RESUME_OK:{try{this.frameStore.dropTo(r.clientPosition)}catch(o){this.outbound.send({type:Q.FrameTypes.ERROR,streamId:0,flags:Q.Flags.NONE,code:o.code,message:o.message}),this.close(o)}break}}this.frameStore.drain(this.outbound.send.bind(this.outbound)),i.onClose(this.handleConnectionClose.bind(this)),this.connectionFramesHandler.resume()},e.prototype.handleConnectionClose=function(r){return dc(this,void 0,void 0,function(){var n;return pc(this,function(i){switch(i.label){case 0:if(this.connectionFramesHandler.pause(),!this.reconnector)return[3,5];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.reconnector(this,this.frameStore)];case 2:return i.sent(),[3,4];case 3:return n=i.sent(),this.close(n),[3,4];case 4:return[3,6];case 5:this.timeoutId=setTimeout(this.close.bind(this),this.sessionTimeout),i.label=6;case 6:return[2]}})})},e}(co);ee.ResumableClientServerInputMultiplexerDemultiplexer=gc;var yc=function(){function t(e,r,n){this.outbound=e,this.closeable=r,this.delegate=n,this.resumed=!1}return t.prototype.close=function(){this.delegate.close()},t.prototype.onClose=function(e){this.delegate.onClose(e)},Object.defineProperty(t.prototype,"connectionOutbound",{get:function(){return this.delegate.connectionOutbound},enumerable:!1,configurable:!0}),t.prototype.createRequestStream=function(e){this.delegate.createRequestStream(e)},t.prototype.connectionInbound=function(e){this.delegate.connectionInbound(e)},t.prototype.handleRequestStream=function(e){this.delegate.handleRequestStream(e)},t.prototype.handle=function(e){var r=this;if(!this.resumed){if(e.type===Q.FrameTypes.RESUME_OK){this.resumed=!0,this.delegate.resume(e,this.outbound,this.closeable);return}else this.outbound.send({type:Q.FrameTypes.ERROR,streamId:0,code:Q.ErrorCodes.CONNECTION_ERROR,message:"Incomplete RESUME handshake. Unexpected frame ".concat(e.type," received"),flags:Q.Flags.NONE}),this.closeable.close(),this.closeable.onClose(function(){return r.delegate.close(new Dr.RSocketError(Q.ErrorCodes.CONNECTION_ERROR,"Incomplete RESUME handshake. Unexpected frame ".concat(e.type," received")))});return}this.delegate.handle(e)},t}();ee.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer=yc});var Jt=P(Oe=>{"use strict";var ho=Oe&&Oe.__generator||function(t,e){var r={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,o;return o={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function u(a){return function(c){return l([a,c])}}function l(a){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(s=a[0]&2?i.return:a[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,a[1])).done)return s;switch(i=0,s&&(a=[a[0]&2,s.value]),a[0]){case 0:case 1:s=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,i=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(s=r.trys,!(s=s.length>0&&s[s.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!s||a[1]>s[0]&&a[1]<s[3])){r.label=a[1];break}if(a[0]===6&&r.label<s[1]){r.label=s[1],s=a;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(a);break}s[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(c){a=[6,c],i=0}finally{n=s=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};Object.defineProperty(Oe,"__esModule",{value:!0});Oe.fragmentWithRequestN=Oe.fragment=Oe.isFragmentable=void 0;var M=be();function Ec(t,e,r){return e===0?!1:t.data.byteLength+(t.metadata?t.metadata.byteLength+M.Lengths.METADATA:0)+(r==M.FrameTypes.REQUEST_STREAM||r==M.FrameTypes.REQUEST_CHANNEL?M.Lengths.REQUEST:0)>e}Oe.isFragmentable=Ec;function wc(t,e,r,n,i){var s,o,u,l,a,c,h,h,d,p,m,m,w,F;return i===void 0&&(i=!1),ho(this,function(A){switch(A.label){case 0:return s=(F=(w=e.data)===null||w===void 0?void 0:w.byteLength)!==null&&F!==void 0?F:0,o=n!==M.FrameTypes.PAYLOAD,u=r,e.metadata?(a=e.metadata.byteLength,a!==0?[3,1]:(u-=M.Lengths.METADATA,l=Buffer.allocUnsafe(0),[3,6])):[3,6];case 1:return c=0,o?(u-=M.Lengths.METADATA,h=Math.min(a,c+u),l=e.metadata.slice(c,h),u-=l.byteLength,c=h,u!==0?[3,3]:(o=!1,[4,{type:n,flags:M.Flags.FOLLOWS|M.Flags.METADATA,data:void 0,metadata:l,streamId:t}])):[3,3];case 2:A.sent(),l=void 0,u=r,A.label=3;case 3:return c<a?(u-=M.Lengths.METADATA,h=Math.min(a,c+u),l=e.metadata.slice(c,h),u-=l.byteLength,c=h,u===0||s===0?[4,{type:M.FrameTypes.PAYLOAD,flags:M.Flags.NEXT|M.Flags.METADATA|(c===a&&i&&s===0?M.Flags.COMPLETE:M.Flags.FOLLOWS),data:void 0,metadata:l,streamId:t}]:[3,5]):[3,6];case 4:A.sent(),l=void 0,u=r,A.label=5;case 5:return[3,3];case 6:return d=0,o?(m=Math.min(s,d+u),p=e.data.slice(d,m),u-=p.byteLength,d=m,[4,{type:n,flags:M.Flags.FOLLOWS|(l?M.Flags.METADATA:M.Flags.NONE),data:p,metadata:l,streamId:t}]):[3,8];case 7:A.sent(),l=void 0,p=void 0,u=r,A.label=8;case 8:return d<s?(m=Math.min(s,d+u),p=e.data.slice(d,m),u-=p.byteLength,d=m,[4,{type:M.FrameTypes.PAYLOAD,flags:d===s?(i?M.Flags.COMPLETE:M.Flags.NONE)|M.Flags.NEXT|(l?M.Flags.METADATA:0):M.Flags.FOLLOWS|M.Flags.NEXT|(l?M.Flags.METADATA:0),data:p,metadata:l,streamId:t}]):[3,10];case 9:return A.sent(),l=void 0,p=void 0,u=r,[3,8];case 10:return[2]}})}Oe.fragment=wc;function Sc(t,e,r,n,i,s){var o,u,l,a,c,h,d,d,p,m,w,w,F,A;return s===void 0&&(s=!1),ho(this,function(O){switch(O.label){case 0:return o=(A=(F=e.data)===null||F===void 0?void 0:F.byteLength)!==null&&A!==void 0?A:0,u=!0,l=r,e.metadata?(c=e.metadata.byteLength,c!==0?[3,1]:(l-=M.Lengths.METADATA,a=Buffer.allocUnsafe(0),[3,6])):[3,6];case 1:return h=0,u?(l-=M.Lengths.METADATA+M.Lengths.REQUEST,d=Math.min(c,h+l),a=e.metadata.slice(h,d),l-=a.byteLength,h=d,l!==0?[3,3]:(u=!1,[4,{type:n,flags:M.Flags.FOLLOWS|M.Flags.METADATA,data:void 0,requestN:i,metadata:a,streamId:t}])):[3,3];case 2:O.sent(),a=void 0,l=r,O.label=3;case 3:return h<c?(l-=M.Lengths.METADATA,d=Math.min(c,h+l),a=e.metadata.slice(h,d),l-=a.byteLength,h=d,l===0||o===0?[4,{type:M.FrameTypes.PAYLOAD,flags:M.Flags.NEXT|M.Flags.METADATA|(h===c&&s&&o===0?M.Flags.COMPLETE:M.Flags.FOLLOWS),data:void 0,metadata:a,streamId:t}]:[3,5]):[3,6];case 4:O.sent(),a=void 0,l=r,O.label=5;case 5:return[3,3];case 6:return p=0,u?(l-=M.Lengths.REQUEST,w=Math.min(o,p+l),m=e.data.slice(p,w),l-=m.byteLength,p=w,[4,{type:n,flags:M.Flags.FOLLOWS|(a?M.Flags.METADATA:M.Flags.NONE),data:m,requestN:i,metadata:a,streamId:t}]):[3,8];case 7:O.sent(),a=void 0,m=void 0,l=r,O.label=8;case 8:return p<o?(w=Math.min(o,p+l),m=e.data.slice(p,w),l-=m.byteLength,p=w,[4,{type:M.FrameTypes.PAYLOAD,flags:p===o?(s?M.Flags.COMPLETE:M.Flags.NONE)|M.Flags.NEXT|(a?M.Flags.METADATA:0):M.Flags.FOLLOWS|M.Flags.NEXT|(a?M.Flags.METADATA:0),data:m,metadata:a,streamId:t}]):[3,10];case 9:return O.sent(),a=void 0,m=void 0,l=r,[3,8];case 10:return[2]}})}Oe.fragmentWithRequestN=Sc});var Qt=P(We=>{"use strict";Object.defineProperty(We,"__esModule",{value:!0});We.cancel=We.reassemble=We.add=void 0;function bc(t,e,r){return t.hasFragments?(t.data=t.data?Buffer.concat([t.data,e]):e,t.metadata&&r&&(t.metadata=Buffer.concat([t.metadata,r])),!0):(t.hasFragments=!0,t.data=e,r&&(t.metadata=r),!0)}We.add=bc;function Tc(t,e,r){t.hasFragments=!1;var n=t.data?Buffer.concat([t.data,e]):e;if(t.data=void 0,t.metadata){var i=r?Buffer.concat([t.metadata,r]):t.metadata;return t.metadata=void 0,{data:n,metadata:i}}return{data:n}}We.reassemble=Tc;function Rc(t){t.hasFragments=!1,t.data=void 0,t.metadata=void 0}We.cancel=Rc});var fo=P(le=>{"use strict";var _c=le&&le.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),vc=le&&le.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),Oc=le&&le.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&_c(e,t,r);return vc(e,t),e},Dn=le&&le.__values||function(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(le,"__esModule",{value:!0});le.RequestChannelResponderStream=le.RequestChannelRequesterStream=void 0;var ae=Ce(),St=Jt(),R=be(),Ne=Oc(Qt()),Nc=function(){function t(e,r,n,i,s,o){this.payload=e,this.isComplete=r,this.receiver=n,this.fragmentSize=i,this.initialRequestN=s,this.leaseManager=o,this.streamType=R.FrameTypes.REQUEST_CHANNEL}return t.prototype.handleReady=function(e,r){var n,i;if(this.outboundDone)return!1;this.streamId=e,this.stream=r,r.connect(this);var s=this.isComplete;if(s&&(this.outboundDone=s),(0,St.isFragmentable)(this.payload,this.fragmentSize,R.FrameTypes.REQUEST_CHANNEL))try{for(var o=Dn((0,St.fragmentWithRequestN)(e,this.payload,this.fragmentSize,R.FrameTypes.REQUEST_CHANNEL,this.initialRequestN,s)),u=o.next();!u.done;u=o.next()){var l=u.value;this.stream.send(l)}}catch(a){n={error:a}}finally{try{u&&!u.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}else this.stream.send({type:R.FrameTypes.REQUEST_CHANNEL,data:this.payload.data,metadata:this.payload.metadata,requestN:this.initialRequestN,flags:(this.payload.metadata!==void 0?R.Flags.METADATA:R.Flags.NONE)|(s?R.Flags.COMPLETE:R.Flags.NONE),streamId:e});return this.hasExtension&&this.stream.send({type:R.FrameTypes.EXT,streamId:e,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},t.prototype.handleReject=function(e){this.inboundDone||(this.inboundDone=!0,this.outboundDone=!0,this.receiver.onError(e))},t.prototype.handle=function(e){var r,n=e.type;switch(n){case R.FrameTypes.PAYLOAD:{var i=R.Flags.hasComplete(e.flags),s=R.Flags.hasNext(e.flags);if(i||!R.Flags.hasFollows(e.flags)){if(i&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this),!s)){this.receiver.onComplete();return}var o=this.hasFragments?Ne.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata};this.receiver.onNext(o,i);return}if(Ne.add(this,e.data,e.metadata))return;r="Unexpected frame size";break}case R.FrameTypes.CANCEL:{if(this.outboundDone)return;this.outboundDone=!0,this.inboundDone&&this.stream.disconnect(this),this.receiver.cancel();return}case R.FrameTypes.REQUEST_N:{if(this.outboundDone)return;if(this.hasFragments){r="Unexpected frame type [".concat(n,"] during reassembly");break}this.receiver.request(e.requestN);return}case R.FrameTypes.ERROR:{var u=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,this.stream.disconnect(this),Ne.cancel(this),u||this.receiver.cancel(),this.receiver.onError(new ae.RSocketError(e.code,e.message));return}case R.FrameTypes.EXT:this.receiver.onExtension(e.extendedType,e.extendedContent,R.Flags.hasIgnore(e.flags));return;default:r="Unexpected frame type [".concat(n,"]")}this.close(new ae.RSocketError(ae.ErrorCodes.CANCELED,r)),this.stream.send({type:R.FrameTypes.CANCEL,streamId:this.streamId,flags:R.Flags.NONE}),this.stream.disconnect(this)},t.prototype.request=function(e){if(!this.inboundDone){if(!this.streamId){this.initialRequestN+=e;return}this.stream.send({type:R.FrameTypes.REQUEST_N,flags:R.Flags.NONE,requestN:e,streamId:this.streamId})}},t.prototype.cancel=function(){var e,r=this.inboundDone,n=this.outboundDone;if(!(r&&n)){if(this.inboundDone=!0,this.outboundDone=!0,n||this.receiver.cancel(),!this.streamId){(e=this.leaseManager)===null||e===void 0||e.cancelRequest(this);return}this.stream.send({type:r?R.FrameTypes.ERROR:R.FrameTypes.CANCEL,flags:R.Flags.NONE,streamId:this.streamId,code:ae.ErrorCodes.CANCELED,message:"Cancelled"}),this.stream.disconnect(this),Ne.cancel(this)}},t.prototype.onNext=function(e,r){var n,i;if(!this.outboundDone)if(r&&(this.outboundDone=!0,this.inboundDone&&this.stream.disconnect(this)),(0,St.isFragmentable)(e,this.fragmentSize,R.FrameTypes.PAYLOAD))try{for(var s=Dn((0,St.fragment)(this.streamId,e,this.fragmentSize,R.FrameTypes.PAYLOAD,r)),o=s.next();!o.done;o=s.next()){var u=o.value;this.stream.send(u)}}catch(l){n={error:l}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:R.FrameTypes.PAYLOAD,streamId:this.streamId,flags:R.Flags.NEXT|(e.metadata?R.Flags.METADATA:R.Flags.NONE)|(r?R.Flags.COMPLETE:R.Flags.NONE),data:e.data,metadata:e.metadata})},t.prototype.onComplete=function(){if(!this.streamId){this.isComplete=!0;return}this.outboundDone||(this.outboundDone=!0,this.stream.send({type:R.FrameTypes.PAYLOAD,streamId:this.streamId,flags:R.Flags.COMPLETE,data:null,metadata:null}),this.inboundDone&&this.stream.disconnect(this))},t.prototype.onError=function(e){if(!this.outboundDone){var r=this.inboundDone;this.outboundDone=!0,this.inboundDone=!0,this.stream.send({type:R.FrameTypes.ERROR,streamId:this.streamId,flags:R.Flags.NONE,code:e instanceof ae.RSocketError?e.code:ae.ErrorCodes.APPLICATION_ERROR,message:e.message}),this.stream.disconnect(this),r||this.receiver.onError(e)}},t.prototype.onExtension=function(e,r,n){if(!this.outboundDone){if(!this.streamId){this.hasExtension=!0,this.extendedType=e,this.extendedContent=r,this.flags=n?R.Flags.IGNORE:R.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:R.FrameTypes.EXT,extendedType:e,extendedContent:r,flags:n?R.Flags.IGNORE:R.Flags.NONE})}},t.prototype.close=function(e){if(!(this.inboundDone&&this.outboundDone)){var r=this.inboundDone,n=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,Ne.cancel(this),n||this.receiver.cancel(),r||(e?this.receiver.onError(e):this.receiver.onComplete())}},t}();le.RequestChannelRequesterStream=Nc;var Ac=function(){function t(e,r,n,i,s){if(this.streamId=e,this.stream=r,this.fragmentSize=n,this.handler=i,this.streamType=R.FrameTypes.REQUEST_CHANNEL,r.connect(this),R.Flags.hasFollows(s.flags)){Ne.add(this,s.data,s.metadata),this.initialRequestN=s.requestN,this.isComplete=R.Flags.hasComplete(s.flags);return}var o={data:s.data,metadata:s.metadata},u=R.Flags.hasComplete(s.flags);this.inboundDone=u;try{this.receiver=i(o,s.requestN,u,this),this.outboundDone&&this.defferedError&&this.receiver.onError(this.defferedError)}catch(l){this.outboundDone&&!this.inboundDone?this.cancel():this.inboundDone=!0,this.onError(l)}}return t.prototype.handle=function(e){var r,n=e.type;switch(n){case R.FrameTypes.PAYLOAD:{if(R.Flags.hasFollows(e.flags)){if(Ne.add(this,e.data,e.metadata))return;r="Unexpected frame size";break}var i=this.hasFragments?Ne.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata},s=R.Flags.hasComplete(e.flags);if(this.receiver){if(s&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this),!R.Flags.hasNext(e.flags))){this.receiver.onComplete();return}this.receiver.onNext(i,s)}else{var o=this.isComplete||s;o&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this));try{this.receiver=this.handler(i,this.initialRequestN,o,this),this.outboundDone&&this.defferedError}catch(a){this.outboundDone&&!this.inboundDone?this.cancel():this.inboundDone=!0,this.onError(a)}}return}case R.FrameTypes.REQUEST_N:{if(!this.receiver||this.hasFragments){r="Unexpected frame type [".concat(n,"] during reassembly");break}this.receiver.request(e.requestN);return}case R.FrameTypes.ERROR:case R.FrameTypes.CANCEL:{var o=this.inboundDone,u=this.outboundDone;if(this.inboundDone=!0,this.outboundDone=!0,this.stream.disconnect(this),Ne.cancel(this),!this.receiver)return;if(u||this.receiver.cancel(),!o){var l=n===R.FrameTypes.CANCEL?new ae.RSocketError(ae.ErrorCodes.CANCELED,"Cancelled"):new ae.RSocketError(e.code,e.message);this.receiver.onError(l)}return}case R.FrameTypes.EXT:{if(!this.receiver||this.hasFragments){r="Unexpected frame type [".concat(n,"] during reassembly");break}this.receiver.onExtension(e.extendedType,e.extendedContent,R.Flags.hasIgnore(e.flags));return}default:r="Unexpected frame type [".concat(n,"]")}this.stream.send({type:R.FrameTypes.ERROR,flags:R.Flags.NONE,code:ae.ErrorCodes.CANCELED,message:r,streamId:this.streamId}),this.stream.disconnect(this),this.close(new ae.RSocketError(ae.ErrorCodes.CANCELED,r))},t.prototype.onError=function(e){if(this.outboundDone){console.warn("Trying to error for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}var r=this.inboundDone;this.outboundDone=!0,this.inboundDone=!0,this.stream.send({type:R.FrameTypes.ERROR,flags:R.Flags.NONE,code:e instanceof ae.RSocketError?e.code:ae.ErrorCodes.APPLICATION_ERROR,message:e.message,streamId:this.streamId}),this.stream.disconnect(this),r||(this.receiver?this.receiver.onError(e):this.defferedError=e)},t.prototype.onNext=function(e,r){var n,i;if(!this.outboundDone){if(r&&(this.outboundDone=!0),(0,St.isFragmentable)(e,this.fragmentSize,R.FrameTypes.PAYLOAD))try{for(var s=Dn((0,St.fragment)(this.streamId,e,this.fragmentSize,R.FrameTypes.PAYLOAD,r)),o=s.next();!o.done;o=s.next()){var u=o.value;this.stream.send(u)}}catch(l){n={error:l}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:R.FrameTypes.PAYLOAD,flags:R.Flags.NEXT|(r?R.Flags.COMPLETE:R.Flags.NONE)|(e.metadata?R.Flags.METADATA:R.Flags.NONE),data:e.data,metadata:e.metadata,streamId:this.streamId});r&&this.inboundDone&&this.stream.disconnect(this)}},t.prototype.onComplete=function(){this.outboundDone||(this.outboundDone=!0,this.stream.send({type:R.FrameTypes.PAYLOAD,flags:R.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.inboundDone&&this.stream.disconnect(this))},t.prototype.onExtension=function(e,r,n){this.outboundDone&&this.inboundDone||this.stream.send({type:R.FrameTypes.EXT,streamId:this.streamId,flags:n?R.Flags.IGNORE:R.Flags.NONE,extendedType:e,extendedContent:r})},t.prototype.request=function(e){this.inboundDone||this.stream.send({type:R.FrameTypes.REQUEST_N,flags:R.Flags.NONE,streamId:this.streamId,requestN:e})},t.prototype.cancel=function(){this.inboundDone||(this.inboundDone=!0,this.stream.send({type:R.FrameTypes.CANCEL,flags:R.Flags.NONE,streamId:this.streamId}),this.outboundDone&&this.stream.disconnect(this))},t.prototype.close=function(e){if(this.inboundDone&&this.outboundDone){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}var r=this.inboundDone,n=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,Ne.cancel(this);var i=this.receiver;i&&(n||i.cancel(),r||(e?i.onError(e):i.onComplete()))},t}();le.RequestChannelResponderStream=Ac});var mo=P(ce=>{"use strict";var Ic=ce&&ce.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),Fc=ce&&ce.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),xc=ce&&ce.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&Ic(e,t,r);return Fc(e,t),e},Lc=ce&&ce.__values||function(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(ce,"__esModule",{value:!0});ce.RequestFnfResponderStream=ce.RequestFnFRequesterStream=void 0;var Mr=Ce(),po=Jt(),ue=be(),Gt=xc(Qt()),Bc=function(){function t(e,r,n,i){this.payload=e,this.receiver=r,this.fragmentSize=n,this.leaseManager=i,this.streamType=ue.FrameTypes.REQUEST_FNF}return t.prototype.handleReady=function(e,r){var n,i;if(this.done)return!1;if(this.streamId=e,(0,po.isFragmentable)(this.payload,this.fragmentSize,ue.FrameTypes.REQUEST_FNF))try{for(var s=Lc((0,po.fragment)(e,this.payload,this.fragmentSize,ue.FrameTypes.REQUEST_FNF)),o=s.next();!o.done;o=s.next()){var u=o.value;r.send(u)}}catch(l){n={error:l}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else r.send({type:ue.FrameTypes.REQUEST_FNF,data:this.payload.data,metadata:this.payload.metadata,flags:this.payload.metadata?ue.Flags.METADATA:0,streamId:e});return this.done=!0,this.receiver.onComplete(),!0},t.prototype.handleReject=function(e){this.done||(this.done=!0,this.receiver.onError(e))},t.prototype.cancel=function(){var e;this.done||(this.done=!0,(e=this.leaseManager)===null||e===void 0||e.cancelRequest(this))},t.prototype.handle=function(e){if(e.type==ue.FrameTypes.ERROR){this.close(new Mr.RSocketError(e.code,e.message));return}this.close(new Mr.RSocketError(Mr.ErrorCodes.CANCELED,"Received invalid frame"))},t.prototype.close=function(e){if(this.done){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}e?this.receiver.onError(e):this.receiver.onComplete()},t}();ce.RequestFnFRequesterStream=Bc;var Cc=function(){function t(e,r,n,i){if(this.streamId=e,this.stream=r,this.handler=n,this.streamType=ue.FrameTypes.REQUEST_FNF,ue.Flags.hasFollows(i.flags)){Gt.add(this,i.data,i.metadata),r.connect(this);return}var s={data:i.data,metadata:i.metadata};try{this.cancellable=n(s,this)}catch{}}return t.prototype.handle=function(e){var r;if(e.type==ue.FrameTypes.PAYLOAD)if(ue.Flags.hasFollows(e.flags)){if(Gt.add(this,e.data,e.metadata))return;r="Unexpected fragment size"}else{this.stream.disconnect(this);var n=Gt.reassemble(this,e.data,e.metadata);try{this.cancellable=this.handler(n,this)}catch{}return}else r="Unexpected frame type [".concat(e.type,"]");this.done=!0,e.type!=ue.FrameTypes.CANCEL&&e.type!=ue.FrameTypes.ERROR&&this.stream.send({type:ue.FrameTypes.ERROR,streamId:this.streamId,flags:ue.Flags.NONE,code:Mr.ErrorCodes.CANCELED,message:r}),this.stream.disconnect(this),Gt.cancel(this)},t.prototype.close=function(e){var r;if(this.done){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}this.done=!0,Gt.cancel(this),(r=this.cancellable)===null||r===void 0||r.cancel()},t.prototype.onError=function(e){},t.prototype.onComplete=function(){},t}();ce.RequestFnfResponderStream=Cc});var yo=P(he=>{"use strict";var Dc=he&&he.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),Uc=he&&he.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),Mc=he&&he.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&Dc(e,t,r);return Uc(e,t),e},go=he&&he.__values||function(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(he,"__esModule",{value:!0});he.RequestResponseResponderStream=he.RequestResponseRequesterStream=void 0;var bt=Ce(),kr=Jt(),q=be(),Ae=Mc(Qt()),kc=function(){function t(e,r,n,i){this.payload=e,this.receiver=r,this.fragmentSize=n,this.leaseManager=i,this.streamType=q.FrameTypes.REQUEST_RESPONSE}return t.prototype.handleReady=function(e,r){var n,i;if(this.done)return!1;if(this.streamId=e,this.stream=r,r.connect(this),(0,kr.isFragmentable)(this.payload,this.fragmentSize,q.FrameTypes.REQUEST_RESPONSE))try{for(var s=go((0,kr.fragment)(e,this.payload,this.fragmentSize,q.FrameTypes.REQUEST_RESPONSE)),o=s.next();!o.done;o=s.next()){var u=o.value;this.stream.send(u)}}catch(l){n={error:l}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:q.FrameTypes.REQUEST_RESPONSE,data:this.payload.data,metadata:this.payload.metadata,flags:this.payload.metadata?q.Flags.METADATA:0,streamId:e});return this.hasExtension&&this.stream.send({type:q.FrameTypes.EXT,streamId:e,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},t.prototype.handleReject=function(e){this.done||(this.done=!0,this.receiver.onError(e))},t.prototype.handle=function(e){var r,n=e.type;switch(n){case q.FrameTypes.PAYLOAD:{var i=q.Flags.hasComplete(e.flags),s=q.Flags.hasNext(e.flags);if(i||!q.Flags.hasFollows(e.flags)){if(this.done=!0,this.stream.disconnect(this),!s){this.receiver.onComplete();return}var o=this.hasFragments?Ae.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata};this.receiver.onNext(o,!0);return}if(!Ae.add(this,e.data,e.metadata)){r="Unexpected fragment size";break}return}case q.FrameTypes.ERROR:{this.done=!0,this.stream.disconnect(this),Ae.cancel(this),this.receiver.onError(new bt.RSocketError(e.code,e.message));return}case q.FrameTypes.EXT:{if(this.hasFragments){r="Unexpected frame type [".concat(n,"] during reassembly");break}this.receiver.onExtension(e.extendedType,e.extendedContent,q.Flags.hasIgnore(e.flags));return}default:r="Unexpected frame type [".concat(n,"]")}this.close(new bt.RSocketError(bt.ErrorCodes.CANCELED,r)),this.stream.send({type:q.FrameTypes.CANCEL,streamId:this.streamId,flags:q.Flags.NONE}),this.stream.disconnect(this)},t.prototype.cancel=function(){var e;if(!this.done){if(this.done=!0,!this.streamId){(e=this.leaseManager)===null||e===void 0||e.cancelRequest(this);return}this.stream.send({type:q.FrameTypes.CANCEL,flags:q.Flags.NONE,streamId:this.streamId}),this.stream.disconnect(this),Ae.cancel(this)}},t.prototype.onExtension=function(e,r,n){if(!this.done){if(!this.streamId){this.hasExtension=!0,this.extendedType=e,this.extendedContent=r,this.flags=n?q.Flags.IGNORE:q.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:q.FrameTypes.EXT,extendedType:e,extendedContent:r,flags:n?q.Flags.IGNORE:q.Flags.NONE})}},t.prototype.close=function(e){this.done||(this.done=!0,Ae.cancel(this),e?this.receiver.onError(e):this.receiver.onComplete())},t}();he.RequestResponseRequesterStream=kc;var Pc=function(){function t(e,r,n,i,s){if(this.streamId=e,this.stream=r,this.fragmentSize=n,this.handler=i,this.streamType=q.FrameTypes.REQUEST_RESPONSE,r.connect(this),q.Flags.hasFollows(s.flags)){Ae.add(this,s.data,s.metadata);return}var o={data:s.data,metadata:s.metadata};try{this.receiver=i(o,this)}catch(u){this.onError(u)}}return t.prototype.handle=function(e){var r,n;if(!this.receiver||this.hasFragments)if(e.type===q.FrameTypes.PAYLOAD)if(q.Flags.hasFollows(e.flags)){if(Ae.add(this,e.data,e.metadata))return;n="Unexpected fragment size"}else{var i=Ae.reassemble(this,e.data,e.metadata);try{this.receiver=this.handler(i,this)}catch(s){this.onError(s)}return}else n="Unexpected frame type [".concat(e.type,"] during reassembly");else if(e.type===q.FrameTypes.EXT){this.receiver.onExtension(e.extendedType,e.extendedContent,q.Flags.hasIgnore(e.flags));return}else n="Unexpected frame type [".concat(e.type,"]");this.done=!0,(r=this.receiver)===null||r===void 0||r.cancel(),e.type!==q.FrameTypes.CANCEL&&e.type!==q.FrameTypes.ERROR&&this.stream.send({type:q.FrameTypes.ERROR,flags:q.Flags.NONE,code:bt.ErrorCodes.CANCELED,message:n,streamId:this.streamId}),this.stream.disconnect(this),Ae.cancel(this)},t.prototype.onError=function(e){if(this.done){console.warn("Trying to error for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}this.done=!0,this.stream.send({type:q.FrameTypes.ERROR,flags:q.Flags.NONE,code:e instanceof bt.RSocketError?e.code:bt.ErrorCodes.APPLICATION_ERROR,message:e.message,streamId:this.streamId}),this.stream.disconnect(this)},t.prototype.onNext=function(e,r){var n,i;if(!this.done){if(this.done=!0,(0,kr.isFragmentable)(e,this.fragmentSize,q.FrameTypes.PAYLOAD))try{for(var s=go((0,kr.fragment)(this.streamId,e,this.fragmentSize,q.FrameTypes.PAYLOAD,!0)),o=s.next();!o.done;o=s.next()){var u=o.value;this.stream.send(u)}}catch(l){n={error:l}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:q.FrameTypes.PAYLOAD,flags:q.Flags.NEXT|q.Flags.COMPLETE|(e.metadata?q.Flags.METADATA:0),data:e.data,metadata:e.metadata,streamId:this.streamId});this.stream.disconnect(this)}},t.prototype.onComplete=function(){this.done||(this.done=!0,this.stream.send({type:q.FrameTypes.PAYLOAD,flags:q.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.stream.disconnect(this))},t.prototype.onExtension=function(e,r,n){this.done||this.stream.send({type:q.FrameTypes.EXT,streamId:this.streamId,flags:n?q.Flags.IGNORE:q.Flags.NONE,extendedType:e,extendedContent:r})},t.prototype.close=function(e){var r;if(this.done){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}Ae.cancel(this),(r=this.receiver)===null||r===void 0||r.cancel()},t}();he.RequestResponseResponderStream=Pc});var wo=P(fe=>{"use strict";var qc=fe&&fe.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),$c=fe&&fe.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),jc=fe&&fe.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(t!=null)for(var r in t)r!=="default"&&Object.prototype.hasOwnProperty.call(t,r)&&qc(e,t,r);return $c(e,t),e},Eo=fe&&fe.__values||function(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(fe,"__esModule",{value:!0});fe.RequestStreamResponderStream=fe.RequestStreamRequesterStream=void 0;var Tt=Ce(),Pr=Jt(),D=be(),Ie=jc(Qt()),zc=function(){function t(e,r,n,i,s){this.payload=e,this.receiver=r,this.fragmentSize=n,this.initialRequestN=i,this.leaseManager=s,this.streamType=D.FrameTypes.REQUEST_STREAM}return t.prototype.handleReady=function(e,r){var n,i;if(this.done)return!1;if(this.streamId=e,this.stream=r,r.connect(this),(0,Pr.isFragmentable)(this.payload,this.fragmentSize,D.FrameTypes.REQUEST_STREAM))try{for(var s=Eo((0,Pr.fragmentWithRequestN)(e,this.payload,this.fragmentSize,D.FrameTypes.REQUEST_STREAM,this.initialRequestN)),o=s.next();!o.done;o=s.next()){var u=o.value;this.stream.send(u)}}catch(l){n={error:l}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:D.FrameTypes.REQUEST_STREAM,data:this.payload.data,metadata:this.payload.metadata,requestN:this.initialRequestN,flags:this.payload.metadata!==void 0?D.Flags.METADATA:0,streamId:e});return this.hasExtension&&this.stream.send({type:D.FrameTypes.EXT,streamId:e,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},t.prototype.handleReject=function(e){this.done||(this.done=!0,this.receiver.onError(e))},t.prototype.handle=function(e){var r,n=e.type;switch(n){case D.FrameTypes.PAYLOAD:{var i=D.Flags.hasComplete(e.flags),s=D.Flags.hasNext(e.flags);if(i||!D.Flags.hasFollows(e.flags)){if(i&&(this.done=!0,this.stream.disconnect(this),!s)){this.receiver.onComplete();return}var o=this.hasFragments?Ie.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata};this.receiver.onNext(o,i);return}if(!Ie.add(this,e.data,e.metadata)){r="Unexpected fragment size";break}return}case D.FrameTypes.ERROR:{this.done=!0,this.stream.disconnect(this),Ie.cancel(this),this.receiver.onError(new Tt.RSocketError(e.code,e.message));return}case D.FrameTypes.EXT:{if(this.hasFragments){r="Unexpected frame type [".concat(n,"] during reassembly");break}this.receiver.onExtension(e.extendedType,e.extendedContent,D.Flags.hasIgnore(e.flags));return}default:r="Unexpected frame type [".concat(n,"]")}this.close(new Tt.RSocketError(Tt.ErrorCodes.CANCELED,r)),this.stream.send({type:D.FrameTypes.CANCEL,streamId:this.streamId,flags:D.Flags.NONE}),this.stream.disconnect(this)},t.prototype.request=function(e){if(!this.done){if(!this.streamId){this.initialRequestN+=e;return}this.stream.send({type:D.FrameTypes.REQUEST_N,flags:D.Flags.NONE,requestN:e,streamId:this.streamId})}},t.prototype.cancel=function(){var e;if(!this.done){if(this.done=!0,!this.streamId){(e=this.leaseManager)===null||e===void 0||e.cancelRequest(this);return}this.stream.send({type:D.FrameTypes.CANCEL,flags:D.Flags.NONE,streamId:this.streamId}),this.stream.disconnect(this),Ie.cancel(this)}},t.prototype.onExtension=function(e,r,n){if(!this.done){if(!this.streamId){this.hasExtension=!0,this.extendedType=e,this.extendedContent=r,this.flags=n?D.Flags.IGNORE:D.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:D.FrameTypes.EXT,extendedType:e,extendedContent:r,flags:n?D.Flags.IGNORE:D.Flags.NONE})}},t.prototype.close=function(e){this.done||(this.done=!0,Ie.cancel(this),e?this.receiver.onError(e):this.receiver.onComplete())},t}();fe.RequestStreamRequesterStream=zc;var Hc=function(){function t(e,r,n,i,s){if(this.streamId=e,this.stream=r,this.fragmentSize=n,this.handler=i,this.streamType=D.FrameTypes.REQUEST_STREAM,r.connect(this),D.Flags.hasFollows(s.flags)){this.initialRequestN=s.requestN,Ie.add(this,s.data,s.metadata);return}var o={data:s.data,metadata:s.metadata};try{this.receiver=i(o,s.requestN,this)}catch(u){this.onError(u)}}return t.prototype.handle=function(e){var r,n;if(!this.receiver||this.hasFragments)if(e.type===D.FrameTypes.PAYLOAD)if(D.Flags.hasFollows(e.flags)){if(Ie.add(this,e.data,e.metadata))return;n="Unexpected frame size"}else{var i=Ie.reassemble(this,e.data,e.metadata);try{this.receiver=this.handler(i,this.initialRequestN,this)}catch(s){this.onError(s)}return}else n="Unexpected frame type [".concat(e.type,"] during reassembly");else if(e.type===D.FrameTypes.REQUEST_N){this.receiver.request(e.requestN);return}else if(e.type===D.FrameTypes.EXT){this.receiver.onExtension(e.extendedType,e.extendedContent,D.Flags.hasIgnore(e.flags));return}else n="Unexpected frame type [".concat(e.type,"]");this.done=!0,Ie.cancel(this),(r=this.receiver)===null||r===void 0||r.cancel(),e.type!==D.FrameTypes.CANCEL&&e.type!==D.FrameTypes.ERROR&&this.stream.send({type:D.FrameTypes.ERROR,flags:D.Flags.NONE,code:Tt.ErrorCodes.CANCELED,message:n,streamId:this.streamId}),this.stream.disconnect(this)},t.prototype.onError=function(e){if(this.done){console.warn("Trying to error for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}this.done=!0,this.stream.send({type:D.FrameTypes.ERROR,flags:D.Flags.NONE,code:e instanceof Tt.RSocketError?e.code:Tt.ErrorCodes.APPLICATION_ERROR,message:e.message,streamId:this.streamId}),this.stream.disconnect(this)},t.prototype.onNext=function(e,r){var n,i;if(!this.done){if(r&&(this.done=!0),(0,Pr.isFragmentable)(e,this.fragmentSize,D.FrameTypes.PAYLOAD))try{for(var s=Eo((0,Pr.fragment)(this.streamId,e,this.fragmentSize,D.FrameTypes.PAYLOAD,r)),o=s.next();!o.done;o=s.next()){var u=o.value;this.stream.send(u)}}catch(l){n={error:l}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:D.FrameTypes.PAYLOAD,flags:D.Flags.NEXT|(r?D.Flags.COMPLETE:D.Flags.NONE)|(e.metadata?D.Flags.METADATA:D.Flags.NONE),data:e.data,metadata:e.metadata,streamId:this.streamId});r&&this.stream.disconnect(this)}},t.prototype.onComplete=function(){this.done||(this.done=!0,this.stream.send({type:D.FrameTypes.PAYLOAD,flags:D.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.stream.disconnect(this))},t.prototype.onExtension=function(e,r,n){this.done||this.stream.send({type:D.FrameTypes.EXT,streamId:this.streamId,flags:n?D.Flags.IGNORE:D.Flags.NONE,extendedType:e,extendedContent:r})},t.prototype.close=function(e){var r;if(this.done){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}Ie.cancel(this),(r=this.receiver)===null||r===void 0||r.cancel()},t}();fe.RequestStreamResponderStream=Hc});var Un=P(de=>{"use strict";Object.defineProperty(de,"__esModule",{value:!0});de.KeepAliveSender=de.KeepAliveHandler=de.DefaultConnectionFrameHandler=de.DefaultStreamRequestHandler=de.LeaseHandler=de.RSocketRequester=void 0;var Yt=Ce(),te=be(),So=fo(),bo=mo(),To=yo(),Ro=wo(),Wc=function(){function t(e,r,n){this.connection=e,this.fragmentSize=r,this.leaseManager=n}return t.prototype.fireAndForget=function(e,r){var n=new bo.RequestFnFRequesterStream(e,r,this.fragmentSize,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(n):this.connection.multiplexerDemultiplexer.createRequestStream(n),n},t.prototype.requestResponse=function(e,r){var n=new To.RequestResponseRequesterStream(e,r,this.fragmentSize,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(n):this.connection.multiplexerDemultiplexer.createRequestStream(n),n},t.prototype.requestStream=function(e,r,n){var i=new Ro.RequestStreamRequesterStream(e,n,this.fragmentSize,r,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(i):this.connection.multiplexerDemultiplexer.createRequestStream(i),i},t.prototype.requestChannel=function(e,r,n,i){var s=new So.RequestChannelRequesterStream(e,n,i,this.fragmentSize,r,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(s):this.connection.multiplexerDemultiplexer.createRequestStream(s),s},t.prototype.metadataPush=function(e,r){throw new Error("Method not implemented.")},t.prototype.close=function(e){this.connection.close(e)},t.prototype.onClose=function(e){this.connection.onClose(e)},t}();de.RSocketRequester=Wc;var Vc=function(){function t(e,r){this.maxPendingRequests=e,this.multiplexer=r,this.pendingRequests=[],this.expirationTime=0,this.availableLease=0}return t.prototype.handle=function(e){for(this.expirationTime=e.ttl+Date.now(),this.availableLease=e.requestCount;this.availableLease>0&&this.pendingRequests.length>0;){var r=this.pendingRequests.shift();this.availableLease--,this.multiplexer.createRequestStream(r)}},t.prototype.requestLease=function(e){var r=this.availableLease;if(r>0&&Date.now()<this.expirationTime){this.availableLease=r-1,this.multiplexer.createRequestStream(e);return}if(this.pendingRequests.length>=this.maxPendingRequests){e.handleReject(new Yt.RSocketError(Yt.ErrorCodes.REJECTED,"No available lease given"));return}this.pendingRequests.push(e)},t.prototype.cancelRequest=function(e){var r=this.pendingRequests.indexOf(e);r>-1&&this.pendingRequests.splice(r,1)},t}();de.LeaseHandler=Vc;var Jc=function(){function t(e,r){this.rsocket=e,this.fragmentSize=r}return t.prototype.handle=function(e,r){switch(e.type){case te.FrameTypes.REQUEST_FNF:this.rsocket.fireAndForget&&new bo.RequestFnfResponderStream(e.streamId,r,this.rsocket.fireAndForget.bind(this.rsocket),e);return;case te.FrameTypes.REQUEST_RESPONSE:if(this.rsocket.requestResponse){new To.RequestResponseResponderStream(e.streamId,r,this.fragmentSize,this.rsocket.requestResponse.bind(this.rsocket),e);return}this.rejectRequest(e.streamId,r);return;case te.FrameTypes.REQUEST_STREAM:if(this.rsocket.requestStream){new Ro.RequestStreamResponderStream(e.streamId,r,this.fragmentSize,this.rsocket.requestStream.bind(this.rsocket),e);return}this.rejectRequest(e.streamId,r);return;case te.FrameTypes.REQUEST_CHANNEL:if(this.rsocket.requestChannel){new So.RequestChannelResponderStream(e.streamId,r,this.fragmentSize,this.rsocket.requestChannel.bind(this.rsocket),e);return}this.rejectRequest(e.streamId,r);return}},t.prototype.rejectRequest=function(e,r){r.send({type:te.FrameTypes.ERROR,streamId:e,flags:te.Flags.NONE,code:Yt.ErrorCodes.REJECTED,message:"No available handler found"})},t.prototype.close=function(){},t}();de.DefaultStreamRequestHandler=Jc;var Qc=function(){function t(e,r,n,i,s){this.connection=e,this.keepAliveHandler=r,this.keepAliveSender=n,this.leaseHandler=i,this.rsocket=s}return t.prototype.handle=function(e){switch(e.type){case te.FrameTypes.KEEPALIVE:this.keepAliveHandler.handle(e);return;case te.FrameTypes.LEASE:if(this.leaseHandler){this.leaseHandler.handle(e);return}return;case te.FrameTypes.ERROR:this.connection.close(new Yt.RSocketError(e.code,e.message));return;case te.FrameTypes.METADATA_PUSH:this.rsocket.metadataPush;return;default:this.connection.multiplexerDemultiplexer.connectionOutbound.send({type:te.FrameTypes.ERROR,streamId:0,flags:te.Flags.NONE,message:"Received unknown frame type",code:Yt.ErrorCodes.CONNECTION_ERROR})}},t.prototype.pause=function(){var e;this.keepAliveHandler.pause(),(e=this.keepAliveSender)===null||e===void 0||e.pause()},t.prototype.resume=function(){var e;this.keepAliveHandler.start(),(e=this.keepAliveSender)===null||e===void 0||e.start()},t.prototype.close=function(e){var r;this.keepAliveHandler.close(),(r=this.rsocket.close)===null||r===void 0||r.call(this.rsocket,e)},t}();de.DefaultConnectionFrameHandler=Qc;var Ve;(function(t){t[t.Paused=0]="Paused",t[t.Running=1]="Running",t[t.Closed=2]="Closed"})(Ve||(Ve={}));var Gc=function(){function t(e,r){this.connection=e,this.keepAliveTimeoutDuration=r,this.state=Ve.Paused,this.outbound=e.multiplexerDemultiplexer.connectionOutbound}return t.prototype.handle=function(e){this.keepAliveLastReceivedMillis=Date.now(),te.Flags.hasRespond(e.flags)&&this.outbound.send({type:te.FrameTypes.KEEPALIVE,streamId:0,data:e.data,flags:e.flags^te.Flags.RESPOND,lastReceivedPosition:0})},t.prototype.start=function(){this.state===Ve.Paused&&(this.keepAliveLastReceivedMillis=Date.now(),this.state=Ve.Running,this.activeTimeout=setTimeout(this.timeoutCheck.bind(this),this.keepAliveTimeoutDuration))},t.prototype.pause=function(){this.state===Ve.Running&&(this.state=Ve.Paused,clearTimeout(this.activeTimeout))},t.prototype.close=function(){this.state=Ve.Closed,clearTimeout(this.activeTimeout)},t.prototype.timeoutCheck=function(){var e=Date.now(),r=e-this.keepAliveLastReceivedMillis;r>=this.keepAliveTimeoutDuration?this.connection.close(new Error("No keep-alive acks for ".concat(this.keepAliveTimeoutDuration," millis"))):this.activeTimeout=setTimeout(this.timeoutCheck.bind(this),Math.max(100,this.keepAliveTimeoutDuration-r))},t}();de.KeepAliveHandler=Gc;var Je;(function(t){t[t.Paused=0]="Paused",t[t.Running=1]="Running",t[t.Closed=2]="Closed"})(Je||(Je={}));var Yc=function(){function t(e,r){this.outbound=e,this.keepAlivePeriodDuration=r,this.state=Je.Paused}return t.prototype.sendKeepAlive=function(){this.outbound.send({type:te.FrameTypes.KEEPALIVE,streamId:0,data:void 0,flags:te.Flags.RESPOND,lastReceivedPosition:0})},t.prototype.start=function(){this.state===Je.Paused&&(this.state=Je.Running,this.activeInterval=setInterval(this.sendKeepAlive.bind(this),this.keepAlivePeriodDuration))},t.prototype.pause=function(){this.state===Je.Running&&(this.state=Je.Paused,clearInterval(this.activeInterval))},t.prototype.close=function(){this.state=Je.Closed,clearInterval(this.activeInterval)},t}();de.KeepAliveSender=Yc});var kn=P(Rt=>{"use strict";var Xc=Rt&&Rt.__values||function(t){var e=typeof Symbol=="function"&&Symbol.iterator,r=e&&t[e],n=0;if(r)return r.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Rt,"__esModule",{value:!0});Rt.FrameStore=void 0;var _o=wt(),Mn=Ln(),Kc=function(){function t(){this.storedFrames=[],this._lastReceivedFramePosition=0,this._firstAvailableFramePosition=0,this._lastSentFramePosition=0}return Object.defineProperty(t.prototype,"lastReceivedFramePosition",{get:function(){return this._lastReceivedFramePosition},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"firstAvailableFramePosition",{get:function(){return this._firstAvailableFramePosition},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lastSentFramePosition",{get:function(){return this._lastSentFramePosition},enumerable:!1,configurable:!0}),t.prototype.store=function(e){this._lastSentFramePosition+=(0,Mn.sizeOfFrame)(e),this.storedFrames.push(e)},t.prototype.record=function(e){this._lastReceivedFramePosition+=(0,Mn.sizeOfFrame)(e)},t.prototype.dropTo=function(e){for(var r=e-this._firstAvailableFramePosition;r>0&&this.storedFrames.length>0;){var n=this.storedFrames.shift();r-=(0,Mn.sizeOfFrame)(n)}if(r!==0)throw new _o.RSocketError(_o.ErrorCodes.CONNECTION_ERROR,"State inconsistency. Expected bytes to drop ".concat(e-this._firstAvailableFramePosition," but actual ").concat(r));this._firstAvailableFramePosition=e},t.prototype.drain=function(e){var r,n;try{for(var i=Xc(this.storedFrames),s=i.next();!s.done;s=i.next()){var o=s.value;e(o)}}catch(u){r={error:u}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}},t}();Rt.FrameStore=Kc});var No=P(Qe=>{"use strict";var vo=Qe&&Qe.__awaiter||function(t,e,r,n){function i(s){return s instanceof r?s:new r(function(o){o(s)})}return new(r||(r=Promise))(function(s,o){function u(c){try{a(n.next(c))}catch(h){o(h)}}function l(c){try{a(n.throw(c))}catch(h){o(h)}}function a(c){c.done?s(c.value):i(c.value).then(u,l)}a((n=n.apply(t,e||[])).next())})},Oo=Qe&&Qe.__generator||function(t,e){var r={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,o;return o={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function u(a){return function(c){return l([a,c])}}function l(a){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(s=a[0]&2?i.return:a[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,a[1])).done)return s;switch(i=0,s&&(a=[a[0]&2,s.value]),a[0]){case 0:case 1:s=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,i=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(s=r.trys,!(s=s.length>0&&s[s.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!s||a[1]>s[0]&&a[1]<s[3])){r.label=a[1];break}if(a[0]===6&&r.label<s[1]){r.label=s[1],s=a;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(a);break}s[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(c){a=[6,c],i=0}finally{n=s=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};Object.defineProperty(Qe,"__esModule",{value:!0});Qe.RSocketConnector=void 0;var Xt=Cn(),De=be(),_t=Un(),Zc=kn(),eh=function(){function t(e){this.config=e}return t.prototype.connect=function(){var e,r,n,i,s,o,u,l,a,c,h,d,p,m,w,F,A,O,V,_;return vo(this,void 0,void 0,function(){var B,N,v,$,U,I,f,g,b,k=this;return Oo(this,function(H){switch(H.label){case 0:return B=this.config,N={type:De.FrameTypes.SETUP,dataMimeType:(r=(e=B.setup)===null||e===void 0?void 0:e.dataMimeType)!==null&&r!==void 0?r:"application/octet-stream",metadataMimeType:(i=(n=B.setup)===null||n===void 0?void 0:n.metadataMimeType)!==null&&i!==void 0?i:"application/octet-stream",keepAlive:(o=(s=B.setup)===null||s===void 0?void 0:s.keepAlive)!==null&&o!==void 0?o:6e4,lifetime:(l=(u=B.setup)===null||u===void 0?void 0:u.lifetime)!==null&&l!==void 0?l:3e5,metadata:(c=(a=B.setup)===null||a===void 0?void 0:a.payload)===null||c===void 0?void 0:c.metadata,data:(d=(h=B.setup)===null||h===void 0?void 0:h.payload)===null||d===void 0?void 0:d.data,resumeToken:(m=(p=B.resume)===null||p===void 0?void 0:p.tokenGenerator())!==null&&m!==void 0?m:null,streamId:0,majorVersion:1,minorVersion:0,flags:(!((F=(w=B.setup)===null||w===void 0?void 0:w.payload)===null||F===void 0)&&F.metadata?De.Flags.METADATA:De.Flags.NONE)|(B.lease?De.Flags.LEASE:De.Flags.NONE)|(B.resume?De.Flags.RESUME_ENABLE:De.Flags.NONE)},[4,B.transport.connect(function(z){return B.resume?new Xt.ResumableClientServerInputMultiplexerDemultiplexer(Xt.StreamIdGenerator.create(-1),z,z,new Zc.FrameStore,N.resumeToken.toString(),function(ht,hr){return vo(k,void 0,void 0,function(){var ne,qe,hn;return Oo(this,function(Ii){switch(Ii.label){case 0:return ne=function(fn){return fn.send({type:De.FrameTypes.RESUME,streamId:0,flags:De.Flags.NONE,clientPosition:hr.firstAvailableFramePosition,serverPosition:hr.lastReceivedFramePosition,majorVersion:N.minorVersion,minorVersion:N.majorVersion,resumeToken:N.resumeToken}),new Xt.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer(fn,fn,ht)},qe=-1,hn=function(){return qe++,B.resume.reconnectFunction(qe).then(function(){return B.transport.connect(ne).catch(hn)})},[4,hn()];case 1:return Ii.sent(),[2]}})})}):new Xt.ClientServerInputMultiplexerDemultiplexer(Xt.StreamIdGenerator.create(-1),z,z)})];case 1:return v=H.sent(),$=new _t.KeepAliveSender(v.multiplexerDemultiplexer.connectionOutbound,N.keepAlive),U=new _t.KeepAliveHandler(v,N.lifetime),I=B.lease?new _t.LeaseHandler((A=B.lease.maxPendingRequests)!==null&&A!==void 0?A:256,v.multiplexerDemultiplexer):void 0,f=(O=B.responder)!==null&&O!==void 0?O:{},g=new _t.DefaultConnectionFrameHandler(v,U,$,I,f),b=new _t.DefaultStreamRequestHandler(f,0),v.onClose(function(z){$.close(),U.close(),g.close(z)}),v.multiplexerDemultiplexer.connectionInbound(g),v.multiplexerDemultiplexer.handleRequestStream(b),v.multiplexerDemultiplexer.connectionOutbound.send(N),U.start(),$.start(),[2,new _t.RSocketRequester(v,(_=(V=B.fragmentation)===null||V===void 0?void 0:V.maxOutboundFragmentSize)!==null&&_!==void 0?_:0,I)]}})})},t}();Qe.RSocketConnector=eh});var Fo=P(Ge=>{"use strict";var Ao=Ge&&Ge.__awaiter||function(t,e,r,n){function i(s){return s instanceof r?s:new r(function(o){o(s)})}return new(r||(r=Promise))(function(s,o){function u(c){try{a(n.next(c))}catch(h){o(h)}}function l(c){try{a(n.throw(c))}catch(h){o(h)}}function a(c){c.done?s(c.value):i(c.value).then(u,l)}a((n=n.apply(t,e||[])).next())})},Io=Ge&&Ge.__generator||function(t,e){var r={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,o;return o={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function u(a){return function(c){return l([a,c])}}function l(a){if(n)throw new TypeError("Generator is already executing.");for(;r;)try{if(n=1,i&&(s=a[0]&2?i.return:a[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,a[1])).done)return s;switch(i=0,s&&(a=[a[0]&2,s.value]),a[0]){case 0:case 1:s=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,i=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(s=r.trys,!(s=s.length>0&&s[s.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!s||a[1]>s[0]&&a[1]<s[3])){r.label=a[1];break}if(a[0]===6&&r.label<s[1]){r.label=s[1],s=a;break}if(s&&r.label<s[2]){r.label=s[2],r.ops.push(a);break}s[2]&&r.ops.pop(),r.trys.pop();continue}a=e.call(t,r)}catch(c){a=[6,c],i=0}finally{n=s=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};Object.defineProperty(Ge,"__esModule",{value:!0});Ge.RSocketServer=void 0;var qr=Cn(),ie=Ce(),G=be(),vt=Un(),th=kn(),rh=function(){function t(e){var r,n;this.acceptor=e.acceptor,this.transport=e.transport,this.lease=e.lease,this.serverSideKeepAlive=e.serverSideKeepAlive,this.sessionStore=e.resume?{}:void 0,this.sessionTimeout=(n=(r=e.resume)===null||r===void 0?void 0:r.sessionTimeout)!==null&&n!==void 0?n:void 0}return t.prototype.bind=function(){return Ao(this,void 0,void 0,function(){var e=this;return Io(this,function(r){switch(r.label){case 0:return[4,this.transport.bind(function(n,i){return Ao(e,void 0,void 0,function(){var s,o,o,u,l,a,c,h,d,p,m,w,F,A,O;return Io(this,function(V){switch(V.label){case 0:switch(s=n.type,s){case G.FrameTypes.SETUP:return[3,1];case G.FrameTypes.RESUME:return[3,5]}return[3,6];case 1:return V.trys.push([1,3,,4]),this.lease&&!G.Flags.hasLease(n.flags)?(o=new ie.RSocketError(ie.ErrorCodes.REJECTED_SETUP,"Lease has to be enabled"),i.multiplexerDemultiplexer.connectionOutbound.send({type:G.FrameTypes.ERROR,streamId:0,flags:G.Flags.NONE,code:o.code,message:o.message}),i.close(o),[2]):G.Flags.hasLease(n.flags)&&!this.lease?(o=new ie.RSocketError(ie.ErrorCodes.REJECTED_SETUP,"Lease has to be disabled"),i.multiplexerDemultiplexer.connectionOutbound.send({type:G.FrameTypes.ERROR,streamId:0,flags:G.Flags.NONE,code:o.code,message:o.message}),i.close(o),[2]):(u=G.Flags.hasLease(n.flags)?new vt.LeaseHandler((w=this.lease.maxPendingRequests)!==null&&w!==void 0?w:256,i.multiplexerDemultiplexer):void 0,l=new vt.RSocketRequester(i,(A=(F=this.fragmentation)===null||F===void 0?void 0:F.maxOutboundFragmentSize)!==null&&A!==void 0?A:0,u),[4,this.acceptor.accept({data:n.data,dataMimeType:n.dataMimeType,metadata:n.metadata,metadataMimeType:n.metadataMimeType,flags:n.flags,keepAliveMaxLifetime:n.lifetime,keepAliveInterval:n.keepAlive,resumeToken:n.resumeToken},l)]);case 2:return a=V.sent(),c=new vt.KeepAliveHandler(i,n.lifetime),h=this.serverSideKeepAlive?new vt.KeepAliveSender(i.multiplexerDemultiplexer.connectionOutbound,n.keepAlive):void 0,d=new vt.DefaultConnectionFrameHandler(i,c,h,u,a),p=new vt.DefaultStreamRequestHandler(a,0),i.onClose(function(_){h?.close(),c.close(),d.close(_)}),i.multiplexerDemultiplexer.connectionInbound(d),i.multiplexerDemultiplexer.handleRequestStream(p),c.start(),h?.start(),[3,4];case 3:return m=V.sent(),i.multiplexerDemultiplexer.connectionOutbound.send({type:G.FrameTypes.ERROR,streamId:0,code:ie.ErrorCodes.REJECTED_SETUP,message:(O=m.message)!==null&&O!==void 0?O:"",flags:G.Flags.NONE}),i.close(m instanceof ie.RSocketError?m:new ie.RSocketError(ie.ErrorCodes.REJECTED_SETUP,m.message)),[3,4];case 4:return[2];case 5:return[2];case 6:i.multiplexerDemultiplexer.connectionOutbound.send({type:G.FrameTypes.ERROR,streamId:0,code:ie.ErrorCodes.UNSUPPORTED_SETUP,message:"Unsupported setup",flags:G.Flags.NONE}),i.close(new ie.RSocketError(ie.ErrorCodes.UNSUPPORTED_SETUP)),V.label=7;case 7:return[2]}})})},function(n,i){if(n.type===G.FrameTypes.RESUME){if(e.sessionStore){var s=e.sessionStore[n.resumeToken.toString()];if(!s){i.send({type:G.FrameTypes.ERROR,streamId:0,code:ie.ErrorCodes.REJECTED_RESUME,message:"No session found for the given resume token",flags:G.Flags.NONE}),i.close();return}return s.resume(n,i,i),s}i.send({type:G.FrameTypes.ERROR,streamId:0,code:ie.ErrorCodes.REJECTED_RESUME,message:"Resume is not enabled",flags:G.Flags.NONE}),i.close();return}else if(n.type===G.FrameTypes.SETUP&&G.Flags.hasResume(n.flags)){if(!e.sessionStore){var o=new ie.RSocketError(ie.ErrorCodes.REJECTED_SETUP,"No resume support");i.send({type:G.FrameTypes.ERROR,streamId:0,flags:G.Flags.NONE,code:o.code,message:o.message}),i.close(o);return}var u=new qr.ResumableClientServerInputMultiplexerDemultiplexer(qr.StreamIdGenerator.create(0),i,i,new th.FrameStore,n.resumeToken.toString(),e.sessionStore,e.sessionTimeout);return e.sessionStore[n.resumeToken.toString()]=u,u}return new qr.ClientServerInputMultiplexerDemultiplexer(qr.StreamIdGenerator.create(0),i,i)})];case 1:return[2,r.sent()]}})})},t}();Ge.RSocketServer=rh});var Lo=P(xo=>{"use strict";Object.defineProperty(xo,"__esModule",{value:!0})});var wt=P(se=>{"use strict";var nh=se&&se.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),Ue=se&&se.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&nh(e,t,r)};Object.defineProperty(se,"__esModule",{value:!0});Ue(Ln(),se);Ue(io(),se);Ue(Bn(),se);Ue(Ce(),se);Ue(be(),se);Ue(ao(),se);Ue(No(),se);Ue(Fo(),se);Ue(Lo(),se)});var Co=P(Ot=>{"use strict";var ih=Ot&&Ot.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(n[s]=i[s])},t(e,r)};return function(e,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r);function n(){this.constructor=e}e.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(Ot,"__esModule",{value:!0});Ot.WebsocketDuplexConnection=void 0;var Bo=wt(),sh=function(t){ih(e,t);function e(r,n,i){var s=t.call(this)||this;return s.websocket=r,s.deserializer=n,s.handleClosed=function(o){s.close(new Error(o.reason||"WebsocketDuplexConnection: Socket closed unexpectedly."))},s.handleError=function(o){s.close(o.error)},s.handleMessage=function(o){try{var u=Buffer.from(o.data),l=s.deserializer.deserializeFrame(u);s.multiplexerDemultiplexer.handle(l)}catch(a){s.close(a)}},r.addEventListener("close",s.handleClosed),r.addEventListener("error",s.handleError),r.addEventListener("message",s.handleMessage),s.multiplexerDemultiplexer=i(s),s}return Object.defineProperty(e.prototype,"availability",{get:function(){return this.done?0:1},enumerable:!1,configurable:!0}),e.prototype.close=function(r){if(this.done){t.prototype.close.call(this,r);return}this.websocket.removeEventListener("close",this.handleClosed),this.websocket.removeEventListener("error",this.handleError),this.websocket.removeEventListener("message",this.handleMessage),this.websocket.close(),delete this.websocket,t.prototype.close.call(this,r)},e.prototype.send=function(r){if(!this.done){var n=(0,Bo.serializeFrame)(r);this.websocket.send(n)}},e}(Bo.Deferred);Ot.WebsocketDuplexConnection=sh});var Do=P($r=>{"use strict";Object.defineProperty($r,"__esModule",{value:!0});$r.WebsocketClientTransport=void 0;var oh=wt(),ah=Co(),lh=function(){function t(e){var r;this.url=e.url,this.factory=(r=e.wsCreator)!==null&&r!==void 0?r:function(n){return new WebSocket(n)}}return t.prototype.connect=function(e){var r=this;return new Promise(function(n,i){var s=r.factory(r.url);s.binaryType="arraybuffer";var o=function(){s.removeEventListener("open",o),s.removeEventListener("error",u),n(new ah.WebsocketDuplexConnection(s,new oh.Deserializer,e))},u=function(l){s.removeEventListener("open",o),s.removeEventListener("error",u),i(l.error)};s.addEventListener("open",o),s.addEventListener("error",u)})},t}();$r.WebsocketClientTransport=lh});var Uo=P(rt=>{"use strict";var uh=rt&&rt.__createBinding||(Object.create?function(t,e,r,n){n===void 0&&(n=r),Object.defineProperty(t,n,{enumerable:!0,get:function(){return e[r]}})}:function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]}),ch=rt&&rt.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&uh(e,t,r)};Object.defineProperty(rt,"__esModule",{value:!0});ch(Do(),rt)});var va=P(Zr=>{"use strict";Zr.byteLength=rf;Zr.toByteArray=sf;Zr.fromByteArray=lf;var xe=[],Re=[],tf=typeof Uint8Array<"u"?Uint8Array:Array,gi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(lt=0,Ra=gi.length;lt<Ra;++lt)xe[lt]=gi[lt],Re[gi.charCodeAt(lt)]=lt;var lt,Ra;Re[45]=62;Re[95]=63;function _a(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=t.indexOf("=");r===-1&&(r=e);var n=r===e?0:4-r%4;return[r,n]}function rf(t){var e=_a(t),r=e[0],n=e[1];return(r+n)*3/4-n}function nf(t,e,r){return(e+r)*3/4-r}function sf(t){var e,r=_a(t),n=r[0],i=r[1],s=new tf(nf(t,n,i)),o=0,u=i>0?n-4:n,l;for(l=0;l<u;l+=4)e=Re[t.charCodeAt(l)]<<18|Re[t.charCodeAt(l+1)]<<12|Re[t.charCodeAt(l+2)]<<6|Re[t.charCodeAt(l+3)],s[o++]=e>>16&255,s[o++]=e>>8&255,s[o++]=e&255;return i===2&&(e=Re[t.charCodeAt(l)]<<2|Re[t.charCodeAt(l+1)]>>4,s[o++]=e&255),i===1&&(e=Re[t.charCodeAt(l)]<<10|Re[t.charCodeAt(l+1)]<<4|Re[t.charCodeAt(l+2)]>>2,s[o++]=e>>8&255,s[o++]=e&255),s}function of(t){return xe[t>>18&63]+xe[t>>12&63]+xe[t>>6&63]+xe[t&63]}function af(t,e,r){for(var n,i=[],s=e;s<r;s+=3)n=(t[s]<<16&16711680)+(t[s+1]<<8&65280)+(t[s+2]&255),i.push(of(n));return i.join("")}function lf(t){for(var e,r=t.length,n=r%3,i=[],s=16383,o=0,u=r-n;o<u;o+=s)i.push(af(t,o,o+s>u?u:o+s));return n===1?(e=t[r-1],i.push(xe[e>>2]+xe[e<<4&63]+"==")):n===2&&(e=(t[r-2]<<8)+t[r-1],i.push(xe[e>>10]+xe[e>>4&63]+xe[e<<2&63]+"=")),i.join("")}});var Oa=P(yi=>{yi.read=function(t,e,r,n,i){var s,o,u=i*8-n-1,l=(1<<u)-1,a=l>>1,c=-7,h=r?i-1:0,d=r?-1:1,p=t[e+h];for(h+=d,s=p&(1<<-c)-1,p>>=-c,c+=u;c>0;s=s*256+t[e+h],h+=d,c-=8);for(o=s&(1<<-c)-1,s>>=-c,c+=n;c>0;o=o*256+t[e+h],h+=d,c-=8);if(s===0)s=1-a;else{if(s===l)return o?NaN:(p?-1:1)*(1/0);o=o+Math.pow(2,n),s=s-a}return(p?-1:1)*o*Math.pow(2,s-n)};yi.write=function(t,e,r,n,i,s){var o,u,l,a=s*8-i-1,c=(1<<a)-1,h=c>>1,d=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:s-1,m=n?1:-1,w=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(u=isNaN(e)?1:0,o=c):(o=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-o))<1&&(o--,l*=2),o+h>=1?e+=d/l:e+=d*Math.pow(2,1-h),e*l>=2&&(o++,l/=2),o+h>=c?(u=0,o=c):o+h>=1?(u=(e*l-1)*Math.pow(2,i),o=o+h):(u=e*Math.pow(2,h-1)*Math.pow(2,i),o=0));i>=8;t[r+p]=u&255,p+=m,u/=256,i-=8);for(o=o<<i|u,a+=i;a>0;t[r+p]=o&255,p+=m,o/=256,a-=8);t[r+p-m]|=w*128}});var Oi=P(Pt=>{"use strict";var Ei=va(),Mt=Oa(),Na=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;Pt.Buffer=y;Pt.SlowBuffer=pf;Pt.INSPECT_MAX_BYTES=50;var en=2147483647;Pt.kMaxLength=en;y.TYPED_ARRAY_SUPPORT=uf();!y.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function uf(){try{let t=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(t,e),t.foo()===42}catch{return!1}}Object.defineProperty(y.prototype,"parent",{enumerable:!0,get:function(){if(y.isBuffer(this))return this.buffer}});Object.defineProperty(y.prototype,"offset",{enumerable:!0,get:function(){if(y.isBuffer(this))return this.byteOffset}});function ke(t){if(t>en)throw new RangeError('The value "'+t+'" is invalid for option "size"');let e=new Uint8Array(t);return Object.setPrototypeOf(e,y.prototype),e}function y(t,e,r){if(typeof t=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return Ti(t)}return xa(t,e,r)}y.poolSize=8192;function xa(t,e,r){if(typeof t=="string")return hf(t,e);if(ArrayBuffer.isView(t))return ff(t);if(t==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(Le(t,ArrayBuffer)||t&&Le(t.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Le(t,SharedArrayBuffer)||t&&Le(t.buffer,SharedArrayBuffer)))return Si(t,e,r);if(typeof t=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let n=t.valueOf&&t.valueOf();if(n!=null&&n!==t)return y.from(n,e,r);let i=df(t);if(i)return i;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof t[Symbol.toPrimitive]=="function")return y.from(t[Symbol.toPrimitive]("string"),e,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}y.from=function(t,e,r){return xa(t,e,r)};Object.setPrototypeOf(y.prototype,Uint8Array.prototype);Object.setPrototypeOf(y,Uint8Array);function La(t){if(typeof t!="number")throw new TypeError('"size" argument must be of type number');if(t<0)throw new RangeError('The value "'+t+'" is invalid for option "size"')}function cf(t,e,r){return La(t),t<=0?ke(t):e!==void 0?typeof r=="string"?ke(t).fill(e,r):ke(t).fill(e):ke(t)}y.alloc=function(t,e,r){return cf(t,e,r)};function Ti(t){return La(t),ke(t<0?0:Ri(t)|0)}y.allocUnsafe=function(t){return Ti(t)};y.allocUnsafeSlow=function(t){return Ti(t)};function hf(t,e){if((typeof e!="string"||e==="")&&(e="utf8"),!y.isEncoding(e))throw new TypeError("Unknown encoding: "+e);let r=Ba(t,e)|0,n=ke(r),i=n.write(t,e);return i!==r&&(n=n.slice(0,i)),n}function wi(t){let e=t.length<0?0:Ri(t.length)|0,r=ke(e);for(let n=0;n<e;n+=1)r[n]=t[n]&255;return r}function ff(t){if(Le(t,Uint8Array)){let e=new Uint8Array(t);return Si(e.buffer,e.byteOffset,e.byteLength)}return wi(t)}function Si(t,e,r){if(e<0||t.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(t.byteLength<e+(r||0))throw new RangeError('"length" is outside of buffer bounds');let n;return e===void 0&&r===void 0?n=new Uint8Array(t):r===void 0?n=new Uint8Array(t,e):n=new Uint8Array(t,e,r),Object.setPrototypeOf(n,y.prototype),n}function df(t){if(y.isBuffer(t)){let e=Ri(t.length)|0,r=ke(e);return r.length===0||t.copy(r,0,0,e),r}if(t.length!==void 0)return typeof t.length!="number"||vi(t.length)?ke(0):wi(t);if(t.type==="Buffer"&&Array.isArray(t.data))return wi(t.data)}function Ri(t){if(t>=en)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+en.toString(16)+" bytes");return t|0}function pf(t){return+t!=t&&(t=0),y.alloc(+t)}y.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==y.prototype};y.compare=function(e,r){if(Le(e,Uint8Array)&&(e=y.from(e,e.offset,e.byteLength)),Le(r,Uint8Array)&&(r=y.from(r,r.offset,r.byteLength)),!y.isBuffer(e)||!y.isBuffer(r))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===r)return 0;let n=e.length,i=r.length;for(let s=0,o=Math.min(n,i);s<o;++s)if(e[s]!==r[s]){n=e[s],i=r[s];break}return n<i?-1:i<n?1:0};y.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}};y.concat=function(e,r){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return y.alloc(0);let n;if(r===void 0)for(r=0,n=0;n<e.length;++n)r+=e[n].length;let i=y.allocUnsafe(r),s=0;for(n=0;n<e.length;++n){let o=e[n];if(Le(o,Uint8Array))s+o.length>i.length?(y.isBuffer(o)||(o=y.from(o)),o.copy(i,s)):Uint8Array.prototype.set.call(i,o,s);else if(y.isBuffer(o))o.copy(i,s);else throw new TypeError('"list" argument must be an Array of Buffers');s+=o.length}return i};function Ba(t,e){if(y.isBuffer(t))return t.length;if(ArrayBuffer.isView(t)||Le(t,ArrayBuffer))return t.byteLength;if(typeof t!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof t);let r=t.length,n=arguments.length>2&&arguments[2]===!0;if(!n&&r===0)return 0;let i=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return bi(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return r*2;case"hex":return r>>>1;case"base64":return ja(t).length;default:if(i)return n?-1:bi(t).length;e=(""+e).toLowerCase(),i=!0}}y.byteLength=Ba;function mf(t,e,r){let n=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((r===void 0||r>this.length)&&(r=this.length),r<=0)||(r>>>=0,e>>>=0,r<=e))return"";for(t||(t="utf8");;)switch(t){case"hex":return vf(this,e,r);case"utf8":case"utf-8":return Da(this,e,r);case"ascii":return Rf(this,e,r);case"latin1":case"binary":return _f(this,e,r);case"base64":return bf(this,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Of(this,e,r);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}y.prototype._isBuffer=!0;function ut(t,e,r){let n=t[e];t[e]=t[r],t[r]=n}y.prototype.swap16=function(){let e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let r=0;r<e;r+=2)ut(this,r,r+1);return this};y.prototype.swap32=function(){let e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let r=0;r<e;r+=4)ut(this,r,r+3),ut(this,r+1,r+2);return this};y.prototype.swap64=function(){let e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let r=0;r<e;r+=8)ut(this,r,r+7),ut(this,r+1,r+6),ut(this,r+2,r+5),ut(this,r+3,r+4);return this};y.prototype.toString=function(){let e=this.length;return e===0?"":arguments.length===0?Da(this,0,e):mf.apply(this,arguments)};y.prototype.toLocaleString=y.prototype.toString;y.prototype.equals=function(e){if(!y.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:y.compare(this,e)===0};y.prototype.inspect=function(){let e="",r=Pt.INSPECT_MAX_BYTES;return e=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(e+=" ... "),"<Buffer "+e+">"};Na&&(y.prototype[Na]=y.prototype.inspect);y.prototype.compare=function(e,r,n,i,s){if(Le(e,Uint8Array)&&(e=y.from(e,e.offset,e.byteLength)),!y.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(r===void 0&&(r=0),n===void 0&&(n=e?e.length:0),i===void 0&&(i=0),s===void 0&&(s=this.length),r<0||n>e.length||i<0||s>this.length)throw new RangeError("out of range index");if(i>=s&&r>=n)return 0;if(i>=s)return-1;if(r>=n)return 1;if(r>>>=0,n>>>=0,i>>>=0,s>>>=0,this===e)return 0;let o=s-i,u=n-r,l=Math.min(o,u),a=this.slice(i,s),c=e.slice(r,n);for(let h=0;h<l;++h)if(a[h]!==c[h]){o=a[h],u=c[h];break}return o<u?-1:u<o?1:0};function Ca(t,e,r,n,i){if(t.length===0)return-1;if(typeof r=="string"?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,vi(r)&&(r=i?0:t.length-1),r<0&&(r=t.length+r),r>=t.length){if(i)return-1;r=t.length-1}else if(r<0)if(i)r=0;else return-1;if(typeof e=="string"&&(e=y.from(e,n)),y.isBuffer(e))return e.length===0?-1:Aa(t,e,r,n,i);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?i?Uint8Array.prototype.indexOf.call(t,e,r):Uint8Array.prototype.lastIndexOf.call(t,e,r):Aa(t,[e],r,n,i);throw new TypeError("val must be string, number or Buffer")}function Aa(t,e,r,n,i){let s=1,o=t.length,u=e.length;if(n!==void 0&&(n=String(n).toLowerCase(),n==="ucs2"||n==="ucs-2"||n==="utf16le"||n==="utf-16le")){if(t.length<2||e.length<2)return-1;s=2,o/=2,u/=2,r/=2}function l(c,h){return s===1?c[h]:c.readUInt16BE(h*s)}let a;if(i){let c=-1;for(a=r;a<o;a++)if(l(t,a)===l(e,c===-1?0:a-c)){if(c===-1&&(c=a),a-c+1===u)return c*s}else c!==-1&&(a-=a-c),c=-1}else for(r+u>o&&(r=o-u),a=r;a>=0;a--){let c=!0;for(let h=0;h<u;h++)if(l(t,a+h)!==l(e,h)){c=!1;break}if(c)return a}return-1}y.prototype.includes=function(e,r,n){return this.indexOf(e,r,n)!==-1};y.prototype.indexOf=function(e,r,n){return Ca(this,e,r,n,!0)};y.prototype.lastIndexOf=function(e,r,n){return Ca(this,e,r,n,!1)};function gf(t,e,r,n){r=Number(r)||0;let i=t.length-r;n?(n=Number(n),n>i&&(n=i)):n=i;let s=e.length;n>s/2&&(n=s/2);let o;for(o=0;o<n;++o){let u=parseInt(e.substr(o*2,2),16);if(vi(u))return o;t[r+o]=u}return o}function yf(t,e,r,n){return tn(bi(e,t.length-r),t,r,n)}function Ef(t,e,r,n){return tn(Ff(e),t,r,n)}function wf(t,e,r,n){return tn(ja(e),t,r,n)}function Sf(t,e,r,n){return tn(xf(e,t.length-r),t,r,n)}y.prototype.write=function(e,r,n,i){if(r===void 0)i="utf8",n=this.length,r=0;else if(n===void 0&&typeof r=="string")i=r,n=this.length,r=0;else if(isFinite(r))r=r>>>0,isFinite(n)?(n=n>>>0,i===void 0&&(i="utf8")):(i=n,n=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let s=this.length-r;if((n===void 0||n>s)&&(n=s),e.length>0&&(n<0||r<0)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");i||(i="utf8");let o=!1;for(;;)switch(i){case"hex":return gf(this,e,r,n);case"utf8":case"utf-8":return yf(this,e,r,n);case"ascii":case"latin1":case"binary":return Ef(this,e,r,n);case"base64":return wf(this,e,r,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Sf(this,e,r,n);default:if(o)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),o=!0}};y.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function bf(t,e,r){return e===0&&r===t.length?Ei.fromByteArray(t):Ei.fromByteArray(t.slice(e,r))}function Da(t,e,r){r=Math.min(t.length,r);let n=[],i=e;for(;i<r;){let s=t[i],o=null,u=s>239?4:s>223?3:s>191?2:1;if(i+u<=r){let l,a,c,h;switch(u){case 1:s<128&&(o=s);break;case 2:l=t[i+1],(l&192)===128&&(h=(s&31)<<6|l&63,h>127&&(o=h));break;case 3:l=t[i+1],a=t[i+2],(l&192)===128&&(a&192)===128&&(h=(s&15)<<12|(l&63)<<6|a&63,h>2047&&(h<55296||h>57343)&&(o=h));break;case 4:l=t[i+1],a=t[i+2],c=t[i+3],(l&192)===128&&(a&192)===128&&(c&192)===128&&(h=(s&15)<<18|(l&63)<<12|(a&63)<<6|c&63,h>65535&&h<1114112&&(o=h))}}o===null?(o=65533,u=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|o&1023),n.push(o),i+=u}return Tf(n)}var Ia=4096;function Tf(t){let e=t.length;if(e<=Ia)return String.fromCharCode.apply(String,t);let r="",n=0;for(;n<e;)r+=String.fromCharCode.apply(String,t.slice(n,n+=Ia));return r}function Rf(t,e,r){let n="";r=Math.min(t.length,r);for(let i=e;i<r;++i)n+=String.fromCharCode(t[i]&127);return n}function _f(t,e,r){let n="";r=Math.min(t.length,r);for(let i=e;i<r;++i)n+=String.fromCharCode(t[i]);return n}function vf(t,e,r){let n=t.length;(!e||e<0)&&(e=0),(!r||r<0||r>n)&&(r=n);let i="";for(let s=e;s<r;++s)i+=Lf[t[s]];return i}function Of(t,e,r){let n=t.slice(e,r),i="";for(let s=0;s<n.length-1;s+=2)i+=String.fromCharCode(n[s]+n[s+1]*256);return i}y.prototype.slice=function(e,r){let n=this.length;e=~~e,r=r===void 0?n:~~r,e<0?(e+=n,e<0&&(e=0)):e>n&&(e=n),r<0?(r+=n,r<0&&(r=0)):r>n&&(r=n),r<e&&(r=e);let i=this.subarray(e,r);return Object.setPrototypeOf(i,y.prototype),i};function K(t,e,r){if(t%1!==0||t<0)throw new RangeError("offset is not uint");if(t+e>r)throw new RangeError("Trying to access beyond buffer length")}y.prototype.readUintLE=y.prototype.readUIntLE=function(e,r,n){e=e>>>0,r=r>>>0,n||K(e,r,this.length);let i=this[e],s=1,o=0;for(;++o<r&&(s*=256);)i+=this[e+o]*s;return i};y.prototype.readUintBE=y.prototype.readUIntBE=function(e,r,n){e=e>>>0,r=r>>>0,n||K(e,r,this.length);let i=this[e+--r],s=1;for(;r>0&&(s*=256);)i+=this[e+--r]*s;return i};y.prototype.readUint8=y.prototype.readUInt8=function(e,r){return e=e>>>0,r||K(e,1,this.length),this[e]};y.prototype.readUint16LE=y.prototype.readUInt16LE=function(e,r){return e=e>>>0,r||K(e,2,this.length),this[e]|this[e+1]<<8};y.prototype.readUint16BE=y.prototype.readUInt16BE=function(e,r){return e=e>>>0,r||K(e,2,this.length),this[e]<<8|this[e+1]};y.prototype.readUint32LE=y.prototype.readUInt32LE=function(e,r){return e=e>>>0,r||K(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216};y.prototype.readUint32BE=y.prototype.readUInt32BE=function(e,r){return e=e>>>0,r||K(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])};y.prototype.readBigUInt64LE=Ke(function(e){e=e>>>0,kt(e,"offset");let r=this[e],n=this[e+7];(r===void 0||n===void 0)&&ur(e,this.length-8);let i=r+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,s=this[++e]+this[++e]*2**8+this[++e]*2**16+n*2**24;return BigInt(i)+(BigInt(s)<<BigInt(32))});y.prototype.readBigUInt64BE=Ke(function(e){e=e>>>0,kt(e,"offset");let r=this[e],n=this[e+7];(r===void 0||n===void 0)&&ur(e,this.length-8);let i=r*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],s=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+n;return(BigInt(i)<<BigInt(32))+BigInt(s)});y.prototype.readIntLE=function(e,r,n){e=e>>>0,r=r>>>0,n||K(e,r,this.length);let i=this[e],s=1,o=0;for(;++o<r&&(s*=256);)i+=this[e+o]*s;return s*=128,i>=s&&(i-=Math.pow(2,8*r)),i};y.prototype.readIntBE=function(e,r,n){e=e>>>0,r=r>>>0,n||K(e,r,this.length);let i=r,s=1,o=this[e+--i];for(;i>0&&(s*=256);)o+=this[e+--i]*s;return s*=128,o>=s&&(o-=Math.pow(2,8*r)),o};y.prototype.readInt8=function(e,r){return e=e>>>0,r||K(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]};y.prototype.readInt16LE=function(e,r){e=e>>>0,r||K(e,2,this.length);let n=this[e]|this[e+1]<<8;return n&32768?n|4294901760:n};y.prototype.readInt16BE=function(e,r){e=e>>>0,r||K(e,2,this.length);let n=this[e+1]|this[e]<<8;return n&32768?n|4294901760:n};y.prototype.readInt32LE=function(e,r){return e=e>>>0,r||K(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24};y.prototype.readInt32BE=function(e,r){return e=e>>>0,r||K(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]};y.prototype.readBigInt64LE=Ke(function(e){e=e>>>0,kt(e,"offset");let r=this[e],n=this[e+7];(r===void 0||n===void 0)&&ur(e,this.length-8);let i=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(n<<24);return(BigInt(i)<<BigInt(32))+BigInt(r+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)});y.prototype.readBigInt64BE=Ke(function(e){e=e>>>0,kt(e,"offset");let r=this[e],n=this[e+7];(r===void 0||n===void 0)&&ur(e,this.length-8);let i=(r<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(i)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+n)});y.prototype.readFloatLE=function(e,r){return e=e>>>0,r||K(e,4,this.length),Mt.read(this,e,!0,23,4)};y.prototype.readFloatBE=function(e,r){return e=e>>>0,r||K(e,4,this.length),Mt.read(this,e,!1,23,4)};y.prototype.readDoubleLE=function(e,r){return e=e>>>0,r||K(e,8,this.length),Mt.read(this,e,!0,52,8)};y.prototype.readDoubleBE=function(e,r){return e=e>>>0,r||K(e,8,this.length),Mt.read(this,e,!1,52,8)};function me(t,e,r,n,i,s){if(!y.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>i||e<s)throw new RangeError('"value" argument is out of bounds');if(r+n>t.length)throw new RangeError("Index out of range")}y.prototype.writeUintLE=y.prototype.writeUIntLE=function(e,r,n,i){if(e=+e,r=r>>>0,n=n>>>0,!i){let u=Math.pow(2,8*n)-1;me(this,e,r,n,u,0)}let s=1,o=0;for(this[r]=e&255;++o<n&&(s*=256);)this[r+o]=e/s&255;return r+n};y.prototype.writeUintBE=y.prototype.writeUIntBE=function(e,r,n,i){if(e=+e,r=r>>>0,n=n>>>0,!i){let u=Math.pow(2,8*n)-1;me(this,e,r,n,u,0)}let s=n-1,o=1;for(this[r+s]=e&255;--s>=0&&(o*=256);)this[r+s]=e/o&255;return r+n};y.prototype.writeUint8=y.prototype.writeUInt8=function(e,r,n){return e=+e,r=r>>>0,n||me(this,e,r,1,255,0),this[r]=e&255,r+1};y.prototype.writeUint16LE=y.prototype.writeUInt16LE=function(e,r,n){return e=+e,r=r>>>0,n||me(this,e,r,2,65535,0),this[r]=e&255,this[r+1]=e>>>8,r+2};y.prototype.writeUint16BE=y.prototype.writeUInt16BE=function(e,r,n){return e=+e,r=r>>>0,n||me(this,e,r,2,65535,0),this[r]=e>>>8,this[r+1]=e&255,r+2};y.prototype.writeUint32LE=y.prototype.writeUInt32LE=function(e,r,n){return e=+e,r=r>>>0,n||me(this,e,r,4,4294967295,0),this[r+3]=e>>>24,this[r+2]=e>>>16,this[r+1]=e>>>8,this[r]=e&255,r+4};y.prototype.writeUint32BE=y.prototype.writeUInt32BE=function(e,r,n){return e=+e,r=r>>>0,n||me(this,e,r,4,4294967295,0),this[r]=e>>>24,this[r+1]=e>>>16,this[r+2]=e>>>8,this[r+3]=e&255,r+4};function Ua(t,e,r,n,i){$a(e,n,i,t,r,7);let s=Number(e&BigInt(4294967295));t[r++]=s,s=s>>8,t[r++]=s,s=s>>8,t[r++]=s,s=s>>8,t[r++]=s;let o=Number(e>>BigInt(32)&BigInt(4294967295));return t[r++]=o,o=o>>8,t[r++]=o,o=o>>8,t[r++]=o,o=o>>8,t[r++]=o,r}function Ma(t,e,r,n,i){$a(e,n,i,t,r,7);let s=Number(e&BigInt(4294967295));t[r+7]=s,s=s>>8,t[r+6]=s,s=s>>8,t[r+5]=s,s=s>>8,t[r+4]=s;let o=Number(e>>BigInt(32)&BigInt(4294967295));return t[r+3]=o,o=o>>8,t[r+2]=o,o=o>>8,t[r+1]=o,o=o>>8,t[r]=o,r+8}y.prototype.writeBigUInt64LE=Ke(function(e,r=0){return Ua(this,e,r,BigInt(0),BigInt("0xffffffffffffffff"))});y.prototype.writeBigUInt64BE=Ke(function(e,r=0){return Ma(this,e,r,BigInt(0),BigInt("0xffffffffffffffff"))});y.prototype.writeIntLE=function(e,r,n,i){if(e=+e,r=r>>>0,!i){let l=Math.pow(2,8*n-1);me(this,e,r,n,l-1,-l)}let s=0,o=1,u=0;for(this[r]=e&255;++s<n&&(o*=256);)e<0&&u===0&&this[r+s-1]!==0&&(u=1),this[r+s]=(e/o>>0)-u&255;return r+n};y.prototype.writeIntBE=function(e,r,n,i){if(e=+e,r=r>>>0,!i){let l=Math.pow(2,8*n-1);me(this,e,r,n,l-1,-l)}let s=n-1,o=1,u=0;for(this[r+s]=e&255;--s>=0&&(o*=256);)e<0&&u===0&&this[r+s+1]!==0&&(u=1),this[r+s]=(e/o>>0)-u&255;return r+n};y.prototype.writeInt8=function(e,r,n){return e=+e,r=r>>>0,n||me(this,e,r,1,127,-128),e<0&&(e=255+e+1),this[r]=e&255,r+1};y.prototype.writeInt16LE=function(e,r,n){return e=+e,r=r>>>0,n||me(this,e,r,2,32767,-32768),this[r]=e&255,this[r+1]=e>>>8,r+2};y.prototype.writeInt16BE=function(e,r,n){return e=+e,r=r>>>0,n||me(this,e,r,2,32767,-32768),this[r]=e>>>8,this[r+1]=e&255,r+2};y.prototype.writeInt32LE=function(e,r,n){return e=+e,r=r>>>0,n||me(this,e,r,4,2147483647,-2147483648),this[r]=e&255,this[r+1]=e>>>8,this[r+2]=e>>>16,this[r+3]=e>>>24,r+4};y.prototype.writeInt32BE=function(e,r,n){return e=+e,r=r>>>0,n||me(this,e,r,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[r]=e>>>24,this[r+1]=e>>>16,this[r+2]=e>>>8,this[r+3]=e&255,r+4};y.prototype.writeBigInt64LE=Ke(function(e,r=0){return Ua(this,e,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});y.prototype.writeBigInt64BE=Ke(function(e,r=0){return Ma(this,e,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ka(t,e,r,n,i,s){if(r+n>t.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function Pa(t,e,r,n,i){return e=+e,r=r>>>0,i||ka(t,e,r,4,34028234663852886e22,-34028234663852886e22),Mt.write(t,e,r,n,23,4),r+4}y.prototype.writeFloatLE=function(e,r,n){return Pa(this,e,r,!0,n)};y.prototype.writeFloatBE=function(e,r,n){return Pa(this,e,r,!1,n)};function qa(t,e,r,n,i){return e=+e,r=r>>>0,i||ka(t,e,r,8,17976931348623157e292,-17976931348623157e292),Mt.write(t,e,r,n,52,8),r+8}y.prototype.writeDoubleLE=function(e,r,n){return qa(this,e,r,!0,n)};y.prototype.writeDoubleBE=function(e,r,n){return qa(this,e,r,!1,n)};y.prototype.copy=function(e,r,n,i){if(!y.isBuffer(e))throw new TypeError("argument should be a Buffer");if(n||(n=0),!i&&i!==0&&(i=this.length),r>=e.length&&(r=e.length),r||(r=0),i>0&&i<n&&(i=n),i===n||e.length===0||this.length===0)return 0;if(r<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length),e.length-r<i-n&&(i=e.length-r+n);let s=i-n;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(r,n,i):Uint8Array.prototype.set.call(e,this.subarray(n,i),r),s};y.prototype.fill=function(e,r,n,i){if(typeof e=="string"){if(typeof r=="string"?(i=r,r=0,n=this.length):typeof n=="string"&&(i=n,n=this.length),i!==void 0&&typeof i!="string")throw new TypeError("encoding must be a string");if(typeof i=="string"&&!y.isEncoding(i))throw new TypeError("Unknown encoding: "+i);if(e.length===1){let o=e.charCodeAt(0);(i==="utf8"&&o<128||i==="latin1")&&(e=o)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(r<0||this.length<r||this.length<n)throw new RangeError("Out of range index");if(n<=r)return this;r=r>>>0,n=n===void 0?this.length:n>>>0,e||(e=0);let s;if(typeof e=="number")for(s=r;s<n;++s)this[s]=e;else{let o=y.isBuffer(e)?e:y.from(e,i),u=o.length;if(u===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<n-r;++s)this[s+r]=o[s%u]}return this};var Ut={};function _i(t,e,r){Ut[t]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${t}]`,this.stack,delete this.name}get code(){return t}set code(i){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:i,writable:!0})}toString(){return`${this.name} [${t}]: ${this.message}`}}}_i("ERR_BUFFER_OUT_OF_BOUNDS",function(t){return t?`${t} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError);_i("ERR_INVALID_ARG_TYPE",function(t,e){return`The "${t}" argument must be of type number. Received type ${typeof e}`},TypeError);_i("ERR_OUT_OF_RANGE",function(t,e,r){let n=`The value of "${t}" is out of range.`,i=r;return Number.isInteger(r)&&Math.abs(r)>2**32?i=Fa(String(r)):typeof r=="bigint"&&(i=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(i=Fa(i)),i+="n"),n+=` It must be ${e}. Received ${i}`,n},RangeError);function Fa(t){let e="",r=t.length,n=t[0]==="-"?1:0;for(;r>=n+4;r-=3)e=`_${t.slice(r-3,r)}${e}`;return`${t.slice(0,r)}${e}`}function Nf(t,e,r){kt(e,"offset"),(t[e]===void 0||t[e+r]===void 0)&&ur(e,t.length-(r+1))}function $a(t,e,r,n,i,s){if(t>r||t<e){let o=typeof e=="bigint"?"n":"",u;throw s>3?e===0||e===BigInt(0)?u=`>= 0${o} and < 2${o} ** ${(s+1)*8}${o}`:u=`>= -(2${o} ** ${(s+1)*8-1}${o}) and < 2 ** ${(s+1)*8-1}${o}`:u=`>= ${e}${o} and <= ${r}${o}`,new Ut.ERR_OUT_OF_RANGE("value",u,t)}Nf(n,i,s)}function kt(t,e){if(typeof t!="number")throw new Ut.ERR_INVALID_ARG_TYPE(e,"number",t)}function ur(t,e,r){throw Math.floor(t)!==t?(kt(t,r),new Ut.ERR_OUT_OF_RANGE(r||"offset","an integer",t)):e<0?new Ut.ERR_BUFFER_OUT_OF_BOUNDS:new Ut.ERR_OUT_OF_RANGE(r||"offset",`>= ${r?1:0} and <= ${e}`,t)}var Af=/[^+/0-9A-Za-z-_]/g;function If(t){if(t=t.split("=")[0],t=t.trim().replace(Af,""),t.length<2)return"";for(;t.length%4!==0;)t=t+"=";return t}function bi(t,e){e=e||1/0;let r,n=t.length,i=null,s=[];for(let o=0;o<n;++o){if(r=t.charCodeAt(o),r>55295&&r<57344){if(!i){if(r>56319){(e-=3)>-1&&s.push(239,191,189);continue}else if(o+1===n){(e-=3)>-1&&s.push(239,191,189);continue}i=r;continue}if(r<56320){(e-=3)>-1&&s.push(239,191,189),i=r;continue}r=(i-55296<<10|r-56320)+65536}else i&&(e-=3)>-1&&s.push(239,191,189);if(i=null,r<128){if((e-=1)<0)break;s.push(r)}else if(r<2048){if((e-=2)<0)break;s.push(r>>6|192,r&63|128)}else if(r<65536){if((e-=3)<0)break;s.push(r>>12|224,r>>6&63|128,r&63|128)}else if(r<1114112){if((e-=4)<0)break;s.push(r>>18|240,r>>12&63|128,r>>6&63|128,r&63|128)}else throw new Error("Invalid code point")}return s}function Ff(t){let e=[];for(let r=0;r<t.length;++r)e.push(t.charCodeAt(r)&255);return e}function xf(t,e){let r,n,i,s=[];for(let o=0;o<t.length&&!((e-=2)<0);++o)r=t.charCodeAt(o),n=r>>8,i=r%256,s.push(i),s.push(n);return s}function ja(t){return Ei.toByteArray(If(t))}function tn(t,e,r,n){let i;for(i=0;i<n&&!(i+r>=e.length||i>=t.length);++i)e[i+r]=t[i];return i}function Le(t,e){return t instanceof e||t!=null&&t.constructor!=null&&t.constructor.name!=null&&t.constructor.name===e.name}function vi(t){return t!==t}var Lf=function(){let t="0123456789abcdef",e=new Array(256);for(let r=0;r<16;++r){let n=r*16;for(let i=0;i<16;++i)e[n+i]=t[r]+t[i]}return e}();function Ke(t){return typeof BigInt>"u"?Bf:t}function Bf(){throw new Error("BigInt not supported")}});var Li=Symbol("Comlink.proxy"),il=Symbol("Comlink.endpoint"),mn=Symbol("Comlink.releaseProxy"),dn=Symbol("Comlink.finalizer"),dr=Symbol("Comlink.thrown"),Bi=t=>typeof t=="object"&&t!==null||typeof t=="function",sl={canHandle:t=>Bi(t)&&t[Li],serialize(t){let{port1:e,port2:r}=new MessageChannel;return yr(t,e),[r,[r]]},deserialize(t){return t.start(),et(t)}},ol={canHandle:t=>Bi(t)&&dr in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},Ci=new Map([["proxy",sl],["throw",ol]]);function al(t,e){for(let r of t)if(e===r||r==="*"||r instanceof RegExp&&r.test(e))return!0;return!1}function yr(t,e=globalThis,r=["*"]){e.addEventListener("message",function n(i){if(!i||!i.data)return;if(!al(r,i.origin)){console.warn(`Invalid origin '${i.origin}' for comlink proxy`);return}let{id:s,type:o,path:u}=Object.assign({path:[]},i.data),l=(i.data.argumentList||[]).map(Ze),a;try{let c=u.slice(0,-1).reduce((d,p)=>d[p],t),h=u.reduce((d,p)=>d[p],t);switch(o){case"GET":a=h;break;case"SET":c[u.slice(-1)[0]]=Ze(i.data.value),a=!0;break;case"APPLY":a=h.apply(c,l);break;case"CONSTRUCT":{let d=new h(...l);a=gn(d)}break;case"ENDPOINT":{let{port1:d,port2:p}=new MessageChannel;yr(t,p),a=fl(d,[d])}break;case"RELEASE":a=void 0;break;default:return}}catch(c){a={value:c,[dr]:0}}Promise.resolve(a).catch(c=>({value:c,[dr]:0})).then(c=>{let[h,d]=gr(c);e.postMessage(Object.assign(Object.assign({},h),{id:s}),d),o==="RELEASE"&&(e.removeEventListener("message",n),Di(e),dn in t&&typeof t[dn]=="function"&&t[dn]())}).catch(c=>{let[h,d]=gr({value:new TypeError("Unserializable return value"),[dr]:0});e.postMessage(Object.assign(Object.assign({},h),{id:s}),d)})}),e.start&&e.start()}function ll(t){return t.constructor.name==="MessagePort"}function Di(t){ll(t)&&t.close()}function et(t,e){return pn(t,[],e)}function fr(t){if(t)throw new Error("Proxy has been released and is not useable")}function Ui(t){return ft(t,{type:"RELEASE"}).then(()=>{Di(t)})}var pr=new WeakMap,mr="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{let e=(pr.get(t)||0)-1;pr.set(t,e),e===0&&Ui(t)});function ul(t,e){let r=(pr.get(e)||0)+1;pr.set(e,r),mr&&mr.register(t,e,t)}function cl(t){mr&&mr.unregister(t)}function pn(t,e=[],r=function(){}){let n=!1,i=new Proxy(r,{get(s,o){if(fr(n),o===mn)return()=>{cl(i),Ui(t),n=!0};if(o==="then"){if(e.length===0)return{then:()=>i};let u=ft(t,{type:"GET",path:e.map(l=>l.toString())}).then(Ze);return u.then.bind(u)}return pn(t,[...e,o])},set(s,o,u){fr(n);let[l,a]=gr(u);return ft(t,{type:"SET",path:[...e,o].map(c=>c.toString()),value:l},a).then(Ze)},apply(s,o,u){fr(n);let l=e[e.length-1];if(l===il)return ft(t,{type:"ENDPOINT"}).then(Ze);if(l==="bind")return pn(t,e.slice(0,-1));let[a,c]=xi(u);return ft(t,{type:"APPLY",path:e.map(h=>h.toString()),argumentList:a},c).then(Ze)},construct(s,o){fr(n);let[u,l]=xi(o);return ft(t,{type:"CONSTRUCT",path:e.map(a=>a.toString()),argumentList:u},l).then(Ze)}});return ul(i,t),i}function hl(t){return Array.prototype.concat.apply([],t)}function xi(t){let e=t.map(gr);return[e.map(r=>r[0]),hl(e.map(r=>r[1]))]}var Mi=new WeakMap;function fl(t,e){return Mi.set(t,e),t}function gn(t){return Object.assign(t,{[Li]:!0})}function gr(t){for(let[e,r]of Ci)if(r.canHandle(t)){let[n,i]=r.serialize(t);return[{type:"HANDLER",name:e,value:n},i]}return[{type:"RAW",value:t},Mi.get(t)||[]]}function Ze(t){switch(t.type){case"HANDLER":return Ci.get(t.name).deserialize(t.value);case"RAW":return t.value}}function ft(t,e,r){return new Promise(n=>{let i=dl();t.addEventListener("message",function s(o){!o.data||!o.data.id||o.data.id!==i||(t.removeEventListener("message",s),n(o.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:i},e),r)})}function dl(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var Ga=Y(_e());var Wf=new Error("timeout while waiting for mutex to become available"),Vf=new Error("mutex already locked"),pl=new Error("request for lock canceled"),ml=function(t,e,r,n){function i(s){return s instanceof r?s:new r(function(o){o(s)})}return new(r||(r=Promise))(function(s,o){function u(c){try{a(n.next(c))}catch(h){o(h)}}function l(c){try{a(n.throw(c))}catch(h){o(h)}}function a(c){c.done?s(c.value):i(c.value).then(u,l)}a((n=n.apply(t,e||[])).next())})},yn=class{constructor(e,r=pl){this._value=e,this._cancelError=r,this._weightedQueues=[],this._weightedWaiters=[]}acquire(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((r,n)=>{this._weightedQueues[e-1]||(this._weightedQueues[e-1]=[]),this._weightedQueues[e-1].push({resolve:r,reject:n}),this._dispatch()})}runExclusive(e,r=1){return ml(this,void 0,void 0,function*(){let[n,i]=yield this.acquire(r);try{return yield e(n)}finally{i()}})}waitForUnlock(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise(r=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),this._weightedWaiters[e-1].push(r),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatch()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatch()}cancel(){this._weightedQueues.forEach(e=>e.forEach(r=>r.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var e;for(let r=this._value;r>0;r--){let n=(e=this._weightedQueues[r-1])===null||e===void 0?void 0:e.shift();if(!n)continue;let i=this._value,s=r;this._value-=r,r=this._value+1,n.resolve([i,this._newReleaser(s)])}this._drainUnlockWaiters()}_newReleaser(e){let r=!1;return()=>{r||(r=!0,this.release(e))}}_drainUnlockWaiters(){for(let e=this._value;e>0;e--)this._weightedWaiters[e-1]&&(this._weightedWaiters[e-1].forEach(r=>r()),this._weightedWaiters[e-1]=[])}},gl=function(t,e,r,n){function i(s){return s instanceof r?s:new r(function(o){o(s)})}return new(r||(r=Promise))(function(s,o){function u(c){try{a(n.next(c))}catch(h){o(h)}}function l(c){try{a(n.throw(c))}catch(h){o(h)}}function a(c){c.done?s(c.value):i(c.value).then(u,l)}a((n=n.apply(t,e||[])).next())})},dt=class{constructor(e){this._semaphore=new yn(1,e)}acquire(){return gl(this,void 0,void 0,function*(){let[,e]=yield this._semaphore.acquire();return e})}runExclusive(e){return this._semaphore.runExclusive(()=>e())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}};var An=Y(qi()),Bs=Y(_e()),Cs=Y(Rn());var Ss;(function(t){t[t.SQLITE_INSERT=18]="SQLITE_INSERT",t[t.SQLITE_DELETE=9]="SQLITE_DELETE",t[t.SQLITE_UPDATE=23]="SQLITE_UPDATE"})(Ss||(Ss={}));function _n(t){return"tables"in t}function bs(t){return _n(t)?t.tables:[t.table]}var ge=class{options;constructor(e){this.options=e}get connected(){return this.options.connected??!1}get lastSyncedAt(){return this.options.lastSyncedAt}get hasSynced(){return this.options.hasSynced}get dataFlowStatus(){return this.options.dataFlow??{downloading:!1,uploading:!1}}isEqual(e){return JSON.stringify(this.options)==JSON.stringify(e.options)}getMessage(){let e=this.dataFlowStatus;return`SyncStatus<connected: ${this.connected} lastSyncedAt: ${this.lastSyncedAt} hasSynced: ${this.hasSynced}. Downloading: ${e.downloading}. Uploading: ${e.uploading}`}toJSON(){return{connected:this.connected,dataFlow:this.dataFlowStatus,lastSyncedAt:this.lastSyncedAt,hasSynced:this.hasSynced}}};var jt=class{count;size;constructor(e,r=null){this.count=e,this.size=r}toString(){return this.size==null?`UploadQueueStats<count:${this.count}>`:`UploadQueueStats<count: $count size: ${this.size/1024}kB>`}};var oe=class{listeners=new Set;constructor(){}registerListener(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}iterateListeners(e){for(let r of this.listeners)e(r)}async iterateAsyncListeners(e){for(let r of Array.from(this.listeners.values()))await e(r)}};async function vn(t,e,r){return new Promise((n,i)=>{let s=r?.timeoutMs,o=!1,u=s?setTimeout(()=>{o=!0,i(new Error("Timeout waiting for lock"))},s):void 0;t.runExclusive(async()=>{if(u&&clearTimeout(u),!o)try{n(await e())}catch(l){i(l)}})})}function Ts(t){return`"${t.replaceAll('"','""')}"`}var X;(function(t){t.DATA="ps_data",t.CRUD="ps_crud",t.BUCKETS="ps_buckets",t.OPLOG="ps_oplog",t.UNTYPED="ps_untyped"})(X||(X={}));var pt=class{crud;haveMore;complete;constructor(e,r,n){this.crud=e,this.haveMore=r,this.complete=n}};var Rs;(function(t){t.PUT="PUT",t.PATCH="PATCH",t.DELETE="DELETE"})(Rs||(Rs={}));var $e=class t{clientId;id;op;opData;table;transactionId;static fromRow(e){let r=JSON.parse(e.data);return new t(parseInt(e.id),r.op,r.type,r.id,e.tx_id,r.data)}constructor(e,r,n,i,s,o){this.clientId=e,this.id=i,this.op=r,this.opData=o,this.table=n,this.transactionId=s}toJSON(){return{op_id:this.clientId,op:this.op,type:this.table,id:this.id,tx_id:this.transactionId,data:this.opData}}equals(e){return JSON.stringify(this.toComparisonArray())==JSON.stringify(e.toComparisonArray())}hashCode(){return JSON.stringify(this.toComparisonArray())}toComparisonArray(){return[this.transactionId,this.clientId,this.op,this.table,this.id,this.opData]}};var Rr=class extends pt{crud;complete;transactionId;constructor(e,r,n){super(e,!1,r),this.crud=e,this.complete=r,this.transactionId=n}};var Is=Y(Rn()),Fs=Y(_e());function _s(t){return t.data!=null}function vs(t){return t.token_expires_in!=null}function Os(t){return t.checkpoint!=null}function Ns(t){return t.checkpoint_complete!=null}function As(t){return t.checkpoint_diff!=null}var tt;(function(t){t[t.CLEAR=1]="CLEAR",t[t.MOVE=2]="MOVE",t[t.PUT=3]="PUT",t[t.REMOVE=4]="REMOVE"})(tt||(tt={}));var _r=class t{value;static fromJSON(e){return new t(tt[e])}constructor(e){this.value=e}toJSON(){return Object.entries(tt).find(([,e])=>e===this.value)[0]}};var vr=class t{op_id;op;checksum;subkey;object_type;object_id;data;static fromRow(e){return new t(e.op_id,_r.fromJSON(e.op),e.checksum,typeof e.subkey=="string"?e.subkey:JSON.stringify(e.subkey),e.object_type,e.object_id,e.data)}constructor(e,r,n,i,s,o,u){this.op_id=e,this.op=r,this.checksum=n,this.subkey=i,this.object_type=s,this.object_id=o,this.data=u}toJSON(){return{op_id:this.op_id,op:this.op.toJSON(),object_type:this.object_type,object_id:this.object_id,checksum:this.checksum,data:this.data,subkey:JSON.stringify(this.subkey)}}};var zt=class t{bucket;data;has_more;after;next_after;static fromRow(e){return new t(e.bucket,e.data.map(r=>vr.fromRow(r)),e.has_more??!1,e.after,e.next_after)}constructor(e,r,n,i,s){this.bucket=e,this.data=r,this.has_more=n,this.after=i,this.next_after=s}toJSON(){return{bucket:this.bucket,has_more:this.has_more,after:this.after,next_after:this.next_after,data:this.data.map(e=>e.toJSON())}}};var Se=class t extends Error{reason;constructor(e){super(e),this.reason=e,Object.setPrototypeOf(this,t.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,t)}};var mt;(function(t){t.CRUD="crud",t.SYNC="sync"})(mt||(mt={}));var Or;(function(t){t.HTTP="http",t.WEB_SOCKET="web-socket"})(Or||(Or={}));var On=1e3,cu={retryDelayMs:5e3,logger:Fs.default.get("PowerSyncStream"),crudUploadThrottleMs:On},hu={connectionMethod:Or.HTTP},Nr=class extends oe{_lastSyncedAt;options;abortController;crudUpdateListener;streamingSyncPromise;syncStatus;triggerCrudUpload;constructor(e){super(),this.options={...cu,...e},this.syncStatus=new ge({connected:!1,lastSyncedAt:void 0,dataFlow:{uploading:!1,downloading:!1}}),this.abortController=null,this.triggerCrudUpload=(0,Is.default)(()=>{!this.syncStatus.connected||this.syncStatus.dataFlowStatus.uploading||this._uploadAllCrud()},this.options.crudUploadThrottleMs,{trailing:!0})}async waitForReady(){}waitForStatus(e){return new Promise(r=>{let n=this.registerListener({statusChanged:i=>{let s=(o,u)=>Object.entries(o).every(([l,a])=>{let c=u[l];return typeof a=="object"&&typeof c=="object"?s(a,c):a==c});s(e,i.toJSON())&&(r(),n?.())}})})}get lastSyncedAt(){let e=this.syncStatus.lastSyncedAt;return e&&new Date(e)}get isConnected(){return this.syncStatus.connected}get logger(){return this.options.logger}async dispose(){this.crudUpdateListener?.(),this.crudUpdateListener=void 0}async hasCompletedSync(){return this.options.adapter.hasCompletedSync()}async getWriteCheckpoint(){return(await this.options.remote.get("/write-checkpoint2.json")).data.write_checkpoint}async _uploadAllCrud(){return this.obtainLock({type:mt.CRUD,callback:async()=>{for(this.updateSyncStatus({dataFlow:{uploading:!0}});;)try{if(await this.uploadCrudBatch())break}catch{this.updateSyncStatus({connected:!1,dataFlow:{uploading:!1}}),await this.delayRetry();break}finally{this.updateSyncStatus({dataFlow:{uploading:!1}})}}})}async uploadCrudBatch(){return await this.options.adapter.hasCrud()?(await this.options.uploadCrud(),!1):(await this.options.adapter.updateLocalTarget(()=>this.getWriteCheckpoint()),!0)}async connect(e){return this.abortController&&await this.disconnect(),this.abortController=new AbortController,this.streamingSyncPromise=this.streamingSync(this.abortController.signal,e),new Promise(r=>{let n=this.registerListener({statusUpdated:i=>{typeof i.connected>"u"||(i.connected==!1&&this.logger.warn("Initial connect attempt did not successfully connect to server"),r(),n())}})})}async disconnect(){if(this.abortController){this.abortController.signal.aborted||this.abortController.abort(new Se("Disconnect has been requested"));try{await this.streamingSyncPromise}catch(e){this.logger.warn(e)}this.streamingSyncPromise=void 0,this.abortController=null,this.updateSyncStatus({connected:!1})}}async streamingSync(e,r){e||(this.abortController=new AbortController,e=this.abortController.signal),this.crudUpdateListener=this.options.adapter.registerListener({crudUpdate:()=>this.triggerCrudUpload()});let n=new AbortController;for(e.addEventListener("abort",()=>{n.abort(e?.reason??new Se("Received command to disconnect from upstream")),this.crudUpdateListener?.(),this.crudUpdateListener=void 0,this.updateSyncStatus({connected:!1,dataFlow:{downloading:!1}})});;)try{if(e?.aborted)break;let{retry:i}=await this.streamingSyncIteration(n.signal,r);if(!i)break}catch(i){i instanceof Se?this.logger.warn(i):this.logger.error(i),await this.delayRetry()}finally{e.aborted||(n.abort(new Se("Closing sync stream network requests before retry.")),n=new AbortController),this.updateSyncStatus({connected:!1})}this.updateSyncStatus({connected:!1})}async streamingSyncIteration(e,r){return await this.obtainLock({type:mt.SYNC,signal:e,callback:async()=>{let n={...hu,...r??{}};this.logger.debug("Streaming sync iteration started"),this.options.adapter.startSession();let i=await this.options.adapter.getBucketStates(),s=new Map;i.forEach(p=>{s.set(p.bucket,p.op_id)});let o=Array.from(s.entries()).map(([p,m])=>({name:p,after:m})),u=null,l=null,a=null,c=new Set(s.keys());this.logger.debug("Requesting stream from server");let h={path:"/sync/stream",abortSignal:e,data:{buckets:o,include_checksum:!0,raw_data:!0}},d=n?.connectionMethod==Or.HTTP?await this.options.remote.postStream(h):await this.options.remote.socketStream(h);for(this.logger.debug("Stream established. Processing events");!d.closed;){let p=await d.read();if(!p)return{retry:!0};if(this.syncStatus.connected||(Promise.resolve().then(()=>this.triggerCrudUpload()),this.updateSyncStatus({connected:!0})),Os(p)){u=p.checkpoint;let m=new Set(c),w=new Set;for(let F of p.checkpoint.buckets)w.add(F.bucket),m.delete(F.bucket);m.size>0&&this.logger.debug("Removing buckets",[...m]),c=w,await this.options.adapter.removeBuckets([...m]),await this.options.adapter.setTargetCheckpoint(u)}else if(Ns(p)){this.logger.debug("Checkpoint complete",u);let m=await this.options.adapter.syncLocalDatabase(u);if(m.checkpointValid)m.ready&&(a=u,this.logger.debug("validated checkpoint",a),this.updateSyncStatus({connected:!0,lastSyncedAt:new Date,dataFlow:{downloading:!1}}));else return await new Promise(w=>setTimeout(w,50)),{retry:!0};l=u}else if(As(p)){if(u==null)throw new Error("Checkpoint diff without previous checkpoint");let m=p.checkpoint_diff,w=new Map;for(let O of u.buckets)w.set(O.bucket,O);for(let O of m.updated_buckets)w.set(O.bucket,O);for(let O of m.removed_buckets)w.delete(O);u={last_op_id:m.last_op_id,buckets:[...w.values()],write_checkpoint:m.write_checkpoint},c=new Set(w.keys());let A=m.removed_buckets;A.length>0&&this.logger.debug("Remove buckets",A),await this.options.adapter.removeBuckets(A),await this.options.adapter.setTargetCheckpoint(u)}else if(_s(p)){let{data:m}=p;this.updateSyncStatus({dataFlow:{downloading:!0}}),await this.options.adapter.saveSyncData({buckets:[zt.fromRow(m)]})}else if(vs(p)){if(p.token_expires_in==0)return this.logger.debug("Token expiring; reconnect"),await this.delayRetry(),{retry:!0};this.triggerCrudUpload()}else if(this.logger.debug("Sync complete"),u===a)this.updateSyncStatus({connected:!0,lastSyncedAt:new Date});else if(l===u){let m=await this.options.adapter.syncLocalDatabase(u);if(m.checkpointValid)m.ready&&(a=u,this.updateSyncStatus({connected:!0,lastSyncedAt:new Date,dataFlow:{downloading:!1}}));else return await new Promise(w=>setTimeout(w,50)),{retry:!1}}}return this.logger.debug("Stream input empty"),{retry:!0}}})}updateSyncStatus(e){let r=new ge({connected:e.connected??this.syncStatus.connected,lastSyncedAt:e.lastSyncedAt??this.syncStatus.lastSyncedAt,dataFlow:{...this.syncStatus.dataFlowStatus,...e.dataFlow}});this.syncStatus.isEqual(r)||(this.syncStatus=r,this.iterateListeners(n=>n.statusChanged?.(r))),this.iterateListeners(n=>n.statusUpdated?.(e))}async delayRetry(){return new Promise(e=>setTimeout(e,this.options.retryDelayMs))}};var Nn=/(^ps_data__|^ps_data_local__)/,fu={clearLocal:!0},du={disconnect:!0},pu=30,mu={retryDelay:5e3,logger:Bs.default.get("PowerSyncDatabase"),crudUploadThrottleMs:On},xs=12e4,Ls=class t extends oe{options;static transactionMutex=new dt;closed;ready;currentStatus;syncStreamImplementation;sdkVersion;bucketStorageAdapter;syncStatusListenerDisposer;_isReadyPromise;hasSyncedWatchDisposer;_schema;constructor(e){super(),this.options=e,this.bucketStorageAdapter=this.generateBucketStorageAdapter(),this.closed=!1,this.currentStatus=new ge({}),this.options={...mu,...e},this._schema=e.schema,this.ready=!1,this.sdkVersion="",this._isReadyPromise=this.initialize()}get schema(){return this._schema}get database(){return this.options.database}get connected(){return this.currentStatus?.connected||!1}async waitForReady(){this.ready||await this._isReadyPromise}async waitForFirstSync(e){if(!this.currentStatus.hasSynced)return new Promise(r=>{let n=this.registerListener({statusChanged:i=>{i.hasSynced&&(n(),r())}});e?.addEventListener("abort",()=>{n(),r()})})}async initialize(){await this._initialize(),await this.bucketStorageAdapter.init();let e=await this.options.database.execute("SELECT powersync_rs_version()");this.sdkVersion=e.rows?.item(0)["powersync_rs_version()"]??"",await this.updateSchema(this.options.schema),this.updateHasSynced(),await this.database.execute("PRAGMA RECURSIVE_TRIGGERS=TRUE"),this.ready=!0,this.iterateListeners(r=>r.initialized?.())}async updateHasSynced(){let e="SELECT 1 FROM ps_buckets WHERE last_applied_op > 0 LIMIT 1",r=new AbortController;this.hasSyncedWatchDisposer=()=>r.abort(),this.watch(e,[],{onResult:n=>{let i=!!n.rows?.length;i!=this.currentStatus.hasSynced&&(this.currentStatus=new ge({...this.currentStatus.toJSON(),hasSynced:i}),this.iterateListeners(s=>s.statusChanged?.(this.currentStatus))),i&&r.abort()},onError:n=>{this.options.logger?.warn("Failure while watching synced state",n),r.abort()}},{rawTableNames:!0,signal:r.signal})}async updateSchema(e){if(this.syncStreamImplementation)throw new Error("Cannot update schema while connected");try{e.validate()}catch(r){this.options.logger?.warn("Schema validation failed. Unexpected behaviour could occur",r)}this._schema=e,await this.database.execute("SELECT powersync_replace_schema(?)",[JSON.stringify(this.schema.toJSON())])}async init(){return this.waitForReady()}async connect(e,r){if(await this.waitForReady(),await this.disconnect(),this.closed)throw new Error("Cannot connect using a closed client");this.syncStreamImplementation=this.generateSyncStreamImplementation(e),this.syncStatusListenerDisposer=this.syncStreamImplementation.registerListener({statusChanged:n=>{this.currentStatus=new ge({...n.toJSON(),hasSynced:this.currentStatus?.hasSynced||!!n.lastSyncedAt}),this.iterateListeners(i=>i.statusChanged?.(this.currentStatus))}}),await this.syncStreamImplementation.waitForReady(),this.syncStreamImplementation.triggerCrudUpload(),await this.syncStreamImplementation.connect(r)}async disconnect(){await this.waitForReady(),await this.syncStreamImplementation?.disconnect(),this.syncStatusListenerDisposer?.(),await this.syncStreamImplementation?.dispose(),this.syncStreamImplementation=void 0}async disconnectAndClear(e=fu){await this.disconnect(),await this.waitForReady();let{clearLocal:r}=e;await this.database.writeTransaction(async n=>{await n.execute(`DELETE FROM ${X.OPLOG}`),await n.execute(`DELETE FROM ${X.CRUD}`),await n.execute(`DELETE FROM ${X.BUCKETS}`),await n.execute(`DELETE FROM ${X.UNTYPED}`);let i=r?"ps_data_*":"ps_data__*",s=await n.execute(`
      SELECT name FROM sqlite_master WHERE type='table' AND name GLOB ?
      `,[i]);if(s.rows?.length)for(let o of s.rows._array)await n.execute(`DELETE FROM ${Ts(o.name)} WHERE 1`)})}async close(e=du){await this.waitForReady(),this.hasSyncedWatchDisposer?.();let{disconnect:r}=e;r&&await this.disconnect(),await this.syncStreamImplementation?.dispose(),this.database.close(),this.closed=!0}async getUploadQueueStats(e){return this.readTransaction(async r=>{if(e){let i=(await r.execute(`SELECT SUM(cast(data as blob) + 20) as size, count(*) as count FROM ${X.CRUD}`)).rows.item(0);return new jt(i?.count??0,i?.size??0)}else{let i=(await r.execute(`SELECT count(*) as count FROM ${X.CRUD}`)).rows.item(0);return new jt(i?.count??0)}})}async getCrudBatch(e){let n=(await this.getAll(`SELECT id, tx_id, data FROM ${X.CRUD} ORDER BY id ASC LIMIT ?`,[e+1])).map(o=>$e.fromRow(o))??[],i=!1;if(n.length>e&&(n.pop(),i=!0),n.length==0)return null;let s=n[n.length-1];return new pt(n,i,async o=>this.handleCrudCheckpoint(s.clientId,o))}async getNextCrudTransaction(){return await this.readTransaction(async e=>{let r=await e.getOptional(`SELECT id, tx_id, data FROM ${X.CRUD} ORDER BY id ASC LIMIT 1`);if(!r)return null;let n=r.tx_id,i;n?i=(await e.getAll(`SELECT id, tx_id, data FROM ${X.CRUD} WHERE tx_id = ? ORDER BY id ASC`,[n])).map(u=>$e.fromRow(u)):i=[$e.fromRow(r)];let s=i[i.length-1];return new Rr(i,async o=>this.handleCrudCheckpoint(s.clientId,o),n)})}async handleCrudCheckpoint(e,r){return this.writeTransaction(async n=>{await n.execute(`DELETE FROM ${X.CRUD} WHERE id <= ?`,[e]),r?(await n.execute(`SELECT 1 FROM ${X.CRUD} LIMIT 1`)).rows?.length||await n.execute(`UPDATE ${X.BUCKETS} SET target_op = ? WHERE name='$local'`,[r]):await n.execute(`UPDATE ${X.BUCKETS} SET target_op = ? WHERE name='$local'`,[this.bucketStorageAdapter.getMaxOpId()])})}async execute(e,r){return await this.waitForReady(),this.database.execute(e,r)}async executeBatch(e,r){return await this.waitForReady(),this.database.executeBatch(e,r)}async getAll(e,r){return await this.waitForReady(),this.database.getAll(e,r)}async getOptional(e,r){return await this.waitForReady(),this.database.getOptional(e,r)}async get(e,r){return await this.waitForReady(),this.database.get(e,r)}async readLock(e){return await this.waitForReady(),vn(t.transactionMutex,()=>e(this.database))}async writeLock(e){return await this.waitForReady(),vn(t.transactionMutex,async()=>await e(this.database))}async readTransaction(e,r=xs){return await this.waitForReady(),this.database.readTransaction(async n=>{let i=await e({...n});return await n.rollback(),i},{timeoutMs:r})}async writeTransaction(e,r=xs){return await this.waitForReady(),this.database.writeTransaction(async n=>{let i=await e(n);return await n.commit(),i},{timeoutMs:r})}watch(e,r,n,i){if(n&&typeof n=="object"&&"onResult"in n){let o=n,u=i;return this.watchWithCallback(e,r,o,u)}let s=n;return this.watchWithAsyncGenerator(e,r,s)}watchWithCallback(e,r,n,i){let{onResult:s,onError:o=u=>this.options.logger?.error(u)}=n??{};if(!s)throw new Error("onResult is required");(async()=>{try{let u=await this.resolveTables(e,r,i),l=await this.executeReadOnly(e,r);s(l),this.onChangeWithCallback({onChange:async()=>{try{let a=await this.executeReadOnly(e,r);s(a)}catch(a){o?.(a)}},onError:o},{...i??{},tables:u})}catch(u){o?.(u)}})()}watchWithAsyncGenerator(e,r,n){return new An.EventIterator(i=>{(async()=>{let s=await this.resolveTables(e,r,n);i.push(await this.executeReadOnly(e,r));for await(let o of this.onChangeWithAsyncGenerator({...n??{},tables:s}))i.push(await this.executeReadOnly(e,r))})()})}async resolveTables(e,r,n){let i=n?.tables?[...n.tables]:[];if(!n?.tables){let o=(await this.getAll(`EXPLAIN ${e}`,r)).filter(l=>l.opcode=="OpenRead"&&l.p3==0&&typeof l.p2=="number").map(l=>l.p2),u=await this.getAll("SELECT DISTINCT tbl_name FROM sqlite_master WHERE rootpage IN (SELECT json_each.value FROM json_each(?))",[JSON.stringify(o)]);for(let l of u)i.push(l.tbl_name.replace(Nn,""))}return i}onChange(e,r){if(e&&typeof e=="object"&&"onChange"in e){let i=e,s=r;return this.onChangeWithCallback(i,s)}let n=e;return this.onChangeWithAsyncGenerator(n)}onChangeWithCallback(e,r){let{onChange:n,onError:i=h=>this.options.logger?.error(h)}=e??{};if(!n)throw new Error("onChange is required");let s=r??{},o=new Set(s.tables??[]),u=new Set,l=s.throttleMs??pu,a=(0,Cs.default)(()=>this.handleTableChanges(u,o,h=>{s?.signal?.aborted||n({changedTables:h})}),l,{leading:!1,trailing:!0}),c=this.database.registerListener({tablesUpdated:async h=>{try{let{rawTableNames:d}=s;this.processTableUpdates(h,d,u),a()}catch(d){i?.(d)}}});return s.signal?.addEventListener("abort",()=>{c()}),()=>c()}onChangeWithAsyncGenerator(e){let r=e??{};return new An.EventIterator(n=>{let i=this.onChangeWithCallback({onChange:s=>{n.push(s)},onError:s=>{n.fail(s)}},e);return r.signal?.addEventListener("abort",()=>{n.stop()}),()=>i()})}handleTableChanges(e,r,n){if(e.size>0){let i=Array.from(e.values()).filter(s=>r.has(s));i.length&&n(i)}e.clear()}processTableUpdates(e,r,n){let i=_n(e)?e.tables:[e.table],s=r?i:i.filter(u=>!!u.match(Nn));if(!s.length)return;let o=r?s:s.map(u=>u.replace(Nn,""));for(let u of o)n.add(u)}async executeReadOnly(e,r){return await this.waitForReady(),this.database.readLock(n=>n.execute(e,r))}};var gu=Y(_e());var Ds=Y(_e());var In=1e3,Ar=class t extends oe{db;mutex;logger;static MAX_OP_ID="9223372036854775807";tableNames;pendingBucketDeletes;_hasCompletedSync;updateListener;compactCounter=In;constructor(e,r,n=Ds.default.get("SqliteBucketStorage")){super(),this.db=e,this.mutex=r,this.logger=n,this._hasCompletedSync=!1,this.pendingBucketDeletes=!0,this.tableNames=new Set,this.updateListener=e.registerListener({tablesUpdated:i=>{bs(i).includes(X.CRUD)&&this.iterateListeners(o=>o.crudUpdate?.())}})}async init(){this._hasCompletedSync=!1;let e=await this.db.execute("SELECT name FROM sqlite_master WHERE type='table' AND name GLOB 'ps_data_*'");for(let r of e.rows?._array??[])this.tableNames.add(r.name)}async dispose(){this.updateListener?.()}getMaxOpId(){return t.MAX_OP_ID}startSession(){}async getBucketStates(){return(await this.db.execute("SELECT name as bucket, cast(last_op as TEXT) as op_id FROM ps_buckets WHERE pending_delete = 0")).rows?._array??[]}async saveSyncData(e){await this.writeTransaction(async r=>{let n=0;for(let i of e.buckets){let s=await r.execute("INSERT INTO powersync_operations(op, data) VALUES(?, ?)",["save",JSON.stringify({buckets:[i.toJSON()]})]);this.logger.debug("saveSyncData",JSON.stringify(s)),n+=i.data.length}this.compactCounter+=n})}async removeBuckets(e){for(let r of e)await this.deleteBucket(r)}async deleteBucket(e){await this.writeTransaction(async r=>{let{uuid:n}=await r.get("select uuid() as uuid"),i=`$delete_${e}_${n}`;this.logger.debug("Deleting bucket",e),await r.execute(`UPDATE ps_oplog SET op=${tt.REMOVE}, data=NULL WHERE op=${tt.PUT} AND superseded=0 AND bucket=?`,[e]),await r.execute("UPDATE ps_oplog SET bucket=? WHERE bucket=?",[i,e]),await r.execute("DELETE FROM ps_buckets WHERE name = ?",[e]),await r.execute("INSERT INTO ps_buckets(name, pending_delete, last_op) SELECT ?, 1, IFNULL(MAX(op_id), 0) FROM ps_oplog WHERE bucket = ?",[i,i])}),this.logger.debug("done deleting bucket"),this.pendingBucketDeletes=!0}async hasCompletedSync(){if(this._hasCompletedSync)return!0;let r=!!(await this.db.execute("SELECT name, last_applied_op FROM ps_buckets WHERE last_applied_op > 0 LIMIT 1")).rows?.length;return r&&(this._hasCompletedSync=!0),r}async syncLocalDatabase(e){let r=await this.validateChecksums(e);if(!r.checkpointValid){this.logger.error("Checksums failed for",r.checkpointFailures);for(let s of r.checkpointFailures??[])await this.deleteBucket(s);return{ready:!1,checkpointValid:!1,checkpointFailures:r.checkpointFailures}}let n=e.buckets.map(s=>s.bucket);return await this.writeTransaction(async s=>{await s.execute("UPDATE ps_buckets SET last_op = ? WHERE name IN (SELECT json_each.value FROM json_each(?))",[e.last_op_id,JSON.stringify(n)]),e.write_checkpoint&&await s.execute("UPDATE ps_buckets SET last_op = ? WHERE name = '$local'",[e.write_checkpoint])}),await this.updateObjectsFromBuckets(e)?(await this.forceCompact(),{ready:!0,checkpointValid:!0}):(this.logger.debug("Not at a consistent checkpoint - cannot update local db"),{ready:!1,checkpointValid:!0})}async updateObjectsFromBuckets(e){return this.writeTransaction(async r=>{let{insertId:n}=await r.execute("INSERT INTO powersync_operations(op, data) VALUES(?, ?)",["sync_local",""]);return n==1})}async validateChecksums(e){let n=(await this.db.execute("SELECT powersync_validate_checkpoint(?) as result",[JSON.stringify(e)])).rows?.item(0);if(this.logger.debug("validateChecksums result item",n),!n)return{checkpointValid:!1,ready:!1,checkpointFailures:[]};let i=JSON.parse(n.result);return i.valid?{ready:!0,checkpointValid:!0}:{checkpointValid:!1,ready:!1,checkpointFailures:i.failed_buckets}}async forceCompact(){this.compactCounter=In,this.pendingBucketDeletes=!0,await this.autoCompact()}async autoCompact(){await this.deletePendingBuckets(),await this.clearRemoveOps()}async deletePendingBuckets(){this.pendingBucketDeletes!==!1&&(await this.writeTransaction(async e=>{await e.execute("DELETE FROM ps_oplog WHERE bucket IN (SELECT name FROM ps_buckets WHERE pending_delete = 1 AND last_applied_op = last_op AND last_op >= target_op)"),await e.execute("DELETE FROM ps_buckets WHERE pending_delete = 1 AND last_applied_op = last_op AND last_op >= target_op")}),this.pendingBucketDeletes=!1)}async clearRemoveOps(){this.compactCounter<In||(await this.writeTransaction(async e=>{await e.execute("INSERT INTO powersync_operations(op, data) VALUES (?, ?)",["clear_remove_ops",""])}),this.compactCounter=0)}async updateLocalTarget(e){if(!(await this.db.execute("SELECT target_op FROM ps_buckets WHERE name = '$local' AND target_op = ?",[t.MAX_OP_ID])).rows?.length)return!1;let n=await this.db.execute("SELECT seq FROM sqlite_sequence WHERE name = 'ps_crud'");if(!n.rows?.length)return!1;let i=n.rows?.item(0).seq,s=await e();return this.logger.debug(`[updateLocalTarget] Updating target to checkpoint ${s}`),this.writeTransaction(async o=>{if((await o.execute("SELECT 1 FROM ps_crud LIMIT 1")).rows?.length)return this.logger.debug("updateLocalTarget","ps crud is not empty"),!1;let l=await o.execute("SELECT seq FROM sqlite_sequence WHERE name = 'ps_crud'");if(!l.rows?.length)throw new Error("SQlite Sequence should not be empty");let a=l.rows?.item(0).seq;if(this.logger.debug("seqAfter",JSON.stringify(l.rows?.item(0))),a!=i)return this.logger.debug("seqAfter != seqBefore",a,i),!1;let c=await o.execute("UPDATE ps_buckets SET target_op = ? WHERE name='$local'",[s]);return this.logger.debug(["[updateLocalTarget] Response from updating target_op ",JSON.stringify(c)]),!0})}async hasCrud(){return!!(await this.db.execute("SELECT 1 FROM ps_crud LIMIT 1")).rows?.length}async getCrudBatch(e=100){if(!await this.hasCrud())return null;let r=await this.db.execute("SELECT * FROM ps_crud ORDER BY id ASC LIMIT ?",[e]),n=[];for(let s of r.rows?._array??[])n.push($e.fromRow(s));if(n.length===0)return null;let i=n[n.length-1];return{crud:n,haveMore:!0,complete:async s=>this.writeTransaction(async o=>{await o.execute("DELETE FROM ps_crud WHERE id <= ?",[i.clientId]),s?(await o.execute("SELECT 1 FROM ps_crud LIMIT 1")).rows?.length&&await o.execute("UPDATE ps_buckets SET target_op = ? WHERE name='$local'",[s]):await o.execute("UPDATE ps_buckets SET target_op = ? WHERE name='$local'",[this.getMaxOpId()])})}}async writeTransaction(e,r){return this.db.writeTransaction(e,r)}async setTargetCheckpoint(e){}};var za=Y(_e()),Ni=Y(Ms());var Ps=Y(_e());var ks={highWater:10,lowWater:0},Ht=class t extends oe{options;dataQueue;isClosed;processingPromise;logger;constructor(e){if(super(),this.options=e,this.processingPromise=null,this.isClosed=!1,this.dataQueue=[],this.logger=e?.logger??Ps.default.get("DataStream"),e?.closeOnError){let r=this.registerListener({error:n=>{r?.(),this.close()}})}}get highWatermark(){return this.options?.pressure?.highWaterMark??ks.highWater}get lowWatermark(){return this.options?.pressure?.lowWaterMark??ks.lowWater}get closed(){return this.isClosed}async close(){this.isClosed=!0,await this.processingPromise,this.iterateListeners(e=>e.closed?.()),this.dataQueue=[],this.listeners.clear()}enqueueData(e){if(this.isClosed)throw new Error("Cannot enqueue data into closed stream.");this.dataQueue.push(e),this.processQueue()}async read(){return this.dataQueue.length<=this.lowWatermark&&await this.iterateAsyncErrored(async e=>e.lowWater?.()),this.closed?null:new Promise((e,r)=>{let n=this.registerListener({data:async i=>{e(i),n?.()},closed:()=>{e(null),n?.()},error:i=>{r(i),n?.()}});this.processQueue()})}forEach(e){return this.dataQueue.length<=this.lowWatermark&&this.iterateAsyncErrored(async r=>r.lowWater?.()),this.registerListener({data:e})}async processQueue(){if(!this.processingPromise)return this.dataQueue.length>=this.highWatermark&&await this.iterateAsyncErrored(async e=>e.highWater?.()),this.processingPromise=this._processQueue()}map(e){let r=new t(this.options),n=this.registerListener({data:async i=>{r.enqueueData(e(i))},closed:()=>{r.close(),n?.()}});return r}hasDataReader(){return Array.from(this.listeners.values()).some(e=>!!e.data)}async _processQueue(){if(!this.dataQueue.length||this.isClosed||!this.hasDataReader()){Promise.resolve().then(()=>this.processingPromise=null);return}let e=this.dataQueue.shift();await this.iterateAsyncErrored(async r=>r.data?.(e)),this.dataQueue.length<=this.lowWatermark&&await this.iterateAsyncErrored(async r=>r.lowWater?.()),this.processingPromise=null,this.dataQueue.length&&setTimeout(()=>this.processQueue())}async iterateAsyncErrored(e){for(let r of Array.from(this.listeners.values()))try{await e(r)}catch(n){this.logger.error(n),this.iterateListeners(i=>i.error?.(n))}}};var Ha=Y(zs()),Wa=Y(wt()),Va=Y(Uo());function Zo(t){return["[object ArrayBuffer]","[object SharedArrayBuffer]"].includes(Object.prototype.toString.call(t))}function At(t){return Object.prototype.toString.call(t)==="[object Uint8Array]"}function er(t){return Object.prototype.toString.call(t)==="[object RegExp]"}function ui(t){return Object.prototype.toString.call(t)==="[object Map]"}function tr(t){return Object.prototype.toString.call(t)==="[object Date]"}function Ee(t,e){return JSON.stringify(t,(r,n)=>typeof n=="bigint"?{$numberLong:`${n}`}:ui(n)?Object.fromEntries(n):n)}function hh(t){if(t!=null&&typeof t=="object"&&"stylize"in t&&typeof t.stylize=="function")return t.stylize}var xt=6,Qr=2147483647,Gr=-2147483648,ea=Math.pow(2,63)-1,ta=-Math.pow(2,63),fh=Math.pow(2,53),dh=-Math.pow(2,53),ci=1,ra=2,hi=3,na=4,fi=5,ph=6,ia=7,sa=8,oa=9,di=10,Hr=11,mh=12,pi=13,aa=14,la=15,rr=16,ua=17,mi=18,ca=19,ha=255,fa=127,gh=0,Wr=4,Ip=Object.freeze({double:1,string:2,object:3,array:4,binData:5,undefined:6,objectId:7,bool:8,date:9,null:10,regex:11,dbPointer:12,javascript:13,symbol:14,javascriptWithScope:15,int:16,timestamp:17,long:18,decimal:19,minKey:-1,maxKey:127}),E=class extends Error{get bsonError(){return!0}get name(){return"BSONError"}constructor(e,r){super(e,r)}static isBSONError(e){return e!=null&&typeof e=="object"&&"bsonError"in e&&e.bsonError===!0&&"name"in e&&"message"in e&&"stack"in e}},Lt=class extends E{get name(){return"BSONVersionError"}constructor(){super(`Unsupported BSON version, bson types must be from bson ${xt}.x.x`)}},Vr=class extends E{get name(){return"BSONRuntimeError"}constructor(e){super(e)}},Fe=class extends E{get name(){return"BSONOffsetError"}constructor(e,r,n){super(`${e}. offset: ${r}`,n),this.offset=r}},Mo,ko;function da(t,e,r,n){if(n){Mo??=new TextDecoder("utf8",{fatal:!0});try{return Mo.decode(t.subarray(e,r))}catch(i){throw new E("Invalid UTF-8 string in BSON document",{cause:i})}}return ko??=new TextDecoder("utf8",{fatal:!1}),ko.decode(t.subarray(e,r))}function pa(t,e,r){if(t.length===0)return"";let n=r-e;if(n===0)return"";if(n>20)return null;if(n===1&&t[e]<128)return String.fromCharCode(t[e]);if(n===2&&t[e]<128&&t[e+1]<128)return String.fromCharCode(t[e])+String.fromCharCode(t[e+1]);if(n===3&&t[e]<128&&t[e+1]<128&&t[e+2]<128)return String.fromCharCode(t[e])+String.fromCharCode(t[e+1])+String.fromCharCode(t[e+2]);let i=[];for(let s=e;s<r;s++){let o=t[s];if(o>127)return null;i.push(o)}return String.fromCharCode(...i)}function yh(t,e,r){if(e.length===0)return 0;if(e.length>25||t.length-r<e.length)return null;for(let n=0,i=r;n<e.length;n++,i++){let s=e.charCodeAt(n);if(s>127)return null;t[i]=s}return e.length}function Eh(t){return Ye.fromNumberArray(Array.from({length:t},()=>Math.floor(Math.random()*256)))}var wh=await(async()=>{try{return(await import("crypto")).randomBytes}catch{return Eh}})(),Ye={toLocalBufferType(t){if(Buffer.isBuffer(t))return t;if(ArrayBuffer.isView(t))return Buffer.from(t.buffer,t.byteOffset,t.byteLength);let e=t?.[Symbol.toStringTag]??Object.prototype.toString.call(t);if(e==="ArrayBuffer"||e==="SharedArrayBuffer"||e==="[object ArrayBuffer]"||e==="[object SharedArrayBuffer]")return Buffer.from(t);throw new E(`Cannot create Buffer from ${String(t)}`)},allocate(t){return Buffer.alloc(t)},allocateUnsafe(t){return Buffer.allocUnsafe(t)},equals(t,e){return Ye.toLocalBufferType(t).equals(e)},fromNumberArray(t){return Buffer.from(t)},fromBase64(t){return Buffer.from(t,"base64")},toBase64(t){return Ye.toLocalBufferType(t).toString("base64")},fromISO88591(t){return Buffer.from(t,"binary")},toISO88591(t){return Ye.toLocalBufferType(t).toString("binary")},fromHex(t){return Buffer.from(t,"hex")},toHex(t){return Ye.toLocalBufferType(t).toString("hex")},toUTF8(t,e,r,n){let i=r-e<=20?pa(t,e,r):null;if(i!=null)return i;let s=Ye.toLocalBufferType(t).toString("utf8",e,r);if(n){for(let o=0;o<s.length;o++)if(s.charCodeAt(o)===65533){da(t,e,r,!0);break}}return s},utf8ByteLength(t){return Buffer.byteLength(t,"utf8")},encodeUTF8Into(t,e,r){let n=yh(t,e,r);return n??Ye.toLocalBufferType(t).write(e,r,void 0,"utf8")},randomBytes:wh};function Sh(){let{navigator:t}=globalThis;return typeof t=="object"&&t.product==="ReactNative"}function bh(t){if(t<0)throw new RangeError(`The argument 'byteLength' is invalid. Received ${t}`);return nr.fromNumberArray(Array.from({length:t},()=>Math.floor(Math.random()*256)))}var Th=(()=>{let{crypto:t}=globalThis;if(t!=null&&typeof t.getRandomValues=="function")return e=>t.getRandomValues(nr.allocate(e));if(Sh()){let{console:e}=globalThis;e?.warn?.("BSON: For React Native please polyfill crypto.getRandomValues, e.g. using: https://www.npmjs.com/package/react-native-get-random-values.")}return bh})(),Po=/(\d|[a-f])/i,nr={toLocalBufferType(t){let e=t?.[Symbol.toStringTag]??Object.prototype.toString.call(t);if(e==="Uint8Array")return t;if(ArrayBuffer.isView(t))return new Uint8Array(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength));if(e==="ArrayBuffer"||e==="SharedArrayBuffer"||e==="[object ArrayBuffer]"||e==="[object SharedArrayBuffer]")return new Uint8Array(t);throw new E(`Cannot make a Uint8Array from ${String(t)}`)},allocate(t){if(typeof t!="number")throw new TypeError(`The "size" argument must be of type number. Received ${String(t)}`);return new Uint8Array(t)},allocateUnsafe(t){return nr.allocate(t)},equals(t,e){if(t.byteLength!==e.byteLength)return!1;for(let r=0;r<t.byteLength;r++)if(t[r]!==e[r])return!1;return!0},fromNumberArray(t){return Uint8Array.from(t)},fromBase64(t){return Uint8Array.from(atob(t),e=>e.charCodeAt(0))},toBase64(t){return btoa(nr.toISO88591(t))},fromISO88591(t){return Uint8Array.from(t,e=>e.charCodeAt(0)&255)},toISO88591(t){return Array.from(Uint16Array.from(t),e=>String.fromCharCode(e)).join("")},fromHex(t){let e=t.length%2===0?t:t.slice(0,t.length-1),r=[];for(let n=0;n<e.length;n+=2){let i=e[n],s=e[n+1];if(!Po.test(i)||!Po.test(s))break;let o=Number.parseInt(`${i}${s}`,16);r.push(o)}return Uint8Array.from(r)},toHex(t){return Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")},toUTF8(t,e,r,n){let i=r-e<=20?pa(t,e,r):null;return i??da(t,e,r,n)},utf8ByteLength(t){return new TextEncoder().encode(t).byteLength},encodeUTF8Into(t,e,r){let n=new TextEncoder().encode(e);return t.set(n,r),n.byteLength},randomBytes:Th},Rh=typeof Buffer=="function"&&Buffer.prototype?._isBuffer!==!0,S=Rh?Ye:nr,pe=class{get[Symbol.for("@@mdb.bson.version")](){return xt}[Symbol.for("nodejs.util.inspect.custom")](e,r,n){return this.inspect(e,r,n)}},J=class t extends pe{get _bsontype(){return"Binary"}constructor(e,r){if(super(),e!=null&&typeof e=="string"&&!ArrayBuffer.isView(e)&&!Zo(e)&&!Array.isArray(e))throw new E("Binary can only be constructed from Uint8Array or number[]");this.sub_type=r??t.BSON_BINARY_SUBTYPE_DEFAULT,e==null?(this.buffer=S.allocate(t.BUFFER_SIZE),this.position=0):(this.buffer=Array.isArray(e)?S.fromNumberArray(e):S.toLocalBufferType(e),this.position=this.buffer.byteLength)}put(e){if(typeof e=="string"&&e.length!==1)throw new E("only accepts single character String");if(typeof e!="number"&&e.length!==1)throw new E("only accepts single character Uint8Array or Array");let r;if(typeof e=="string"?r=e.charCodeAt(0):typeof e=="number"?r=e:r=e[0],r<0||r>255)throw new E("only accepts number in a valid unsigned byte range 0-255");if(this.buffer.byteLength>this.position)this.buffer[this.position++]=r;else{let n=S.allocate(t.BUFFER_SIZE+this.buffer.length);n.set(this.buffer,0),this.buffer=n,this.buffer[this.position++]=r}}write(e,r){if(r=typeof r=="number"?r:this.position,this.buffer.byteLength<r+e.length){let n=S.allocate(this.buffer.byteLength+e.length);n.set(this.buffer,0),this.buffer=n}if(ArrayBuffer.isView(e))this.buffer.set(S.toLocalBufferType(e),r),this.position=r+e.byteLength>this.position?r+e.length:this.position;else if(typeof e=="string")throw new E("input cannot be string")}read(e,r){return r=r&&r>0?r:this.position,this.buffer.slice(e,e+r)}value(){return this.buffer.length===this.position?this.buffer:this.buffer.subarray(0,this.position)}length(){return this.position}toJSON(){return S.toBase64(this.buffer.subarray(0,this.position))}toString(e){return e==="hex"?S.toHex(this.buffer.subarray(0,this.position)):e==="base64"?S.toBase64(this.buffer.subarray(0,this.position)):e==="utf8"||e==="utf-8"?S.toUTF8(this.buffer,0,this.position,!1):S.toUTF8(this.buffer,0,this.position,!1)}toExtendedJSON(e){e=e||{};let r=S.toBase64(this.buffer),n=Number(this.sub_type).toString(16);return e.legacy?{$binary:r,$type:n.length===1?"0"+n:n}:{$binary:{base64:r,subType:n.length===1?"0"+n:n}}}toUUID(){if(this.sub_type===t.SUBTYPE_UUID)return new it(this.buffer.slice(0,this.position));throw new E(`Binary sub_type "${this.sub_type}" is not supported for converting to UUID. Only "${t.SUBTYPE_UUID}" is currently supported.`)}static createFromHexString(e,r){return new t(S.fromHex(e),r)}static createFromBase64(e,r){return new t(S.fromBase64(e),r)}static fromExtendedJSON(e,r){r=r||{};let n,i;if("$binary"in e?r.legacy&&typeof e.$binary=="string"&&"$type"in e?(i=e.$type?parseInt(e.$type,16):0,n=S.fromBase64(e.$binary)):typeof e.$binary!="string"&&(i=e.$binary.subType?parseInt(e.$binary.subType,16):0,n=S.fromBase64(e.$binary.base64)):"$uuid"in e&&(i=4,n=it.bytesFromString(e.$uuid)),!n)throw new E(`Unexpected Binary Extended JSON format ${JSON.stringify(e)}`);return i===Wr?new it(n):new t(n,i)}inspect(e,r,n){n??=Ee;let i=S.toBase64(this.buffer.subarray(0,this.position)),s=n(i,r),o=n(this.sub_type,r);return`Binary.createFromBase64(${s}, ${o})`}};J.BSON_BINARY_SUBTYPE_DEFAULT=0;J.BUFFER_SIZE=256;J.SUBTYPE_DEFAULT=0;J.SUBTYPE_FUNCTION=1;J.SUBTYPE_BYTE_ARRAY=2;J.SUBTYPE_UUID_OLD=3;J.SUBTYPE_UUID=4;J.SUBTYPE_MD5=5;J.SUBTYPE_ENCRYPTED=6;J.SUBTYPE_COLUMN=7;J.SUBTYPE_SENSITIVE=8;J.SUBTYPE_USER_DEFINED=128;var Pn=16,_h=/^[0-9A-F]{32}$/i,vh=/^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i,it=class t extends J{constructor(e){let r;if(e==null)r=t.generate();else if(e instanceof t)r=S.toLocalBufferType(new Uint8Array(e.buffer));else if(ArrayBuffer.isView(e)&&e.byteLength===Pn)r=S.toLocalBufferType(e);else if(typeof e=="string")r=t.bytesFromString(e);else throw new E("Argument passed in UUID constructor must be a UUID, a 16 byte Buffer or a 32/36 character hex string (dashes excluded/included, format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx).");super(r,Wr)}get id(){return this.buffer}set id(e){this.buffer=e}toHexString(e=!0){return e?[S.toHex(this.buffer.subarray(0,4)),S.toHex(this.buffer.subarray(4,6)),S.toHex(this.buffer.subarray(6,8)),S.toHex(this.buffer.subarray(8,10)),S.toHex(this.buffer.subarray(10,16))].join("-"):S.toHex(this.buffer)}toString(e){return e==="hex"?S.toHex(this.id):e==="base64"?S.toBase64(this.id):this.toHexString()}toJSON(){return this.toHexString()}equals(e){if(!e)return!1;if(e instanceof t)return S.equals(e.id,this.id);try{return S.equals(new t(e).id,this.id)}catch{return!1}}toBinary(){return new J(this.id,J.SUBTYPE_UUID)}static generate(){let e=S.randomBytes(Pn);return e[6]=e[6]&15|64,e[8]=e[8]&63|128,e}static isValid(e){return e?typeof e=="string"?t.isValidUUIDString(e):At(e)?e.byteLength===Pn:e._bsontype==="Binary"&&e.sub_type===this.SUBTYPE_UUID&&e.buffer.byteLength===16:!1}static createFromHexString(e){let r=t.bytesFromString(e);return new t(r)}static createFromBase64(e){return new t(S.fromBase64(e))}static bytesFromString(e){if(!t.isValidUUIDString(e))throw new E("UUID string representation must be 32 hex digits or canonical hyphenated representation");return S.fromHex(e.replace(/-/g,""))}static isValidUUIDString(e){return _h.test(e)||vh.test(e)}inspect(e,r,n){return n??=Ee,`new UUID(${n(this.toHexString(),r)})`}},st=class t extends pe{get _bsontype(){return"Code"}constructor(e,r){super(),this.code=e.toString(),this.scope=r??null}toJSON(){return this.scope!=null?{code:this.code,scope:this.scope}:{code:this.code}}toExtendedJSON(){return this.scope?{$code:this.code,$scope:this.scope}:{$code:this.code}}static fromExtendedJSON(e){return new t(e.$code,e.$scope)}inspect(e,r,n){n??=Ee;let i=n(this.code,r),s=i.includes(`
`);this.scope!=null&&(i+=`,${s?`
`:" "}${n(this.scope,r)}`);let o=s&&this.scope===null;return`new Code(${s?`
`:""}${i}${o?`
`:""})`}};function ma(t){return t!=null&&typeof t=="object"&&"$id"in t&&t.$id!=null&&"$ref"in t&&typeof t.$ref=="string"&&(!("$db"in t)||"$db"in t&&typeof t.$db=="string")}var Xe=class t extends pe{get _bsontype(){return"DBRef"}constructor(e,r,n,i){super();let s=e.split(".");s.length===2&&(n=s.shift(),e=s.shift()),this.collection=e,this.oid=r,this.db=n,this.fields=i||{}}get namespace(){return this.collection}set namespace(e){this.collection=e}toJSON(){let e=Object.assign({$ref:this.collection,$id:this.oid},this.fields);return this.db!=null&&(e.$db=this.db),e}toExtendedJSON(e){e=e||{};let r={$ref:this.collection,$id:this.oid};return e.legacy||(this.db&&(r.$db=this.db),r=Object.assign(r,this.fields)),r}static fromExtendedJSON(e){let r=Object.assign({},e);return delete r.$ref,delete r.$id,delete r.$db,new t(e.$ref,e.$id,e.$db,r)}inspect(e,r,n){n??=Ee;let i=[n(this.namespace,r),n(this.oid,r),...this.db?[n(this.db,r)]:[],...Object.keys(this.fields).length>0?[n(this.fields,r)]:[]];return i[1]=n===Ee?`new ObjectId(${i[1]})`:i[1],`new DBRef(${i.join(", ")})`}};function ga(t){if(t==="")return t;let e=0,r=t[e]==="-",n=t[e]==="+";(n||r)&&(e+=1);let i=!1;for(;e<t.length&&t[e]==="0";++e)i=!0;return i?`${r?"-":""}${t.length===e?"0":t.slice(e)}`:n?t.slice(1):t}function Oh(t,e){e=e??10;let r="0123456789abcdefghijklmnopqrstuvwxyz".slice(0,e);return new RegExp(`[^-+${r}]`,"i").test(t)?!1:t}var Te;try{Te=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch{}var qo=65536,Nh=1<<24,It=qo*qo,ya=It*It,$o=ya/2,jo={},zo={},Ah=20,Ih=/^(\+?0|(\+|-)?[1-9][0-9]*)$/,T=class t extends pe{get _bsontype(){return"Long"}get __isLong__(){return!0}constructor(e=0,r,n){super(),typeof e=="bigint"?Object.assign(this,t.fromBigInt(e,!!r)):typeof e=="string"?Object.assign(this,t.fromString(e,!!r)):(this.low=e|0,this.high=r|0,this.unsigned=!!n)}static fromBits(e,r,n){return new t(e,r,n)}static fromInt(e,r){let n,i,s;return r?(e>>>=0,(s=0<=e&&e<256)&&(i=zo[e],i)?i:(n=t.fromBits(e,(e|0)<0?-1:0,!0),s&&(zo[e]=n),n)):(e|=0,(s=-128<=e&&e<128)&&(i=jo[e],i)?i:(n=t.fromBits(e,e<0?-1:0,!1),s&&(jo[e]=n),n))}static fromNumber(e,r){if(isNaN(e))return r?t.UZERO:t.ZERO;if(r){if(e<0)return t.UZERO;if(e>=ya)return t.MAX_UNSIGNED_VALUE}else{if(e<=-$o)return t.MIN_VALUE;if(e+1>=$o)return t.MAX_VALUE}return e<0?t.fromNumber(-e,r).neg():t.fromBits(e%It|0,e/It|0,r)}static fromBigInt(e,r){return t.fromString(e.toString(),r)}static _fromString(e,r,n){if(e.length===0)throw new E("empty string");if(n<2||36<n)throw new E("radix");let i;if((i=e.indexOf("-"))>0)throw new E("interior hyphen");if(i===0)return t._fromString(e.substring(1),r,n).neg();let s=t.fromNumber(Math.pow(n,8)),o=t.ZERO;for(let u=0;u<e.length;u+=8){let l=Math.min(8,e.length-u),a=parseInt(e.substring(u,u+l),n);if(l<8){let c=t.fromNumber(Math.pow(n,l));o=o.mul(c).add(t.fromNumber(a))}else o=o.mul(s),o=o.add(t.fromNumber(a))}return o.unsigned=r,o}static fromStringStrict(e,r,n){let i=!1;if(typeof r=="number"?(n=r,r=!1):i=!!r,n??=10,e.trim()!==e)throw new E(`Input: '${e}' contains leading and/or trailing whitespace`);if(!Oh(e,n))throw new E(`Input: '${e}' contains invalid characters for radix: ${n}`);let s=ga(e),o=t._fromString(s,i,n);if(o.toString(n).toLowerCase()!==s.toLowerCase())throw new E(`Input: ${e} is not representable as ${o.unsigned?"an unsigned":"a signed"} 64-bit Long ${n!=null?`with radix: ${n}`:""}`);return o}static fromString(e,r,n){let i=!1;return typeof r=="number"?(n=r,r=!1):i=!!r,n??=10,e==="NaN"&&n<24||(e==="Infinity"||e==="+Infinity"||e==="-Infinity")&&n<35?t.ZERO:t._fromString(e,i,n)}static fromBytes(e,r,n){return n?t.fromBytesLE(e,r):t.fromBytesBE(e,r)}static fromBytesLE(e,r){return new t(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24,r)}static fromBytesBE(e,r){return new t(e[4]<<24|e[5]<<16|e[6]<<8|e[7],e[0]<<24|e[1]<<16|e[2]<<8|e[3],r)}static isLong(e){return e!=null&&typeof e=="object"&&"__isLong__"in e&&e.__isLong__===!0}static fromValue(e,r){return typeof e=="number"?t.fromNumber(e,r):typeof e=="string"?t.fromString(e,r):t.fromBits(e.low,e.high,typeof r=="boolean"?r:e.unsigned)}add(e){t.isLong(e)||(e=t.fromValue(e));let r=this.high>>>16,n=this.high&65535,i=this.low>>>16,s=this.low&65535,o=e.high>>>16,u=e.high&65535,l=e.low>>>16,a=e.low&65535,c=0,h=0,d=0,p=0;return p+=s+a,d+=p>>>16,p&=65535,d+=i+l,h+=d>>>16,d&=65535,h+=n+u,c+=h>>>16,h&=65535,c+=r+o,c&=65535,t.fromBits(d<<16|p,c<<16|h,this.unsigned)}and(e){return t.isLong(e)||(e=t.fromValue(e)),t.fromBits(this.low&e.low,this.high&e.high,this.unsigned)}compare(e){if(t.isLong(e)||(e=t.fromValue(e)),this.eq(e))return 0;let r=this.isNegative(),n=e.isNegative();return r&&!n?-1:!r&&n?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1}comp(e){return this.compare(e)}divide(e){if(t.isLong(e)||(e=t.fromValue(e)),e.isZero())throw new E("division by zero");if(Te){if(!this.unsigned&&this.high===-2147483648&&e.low===-1&&e.high===-1)return this;let s=(this.unsigned?Te.div_u:Te.div_s)(this.low,this.high,e.low,e.high);return t.fromBits(s,Te.get_high(),this.unsigned)}if(this.isZero())return this.unsigned?t.UZERO:t.ZERO;let r,n,i;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return t.UZERO;if(e.gt(this.shru(1)))return t.UONE;i=t.UZERO}else{if(this.eq(t.MIN_VALUE))return e.eq(t.ONE)||e.eq(t.NEG_ONE)?t.MIN_VALUE:e.eq(t.MIN_VALUE)?t.ONE:(r=this.shr(1).div(e).shl(1),r.eq(t.ZERO)?e.isNegative()?t.ONE:t.NEG_ONE:(n=this.sub(e.mul(r)),i=r.add(n.div(e)),i));if(e.eq(t.MIN_VALUE))return this.unsigned?t.UZERO:t.ZERO;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();i=t.ZERO}for(n=this;n.gte(e);){r=Math.max(1,Math.floor(n.toNumber()/e.toNumber()));let s=Math.ceil(Math.log(r)/Math.LN2),o=s<=48?1:Math.pow(2,s-48),u=t.fromNumber(r),l=u.mul(e);for(;l.isNegative()||l.gt(n);)r-=o,u=t.fromNumber(r,this.unsigned),l=u.mul(e);u.isZero()&&(u=t.ONE),i=i.add(u),n=n.sub(l)}return i}div(e){return this.divide(e)}equals(e){return t.isLong(e)||(e=t.fromValue(e)),this.unsigned!==e.unsigned&&this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low}eq(e){return this.equals(e)}getHighBits(){return this.high}getHighBitsUnsigned(){return this.high>>>0}getLowBits(){return this.low}getLowBitsUnsigned(){return this.low>>>0}getNumBitsAbs(){if(this.isNegative())return this.eq(t.MIN_VALUE)?64:this.neg().getNumBitsAbs();let e=this.high!==0?this.high:this.low,r;for(r=31;r>0&&!(e&1<<r);r--);return this.high!==0?r+33:r+1}greaterThan(e){return this.comp(e)>0}gt(e){return this.greaterThan(e)}greaterThanOrEqual(e){return this.comp(e)>=0}gte(e){return this.greaterThanOrEqual(e)}ge(e){return this.greaterThanOrEqual(e)}isEven(){return(this.low&1)===0}isNegative(){return!this.unsigned&&this.high<0}isOdd(){return(this.low&1)===1}isPositive(){return this.unsigned||this.high>=0}isZero(){return this.high===0&&this.low===0}lessThan(e){return this.comp(e)<0}lt(e){return this.lessThan(e)}lessThanOrEqual(e){return this.comp(e)<=0}lte(e){return this.lessThanOrEqual(e)}modulo(e){if(t.isLong(e)||(e=t.fromValue(e)),Te){let r=(this.unsigned?Te.rem_u:Te.rem_s)(this.low,this.high,e.low,e.high);return t.fromBits(r,Te.get_high(),this.unsigned)}return this.sub(this.div(e).mul(e))}mod(e){return this.modulo(e)}rem(e){return this.modulo(e)}multiply(e){if(this.isZero())return t.ZERO;if(t.isLong(e)||(e=t.fromValue(e)),Te){let m=Te.mul(this.low,this.high,e.low,e.high);return t.fromBits(m,Te.get_high(),this.unsigned)}if(e.isZero())return t.ZERO;if(this.eq(t.MIN_VALUE))return e.isOdd()?t.MIN_VALUE:t.ZERO;if(e.eq(t.MIN_VALUE))return this.isOdd()?t.MIN_VALUE:t.ZERO;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(t.TWO_PWR_24)&&e.lt(t.TWO_PWR_24))return t.fromNumber(this.toNumber()*e.toNumber(),this.unsigned);let r=this.high>>>16,n=this.high&65535,i=this.low>>>16,s=this.low&65535,o=e.high>>>16,u=e.high&65535,l=e.low>>>16,a=e.low&65535,c=0,h=0,d=0,p=0;return p+=s*a,d+=p>>>16,p&=65535,d+=i*a,h+=d>>>16,d&=65535,d+=s*l,h+=d>>>16,d&=65535,h+=n*a,c+=h>>>16,h&=65535,h+=i*l,c+=h>>>16,h&=65535,h+=s*u,c+=h>>>16,h&=65535,c+=r*a+n*l+i*u+s*o,c&=65535,t.fromBits(d<<16|p,c<<16|h,this.unsigned)}mul(e){return this.multiply(e)}negate(){return!this.unsigned&&this.eq(t.MIN_VALUE)?t.MIN_VALUE:this.not().add(t.ONE)}neg(){return this.negate()}not(){return t.fromBits(~this.low,~this.high,this.unsigned)}notEquals(e){return!this.equals(e)}neq(e){return this.notEquals(e)}ne(e){return this.notEquals(e)}or(e){return t.isLong(e)||(e=t.fromValue(e)),t.fromBits(this.low|e.low,this.high|e.high,this.unsigned)}shiftLeft(e){return t.isLong(e)&&(e=e.toInt()),(e&=63)===0?this:e<32?t.fromBits(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):t.fromBits(0,this.low<<e-32,this.unsigned)}shl(e){return this.shiftLeft(e)}shiftRight(e){return t.isLong(e)&&(e=e.toInt()),(e&=63)===0?this:e<32?t.fromBits(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):t.fromBits(this.high>>e-32,this.high>=0?0:-1,this.unsigned)}shr(e){return this.shiftRight(e)}shiftRightUnsigned(e){if(t.isLong(e)&&(e=e.toInt()),e&=63,e===0)return this;{let r=this.high;if(e<32){let n=this.low;return t.fromBits(n>>>e|r<<32-e,r>>>e,this.unsigned)}else return e===32?t.fromBits(r,0,this.unsigned):t.fromBits(r>>>e-32,0,this.unsigned)}}shr_u(e){return this.shiftRightUnsigned(e)}shru(e){return this.shiftRightUnsigned(e)}subtract(e){return t.isLong(e)||(e=t.fromValue(e)),this.add(e.neg())}sub(e){return this.subtract(e)}toInt(){return this.unsigned?this.low>>>0:this.low}toNumber(){return this.unsigned?(this.high>>>0)*It+(this.low>>>0):this.high*It+(this.low>>>0)}toBigInt(){return BigInt(this.toString())}toBytes(e){return e?this.toBytesLE():this.toBytesBE()}toBytesLE(){let e=this.high,r=this.low;return[r&255,r>>>8&255,r>>>16&255,r>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]}toBytesBE(){let e=this.high,r=this.low;return[e>>>24,e>>>16&255,e>>>8&255,e&255,r>>>24,r>>>16&255,r>>>8&255,r&255]}toSigned(){return this.unsigned?t.fromBits(this.low,this.high,!1):this}toString(e){if(e=e||10,e<2||36<e)throw new E("radix");if(this.isZero())return"0";if(this.isNegative())if(this.eq(t.MIN_VALUE)){let s=t.fromNumber(e),o=this.div(s),u=o.mul(s).sub(this);return o.toString(e)+u.toInt().toString(e)}else return"-"+this.neg().toString(e);let r=t.fromNumber(Math.pow(e,6),this.unsigned),n=this,i="";for(;;){let s=n.div(r),u=(n.sub(s.mul(r)).toInt()>>>0).toString(e);if(n=s,n.isZero())return u+i;for(;u.length<6;)u="0"+u;i=""+u+i}}toUnsigned(){return this.unsigned?this:t.fromBits(this.low,this.high,!0)}xor(e){return t.isLong(e)||(e=t.fromValue(e)),t.fromBits(this.low^e.low,this.high^e.high,this.unsigned)}eqz(){return this.isZero()}le(e){return this.lessThanOrEqual(e)}toExtendedJSON(e){return e&&e.relaxed?this.toNumber():{$numberLong:this.toString()}}static fromExtendedJSON(e,r){let{useBigInt64:n=!1,relaxed:i=!0}={...r};if(e.$numberLong.length>Ah)throw new E("$numberLong string is too long");if(!Ih.test(e.$numberLong))throw new E(`$numberLong string "${e.$numberLong}" is in an invalid format`);if(n){let o=BigInt(e.$numberLong);return BigInt.asIntN(64,o)}let s=t.fromString(e.$numberLong);return i?s.toNumber():s}inspect(e,r,n){n??=Ee;let i=n(this.toString(),r),s=this.unsigned?`, ${n(this.unsigned,r)}`:"";return`new Long(${i}${s})`}};T.TWO_PWR_24=T.fromInt(Nh);T.MAX_UNSIGNED_VALUE=T.fromBits(-1,-1,!0);T.ZERO=T.fromInt(0);T.UZERO=T.fromInt(0,!0);T.ONE=T.fromInt(1);T.UONE=T.fromInt(1,!0);T.NEG_ONE=T.fromInt(-1);T.MAX_VALUE=T.fromBits(-1,2147483647,!1);T.MIN_VALUE=T.fromBits(0,-2147483648,!1);var Fh=/^(\+|-)?(\d+|(\d*\.\d*))?(E|e)?([-+])?(\d+)?$/,xh=/^(\+|-)?(Infinity|inf)$/i,Lh=/^(\+|-)?NaN$/i,Nt=6111,Kt=-6176,Ho=6176,Wo=34,qn=S.fromNumberArray([124,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0].reverse()),Vo=S.fromNumberArray([248,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0].reverse()),Jo=S.fromNumberArray([120,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0].reverse()),Bh=/^([-+])?(\d+)?$/,Ch=31,Qo=16383,Dh=30,Uh=31;function Go(t){return!isNaN(parseInt(t,10))}function Mh(t){let e=T.fromNumber(1e9),r=T.fromNumber(0);if(!t.parts[0]&&!t.parts[1]&&!t.parts[2]&&!t.parts[3])return{quotient:t,rem:r};for(let n=0;n<=3;n++)r=r.shiftLeft(32),r=r.add(new T(t.parts[n],0)),t.parts[n]=r.div(e).low,r=r.modulo(e);return{quotient:t,rem:r}}function kh(t,e){if(!t&&!e)return{high:T.fromNumber(0),low:T.fromNumber(0)};let r=t.shiftRightUnsigned(32),n=new T(t.getLowBits(),0),i=e.shiftRightUnsigned(32),s=new T(e.getLowBits(),0),o=r.multiply(i),u=r.multiply(s),l=n.multiply(i),a=n.multiply(s);return o=o.add(u.shiftRightUnsigned(32)),u=new T(u.getLowBits(),0).add(l).add(a.shiftRightUnsigned(32)),o=o.add(u.shiftRightUnsigned(32)),a=u.shiftLeft(32).add(new T(a.getLowBits(),0)),{high:o,low:a}}function Ph(t,e){let r=t.high>>>0,n=e.high>>>0;if(r<n)return!0;if(r===n){let i=t.low>>>0,s=e.low>>>0;if(i<s)return!0}return!1}function ve(t,e){throw new E(`"${t}" is not a valid Decimal128 string - ${e}`)}var ir=class t extends pe{get _bsontype(){return"Decimal128"}constructor(e){if(super(),typeof e=="string")this.bytes=t.fromString(e).bytes;else if(At(e)){if(e.byteLength!==16)throw new E("Decimal128 must take a Buffer of 16 bytes");this.bytes=e}else throw new E("Decimal128 must take a Buffer or string")}static fromString(e){return t._fromString(e,{allowRounding:!1})}static fromStringWithRounding(e){return t._fromString(e,{allowRounding:!0})}static _fromString(e,r){let n=!1,i=!1,s=!1,o=!1,u=0,l=0,a=0,c=0,h=0,d=[0],p=0,m=0,w=0,F=0,A=new T(0,0),O=new T(0,0),V=0,_=0;if(e.length>=7e3)throw new E(""+e+" not a valid Decimal128 string");let B=e.match(Fh),N=e.match(xh),v=e.match(Lh);if(!B&&!N&&!v||e.length===0)throw new E(""+e+" not a valid Decimal128 string");if(B){let f=B[2],g=B[4],b=B[5],k=B[6];g&&k===void 0&&ve(e,"missing exponent power"),g&&f===void 0&&ve(e,"missing exponent base"),g===void 0&&(b||k)&&ve(e,"missing e before exponent")}if((e[_]==="+"||e[_]==="-")&&(i=!0,n=e[_++]==="-"),!Go(e[_])&&e[_]!=="."){if(e[_]==="i"||e[_]==="I")return new t(n?Vo:Jo);if(e[_]==="N")return new t(qn)}for(;Go(e[_])||e[_]===".";){if(e[_]==="."){s&&ve(e,"contains multiple periods"),s=!0,_=_+1;continue}p<Wo&&(e[_]!=="0"||o)&&(o||(h=l),o=!0,d[m++]=parseInt(e[_],10),p=p+1),o&&(a=a+1),s&&(c=c+1),l=l+1,_=_+1}if(s&&!l)throw new E(""+e+" not a valid Decimal128 string");if(e[_]==="e"||e[_]==="E"){let f=e.substr(++_).match(Bh);if(!f||!f[2])return new t(qn);F=parseInt(f[0],10),_=_+f[0].length}if(e[_])return new t(qn);if(!p)d[0]=0,a=1,p=1,u=0;else if(w=p-1,u=a,u!==1)for(;e[h+u-1+Number(i)+Number(s)]==="0";)u=u-1;for(F<=c&&c>F+16384?F=Kt:F=F-c;F>Nt;){if(w=w+1,w>=Wo){if(u===0){F=Nt;break}ve(e,"overflow")}F=F-1}if(r.allowRounding){for(;F<Kt||p<a;){if(w===0&&u<p){F=Kt,u=0;break}if(p<a?a=a-1:w=w-1,F<Nt)F=F+1;else{if(d.join("").match(/^0+$/)){F=Nt;break}ve(e,"overflow")}}if(w+1<u){let f=l;s&&(h=h+1,f=f+1),i&&(h=h+1,f=f+1);let g=parseInt(e[h+w+1],10),b=0;if(g>=5&&(b=1,g===5)){b=d[w]%2===1?1:0;for(let k=h+w+2;k<f;k++)if(parseInt(e[k],10)){b=1;break}}if(b){let k=w;for(;k>=0&&++d[k]>9;k--)if(d[k]=0,k===0)if(F<Nt)F=F+1,d[k]=1;else return new t(n?Vo:Jo)}}}else{for(;F<Kt||p<a;){if(w===0){if(u===0){F=Kt;break}ve(e,"exponent underflow")}p<a?(e[a-1+Number(i)+Number(s)]!=="0"&&u!==0&&ve(e,"inexact rounding"),a=a-1):(d[w]!==0&&ve(e,"inexact rounding"),w=w-1),F<Nt?F=F+1:ve(e,"overflow")}w+1<u&&(s&&(h=h+1),i&&(h=h+1),parseInt(e[h+w+1],10)!==0&&ve(e,"inexact rounding"))}if(A=T.fromNumber(0),O=T.fromNumber(0),u===0)A=T.fromNumber(0),O=T.fromNumber(0);else if(w<17){let f=0;for(O=T.fromNumber(d[f++]),A=new T(0,0);f<=w;f++)O=O.multiply(T.fromNumber(10)),O=O.add(T.fromNumber(d[f]))}else{let f=0;for(A=T.fromNumber(d[f++]);f<=w-17;f++)A=A.multiply(T.fromNumber(10)),A=A.add(T.fromNumber(d[f]));for(O=T.fromNumber(d[f++]);f<=w;f++)O=O.multiply(T.fromNumber(10)),O=O.add(T.fromNumber(d[f]))}let $=kh(A,T.fromString("100000000000000000"));$.low=$.low.add(O),Ph($.low,O)&&($.high=$.high.add(T.fromNumber(1))),V=F+Ho;let U={low:T.fromNumber(0),high:T.fromNumber(0)};$.high.shiftRightUnsigned(49).and(T.fromNumber(1)).equals(T.fromNumber(1))?(U.high=U.high.or(T.fromNumber(3).shiftLeft(61)),U.high=U.high.or(T.fromNumber(V).and(T.fromNumber(16383).shiftLeft(47))),U.high=U.high.or($.high.and(T.fromNumber(0x7fffffffffff)))):(U.high=U.high.or(T.fromNumber(V&16383).shiftLeft(49)),U.high=U.high.or($.high.and(T.fromNumber(562949953421311)))),U.low=$.low,n&&(U.high=U.high.or(T.fromString("9223372036854775808")));let I=S.allocateUnsafe(16);return _=0,I[_++]=U.low.low&255,I[_++]=U.low.low>>8&255,I[_++]=U.low.low>>16&255,I[_++]=U.low.low>>24&255,I[_++]=U.low.high&255,I[_++]=U.low.high>>8&255,I[_++]=U.low.high>>16&255,I[_++]=U.low.high>>24&255,I[_++]=U.high.low&255,I[_++]=U.high.low>>8&255,I[_++]=U.high.low>>16&255,I[_++]=U.high.low>>24&255,I[_++]=U.high.high&255,I[_++]=U.high.high>>8&255,I[_++]=U.high.high>>16&255,I[_++]=U.high.high>>24&255,new t(I)}toString(){let e,r=0,n=new Array(36);for(let _=0;_<n.length;_++)n[_]=0;let i=0,s=!1,o,u={parts:[0,0,0,0]},l,a,c=[];i=0;let h=this.bytes,d=h[i++]|h[i++]<<8|h[i++]<<16|h[i++]<<24,p=h[i++]|h[i++]<<8|h[i++]<<16|h[i++]<<24,m=h[i++]|h[i++]<<8|h[i++]<<16|h[i++]<<24,w=h[i++]|h[i++]<<8|h[i++]<<16|h[i++]<<24;i=0,{low:new T(d,p),high:new T(m,w)}.high.lessThan(T.ZERO)&&c.push("-");let A=w>>26&Ch;if(A>>3===3){if(A===Dh)return c.join("")+"Infinity";if(A===Uh)return"NaN";e=w>>15&Qo,o=8+(w>>14&1)}else o=w>>14&7,e=w>>17&Qo;let O=e-Ho;if(u.parts[0]=(w&16383)+((o&15)<<14),u.parts[1]=m,u.parts[2]=p,u.parts[3]=d,u.parts[0]===0&&u.parts[1]===0&&u.parts[2]===0&&u.parts[3]===0)s=!0;else for(a=3;a>=0;a--){let _=0,B=Mh(u);if(u=B.quotient,_=B.rem.low,!!_)for(l=8;l>=0;l--)n[a*9+l]=_%10,_=Math.floor(_/10)}if(s)r=1,n[i]=0;else for(r=36;!n[i];)r=r-1,i=i+1;let V=r-1+O;if(V>=34||V<=-7||O>0){if(r>34)return c.push("0"),O>0?c.push(`E+${O}`):O<0&&c.push(`E${O}`),c.join("");c.push(`${n[i++]}`),r=r-1,r&&c.push(".");for(let _=0;_<r;_++)c.push(`${n[i++]}`);c.push("E"),V>0?c.push(`+${V}`):c.push(`${V}`)}else if(O>=0)for(let _=0;_<r;_++)c.push(`${n[i++]}`);else{let _=r+O;if(_>0)for(let B=0;B<_;B++)c.push(`${n[i++]}`);else c.push("0");for(c.push(".");_++<0;)c.push("0");for(let B=0;B<r-Math.max(_-1,0);B++)c.push(`${n[i++]}`)}return c.join("")}toJSON(){return{$numberDecimal:this.toString()}}toExtendedJSON(){return{$numberDecimal:this.toString()}}static fromExtendedJSON(e){return t.fromString(e.$numberDecimal)}inspect(e,r,n){return n??=Ee,`new Decimal128(${n(this.toString(),r)})`}},Bt=class t extends pe{get _bsontype(){return"Double"}constructor(e){super(),e instanceof Number&&(e=e.valueOf()),this.value=+e}static fromString(e){let r=Number(e);if(e==="NaN")return new t(NaN);if(e==="Infinity")return new t(1/0);if(e==="-Infinity")return new t(-1/0);if(!Number.isFinite(r))throw new E(`Input: ${e} is not representable as a Double`);if(e.trim()!==e)throw new E(`Input: '${e}' contains whitespace`);if(e==="")throw new E("Input is an empty string");if(/[^-0-9.+eE]/.test(e))throw new E(`Input: '${e}' is not in decimal or exponential notation`);return new t(r)}valueOf(){return this.value}toJSON(){return this.value}toString(e){return this.value.toString(e)}toExtendedJSON(e){return e&&(e.legacy||e.relaxed&&isFinite(this.value))?this.value:Object.is(Math.sign(this.value),-0)?{$numberDouble:"-0.0"}:{$numberDouble:Number.isInteger(this.value)?this.value.toFixed(1):this.value.toString()}}static fromExtendedJSON(e,r){let n=parseFloat(e.$numberDouble);return r&&r.relaxed?n:new t(n)}inspect(e,r,n){return n??=Ee,`new Double(${n(this.value,r)})`}},Ct=class t extends pe{get _bsontype(){return"Int32"}constructor(e){super(),e instanceof Number&&(e=e.valueOf()),this.value=+e|0}static fromString(e){let r=ga(e),n=Number(e);if(Qr<n)throw new E(`Input: '${e}' is larger than the maximum value for Int32`);if(Gr>n)throw new E(`Input: '${e}' is smaller than the minimum value for Int32`);if(Number.isSafeInteger(n)){if(n.toString()!==r)throw new E(`Input: '${e}' is not a valid Int32 string`)}else throw new E(`Input: '${e}' is not a safe integer`);return new t(n)}valueOf(){return this.value}toString(e){return this.value.toString(e)}toJSON(){return this.value}toExtendedJSON(e){return e&&(e.relaxed||e.legacy)?this.value:{$numberInt:this.value.toString()}}static fromExtendedJSON(e,r){return r&&r.relaxed?parseInt(e.$numberInt,10):new t(e.$numberInt)}inspect(e,r,n){return n??=Ee,`new Int32(${n(this.value,r)})`}},sr=class t extends pe{get _bsontype(){return"MaxKey"}toExtendedJSON(){return{$maxKey:1}}static fromExtendedJSON(){return new t}inspect(){return"new MaxKey()"}},or=class t extends pe{get _bsontype(){return"MinKey"}toExtendedJSON(){return{$minKey:1}}static fromExtendedJSON(){return new t}inspect(){return"new MinKey()"}},Ft=new Float64Array(1),W=new Uint8Array(Ft.buffer,0,8);Ft[0]=-1;var Yo=W[7]===0,C={getNonnegativeInt32LE(t,e){if(t[e+3]>127)throw new RangeError(`Size cannot be negative at offset: ${e}`);return t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24},getInt32LE(t,e){return t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24},getUint32LE(t,e){return t[e]+t[e+1]*256+t[e+2]*65536+t[e+3]*16777216},getUint32BE(t,e){return t[e+3]+t[e+2]*256+t[e+1]*65536+t[e]*16777216},getBigInt64LE(t,e){let r=C.getUint32LE(t,e),n=C.getUint32LE(t,e+4);return(BigInt(n)<<BigInt(32))+BigInt(r)},getFloat64LE:Yo?(t,e)=>(W[7]=t[e],W[6]=t[e+1],W[5]=t[e+2],W[4]=t[e+3],W[3]=t[e+4],W[2]=t[e+5],W[1]=t[e+6],W[0]=t[e+7],Ft[0]):(t,e)=>(W[0]=t[e],W[1]=t[e+1],W[2]=t[e+2],W[3]=t[e+3],W[4]=t[e+4],W[5]=t[e+5],W[6]=t[e+6],W[7]=t[e+7],Ft[0]),setInt32BE(t,e,r){return t[e+3]=r,r>>>=8,t[e+2]=r,r>>>=8,t[e+1]=r,r>>>=8,t[e]=r,4},setInt32LE(t,e,r){return t[e]=r,r>>>=8,t[e+1]=r,r>>>=8,t[e+2]=r,r>>>=8,t[e+3]=r,4},setBigInt64LE(t,e,r){let n=BigInt(4294967295),i=Number(r&n);t[e]=i,i>>=8,t[e+1]=i,i>>=8,t[e+2]=i,i>>=8,t[e+3]=i;let s=Number(r>>BigInt(32)&n);return t[e+4]=s,s>>=8,t[e+5]=s,s>>=8,t[e+6]=s,s>>=8,t[e+7]=s,8},setFloat64LE:Yo?(t,e,r)=>(Ft[0]=r,t[e]=W[7],t[e+1]=W[6],t[e+2]=W[5],t[e+3]=W[4],t[e+4]=W[3],t[e+5]=W[2],t[e+6]=W[1],t[e+7]=W[0],8):(t,e,r)=>(Ft[0]=r,t[e]=W[0],t[e+1]=W[1],t[e+2]=W[2],t[e+3]=W[3],t[e+4]=W[4],t[e+5]=W[5],t[e+6]=W[6],t[e+7]=W[7],8)},qh=new RegExp("^[0-9a-fA-F]{24}$"),nt=null,ot=class t extends pe{get _bsontype(){return"ObjectId"}constructor(e){super();let r;if(typeof e=="object"&&e&&"id"in e){if(typeof e.id!="string"&&!ArrayBuffer.isView(e.id))throw new E("Argument passed in must have an id that is of type string or Buffer");"toHexString"in e&&typeof e.toHexString=="function"?r=S.fromHex(e.toHexString()):r=e.id}else r=e;if(r==null||typeof r=="number")this.buffer=t.generate(typeof r=="number"?r:void 0);else if(ArrayBuffer.isView(r)&&r.byteLength===12)this.buffer=S.toLocalBufferType(r);else if(typeof r=="string")if(r.length===24&&qh.test(r))this.buffer=S.fromHex(r);else throw new E("input must be a 24 character hex string, 12 byte Uint8Array, or an integer");else throw new E("Argument passed in does not match the accepted types");t.cacheHexString&&(this.__id=S.toHex(this.id))}get id(){return this.buffer}set id(e){this.buffer=e,t.cacheHexString&&(this.__id=S.toHex(e))}toHexString(){if(t.cacheHexString&&this.__id)return this.__id;let e=S.toHex(this.id);return t.cacheHexString&&!this.__id&&(this.__id=e),e}static getInc(){return t.index=(t.index+1)%16777215}static generate(e){typeof e!="number"&&(e=Math.floor(Date.now()/1e3));let r=t.getInc(),n=S.allocateUnsafe(12);return C.setInt32BE(n,0,e),nt===null&&(nt=S.randomBytes(5)),n[4]=nt[0],n[5]=nt[1],n[6]=nt[2],n[7]=nt[3],n[8]=nt[4],n[11]=r&255,n[10]=r>>8&255,n[9]=r>>16&255,n}toString(e){return e==="base64"?S.toBase64(this.id):e==="hex"?this.toHexString():this.toHexString()}toJSON(){return this.toHexString()}static is(e){return e!=null&&typeof e=="object"&&"_bsontype"in e&&e._bsontype==="ObjectId"}equals(e){if(e==null)return!1;if(t.is(e))return this.buffer[11]===e.buffer[11]&&S.equals(this.buffer,e.buffer);if(typeof e=="string")return e.toLowerCase()===this.toHexString();if(typeof e=="object"&&typeof e.toHexString=="function"){let r=e.toHexString(),n=this.toHexString();return typeof r=="string"&&r.toLowerCase()===n}return!1}getTimestamp(){let e=new Date,r=C.getUint32BE(this.buffer,0);return e.setTime(Math.floor(r)*1e3),e}static createPk(){return new t}serializeInto(e,r){return e[r]=this.buffer[0],e[r+1]=this.buffer[1],e[r+2]=this.buffer[2],e[r+3]=this.buffer[3],e[r+4]=this.buffer[4],e[r+5]=this.buffer[5],e[r+6]=this.buffer[6],e[r+7]=this.buffer[7],e[r+8]=this.buffer[8],e[r+9]=this.buffer[9],e[r+10]=this.buffer[10],e[r+11]=this.buffer[11],12}static createFromTime(e){let r=S.allocate(12);for(let n=11;n>=4;n--)r[n]=0;return C.setInt32BE(r,0,e),new t(r)}static createFromHexString(e){if(e?.length!==24)throw new E("hex string must be 24 characters");return new t(S.fromHex(e))}static createFromBase64(e){if(e?.length!==16)throw new E("base64 string must be 16 characters");return new t(S.fromBase64(e))}static isValid(e){if(e==null)return!1;try{return new t(e),!0}catch{return!1}}toExtendedJSON(){return this.toHexString?{$oid:this.toHexString()}:{$oid:this.toString("hex")}}static fromExtendedJSON(e){return new t(e.$oid)}inspect(e,r,n){return n??=Ee,`new ObjectId(${n(this.toHexString(),r)})`}};ot.index=Math.floor(Math.random()*16777215);function $h(t){return t.split("").sort().join("")}var at=class t extends pe{get _bsontype(){return"BSONRegExp"}constructor(e,r){if(super(),this.pattern=e,this.options=$h(r??""),this.pattern.indexOf("\0")!==-1)throw new E(`BSON Regex patterns cannot contain null bytes, found: ${JSON.stringify(this.pattern)}`);if(this.options.indexOf("\0")!==-1)throw new E(`BSON Regex options cannot contain null bytes, found: ${JSON.stringify(this.options)}`);for(let n=0;n<this.options.length;n++)if(!(this.options[n]==="i"||this.options[n]==="m"||this.options[n]==="x"||this.options[n]==="l"||this.options[n]==="s"||this.options[n]==="u"))throw new E(`The regular expression option [${this.options[n]}] is not supported`)}static parseOptions(e){return e?e.split("").sort().join(""):""}toExtendedJSON(e){return e=e||{},e.legacy?{$regex:this.pattern,$options:this.options}:{$regularExpression:{pattern:this.pattern,options:this.options}}}static fromExtendedJSON(e){if("$regex"in e)if(typeof e.$regex!="string"){if(e.$regex._bsontype==="BSONRegExp")return e}else return new t(e.$regex,t.parseOptions(e.$options));if("$regularExpression"in e)return new t(e.$regularExpression.pattern,t.parseOptions(e.$regularExpression.options));throw new E(`Unexpected BSONRegExp EJSON object form: ${JSON.stringify(e)}`)}inspect(e,r,n){let i=hh(r)??(u=>u);n??=Ee;let s=i(n(this.pattern),"regexp"),o=i(n(this.options),"regexp");return`new BSONRegExp(${s}, ${o})`}},ar=class t extends pe{get _bsontype(){return"BSONSymbol"}constructor(e){super(),this.value=e}valueOf(){return this.value}toString(){return this.value}toJSON(){return this.value}toExtendedJSON(){return{$symbol:this.value}}static fromExtendedJSON(e){return new t(e.$symbol)}inspect(e,r,n){return n??=Ee,`new BSONSymbol(${n(this.value,r)})`}},jh=T,Dt=class t extends jh{get _bsontype(){return"Timestamp"}constructor(e){if(e==null)super(0,0,!0);else if(typeof e=="bigint")super(e,!0);else if(T.isLong(e))super(e.low,e.high,!0);else if(typeof e=="object"&&"t"in e&&"i"in e){if(typeof e.t!="number"&&(typeof e.t!="object"||e.t._bsontype!=="Int32"))throw new E("Timestamp constructed from { t, i } must provide t as a number");if(typeof e.i!="number"&&(typeof e.i!="object"||e.i._bsontype!=="Int32"))throw new E("Timestamp constructed from { t, i } must provide i as a number");let r=Number(e.t),n=Number(e.i);if(r<0||Number.isNaN(r))throw new E("Timestamp constructed from { t, i } must provide a positive t");if(n<0||Number.isNaN(n))throw new E("Timestamp constructed from { t, i } must provide a positive i");if(r>4294967295)throw new E("Timestamp constructed from { t, i } must provide t equal or less than uint32 max");if(n>4294967295)throw new E("Timestamp constructed from { t, i } must provide i equal or less than uint32 max");super(n,r,!0)}else throw new E("A Timestamp can only be constructed with: bigint, Long, or { t: number; i: number }")}toJSON(){return{$timestamp:this.toString()}}static fromInt(e){return new t(T.fromInt(e,!0))}static fromNumber(e){return new t(T.fromNumber(e,!0))}static fromBits(e,r){return new t({i:e,t:r})}static fromString(e,r){return new t(T.fromString(e,!0,r))}toExtendedJSON(){return{$timestamp:{t:this.high>>>0,i:this.low>>>0}}}static fromExtendedJSON(e){let r=T.isLong(e.$timestamp.i)?e.$timestamp.i.getLowBitsUnsigned():e.$timestamp.i,n=T.isLong(e.$timestamp.t)?e.$timestamp.t.getLowBitsUnsigned():e.$timestamp.t;return new t({t:n,i:r})}inspect(e,r,n){n??=Ee;let i=n(this.high>>>0,r),s=n(this.low>>>0,r);return`new Timestamp({ t: ${i}, i: ${s} })`}};Dt.MAX_VALUE=T.MAX_UNSIGNED_VALUE;var zh=T.fromNumber(fh),Hh=T.fromNumber(dh);function Wh(t,e,r){e=e??{};let n=e&&e.index?e.index:0,i=C.getInt32LE(t,n);if(i<5)throw new E(`bson size must be >= 5, is ${i}`);if(e.allowObjectSmallerThanBufferSize&&t.length<i)throw new E(`buffer length ${t.length} must be >= bson size ${i}`);if(!e.allowObjectSmallerThanBufferSize&&t.length!==i)throw new E(`buffer length ${t.length} must === bson size ${i}`);if(i+n>t.byteLength)throw new E(`(bson size ${i} + options.index ${n} must be <= buffer length ${t.byteLength})`);if(t[n+i-1]!==0)throw new E("One object, sized correctly, with a spot for an EOO, but the EOO isn't 0x00");return zr(t,n,e,r)}var Vh=/^\$ref$|^\$id$|^\$db$/;function zr(t,e,r,n=!1){let i=r.fieldsAsRaw==null?null:r.fieldsAsRaw,s=r.raw==null?!1:r.raw,o=typeof r.bsonRegExp=="boolean"?r.bsonRegExp:!1,u=r.promoteBuffers??!1,l=r.promoteLongs??!0,a=r.promoteValues??!0,c=r.useBigInt64??!1;if(c&&!a)throw new E("Must either request bigint or Long for int64 deserialization");if(c&&!l)throw new E("Must either request bigint or Long for int64 deserialization");let h=r.validation==null?{utf8:!0}:r.validation,d=!0,p,m,w=h.utf8;if(typeof w=="boolean")p=w;else{d=!1;let N=Object.keys(w).map(function(v){return w[v]});if(N.length===0)throw new E("UTF-8 validation setting cannot be empty");if(typeof N[0]!="boolean")throw new E("Invalid UTF-8 validation option, must specify boolean values");if(p=N[0],!N.every(v=>v===p))throw new E("Invalid UTF-8 validation option - keys must be all true or all false")}if(!d){m=new Set;for(let N of Object.keys(w))m.add(N)}let F=e;if(t.length<5)throw new E("corrupt bson message < 5 bytes long");let A=C.getInt32LE(t,e);if(e+=4,A<5||A>t.length)throw new E("corrupt bson message");let O=n?[]:{},V=0,_=!1,B=n?!1:null;for(;!_;){let N=t[e++];if(N===0)break;let v=e;for(;t[v]!==0&&v<t.length;)v++;if(v>=t.byteLength)throw new E("Bad BSON Document: illegal CString");let $=n?V++:S.toUTF8(t,e,v,!1),U=!0;d||m?.has($)?U=p:U=!p,B!==!1&&$[0]==="$"&&(B=Vh.test($));let I;if(e=v+1,N===ra){let f=C.getInt32LE(t,e);if(e+=4,f<=0||f>t.length-e||t[e+f-1]!==0)throw new E("bad string length in bson");I=S.toUTF8(t,e,e+f-1,U),e=e+f}else if(N===ia){let f=S.allocateUnsafe(12);for(let g=0;g<12;g++)f[g]=t[e+g];I=new ot(f),e=e+12}else if(N===rr&&a===!1)I=new Ct(C.getInt32LE(t,e)),e+=4;else if(N===rr)I=C.getInt32LE(t,e),e+=4;else if(N===ci)I=C.getFloat64LE(t,e),e+=8,a===!1&&(I=new Bt(I));else if(N===oa){let f=C.getInt32LE(t,e),g=C.getInt32LE(t,e+4);e+=8,I=new Date(new T(f,g).toNumber())}else if(N===sa){if(t[e]!==0&&t[e]!==1)throw new E("illegal boolean type value");I=t[e++]===1}else if(N===hi){let f=e,g=C.getInt32LE(t,e);if(g<=0||g>t.length-e)throw new E("bad embedded document length in bson");if(s)I=t.slice(e,e+g);else{let b=r;d||(b={...r,validation:{utf8:U}}),I=zr(t,f,b,!1)}e=e+g}else if(N===na){let f=e,g=C.getInt32LE(t,e),b=r,k=e+g;if(i&&i[$]&&(b={...r,raw:!0}),d||(b={...b,validation:{utf8:U}}),I=zr(t,f,b,!0),e=e+g,t[e-1]!==0)throw new E("invalid array terminator byte");if(e!==k)throw new E("corrupted array bson")}else if(N===ph)I=void 0;else if(N===di)I=null;else if(N===mi)if(c)I=C.getBigInt64LE(t,e),e+=8;else{let f=C.getInt32LE(t,e),g=C.getInt32LE(t,e+4);e+=8;let b=new T(f,g);l&&a===!0?I=b.lessThanOrEqual(zh)&&b.greaterThanOrEqual(Hh)?b.toNumber():b:I=b}else if(N===ca){let f=S.allocateUnsafe(16);for(let g=0;g<16;g++)f[g]=t[e+g];e=e+16,I=new ir(f)}else if(N===fi){let f=C.getInt32LE(t,e);e+=4;let g=f,b=t[e++];if(f<0)throw new E("Negative binary type element size found");if(f>t.byteLength)throw new E("Binary type size larger than document size");if(t.slice!=null){if(b===J.SUBTYPE_BYTE_ARRAY){if(f=C.getInt32LE(t,e),e+=4,f<0)throw new E("Negative binary type element size found for subtype 0x02");if(f>g-4)throw new E("Binary type with subtype 0x02 contains too long binary size");if(f<g-4)throw new E("Binary type with subtype 0x02 contains too short binary size")}u&&a?I=S.toLocalBufferType(t.slice(e,e+f)):(I=new J(t.slice(e,e+f),b),b===Wr&&it.isValid(I)&&(I=I.toUUID()))}else{if(b===J.SUBTYPE_BYTE_ARRAY){if(f=C.getInt32LE(t,e),e+=4,f<0)throw new E("Negative binary type element size found for subtype 0x02");if(f>g-4)throw new E("Binary type with subtype 0x02 contains too long binary size");if(f<g-4)throw new E("Binary type with subtype 0x02 contains too short binary size")}if(u&&a)for(I=S.allocateUnsafe(f),v=0;v<f;v++)I[v]=t[e+v];else I=new J(t.slice(e,e+f),b),b===Wr&&it.isValid(I)&&(I=I.toUUID())}e=e+f}else if(N===Hr&&o===!1){for(v=e;t[v]!==0&&v<t.length;)v++;if(v>=t.length)throw new E("Bad BSON Document: illegal CString");let f=S.toUTF8(t,e,v,!1);for(e=v+1,v=e;t[v]!==0&&v<t.length;)v++;if(v>=t.length)throw new E("Bad BSON Document: illegal CString");let g=S.toUTF8(t,e,v,!1);e=v+1;let b=new Array(g.length);for(v=0;v<g.length;v++)switch(g[v]){case"m":b[v]="m";break;case"s":b[v]="g";break;case"i":b[v]="i";break}I=new RegExp(f,b.join(""))}else if(N===Hr&&o===!0){for(v=e;t[v]!==0&&v<t.length;)v++;if(v>=t.length)throw new E("Bad BSON Document: illegal CString");let f=S.toUTF8(t,e,v,!1);for(e=v+1,v=e;t[v]!==0&&v<t.length;)v++;if(v>=t.length)throw new E("Bad BSON Document: illegal CString");let g=S.toUTF8(t,e,v,!1);e=v+1,I=new at(f,g)}else if(N===aa){let f=C.getInt32LE(t,e);if(e+=4,f<=0||f>t.length-e||t[e+f-1]!==0)throw new E("bad string length in bson");let g=S.toUTF8(t,e,e+f-1,U);I=a?g:new ar(g),e=e+f}else if(N===ua)I=new Dt({i:C.getUint32LE(t,e),t:C.getUint32LE(t,e+4)}),e+=8;else if(N===ha)I=new or;else if(N===fa)I=new sr;else if(N===pi){let f=C.getInt32LE(t,e);if(e+=4,f<=0||f>t.length-e||t[e+f-1]!==0)throw new E("bad string length in bson");let g=S.toUTF8(t,e,e+f-1,U);I=new st(g),e=e+f}else if(N===la){let f=C.getInt32LE(t,e);if(e+=4,f<13)throw new E("code_w_scope total size shorter minimum expected length");let g=C.getInt32LE(t,e);if(e+=4,g<=0||g>t.length-e||t[e+g-1]!==0)throw new E("bad string length in bson");let b=S.toUTF8(t,e,e+g-1,U);e=e+g;let k=e,H=C.getInt32LE(t,e),z=zr(t,k,r,!1);if(e=e+H,f<8+H+g)throw new E("code_w_scope total size is too short, truncating scope");if(f>8+H+g)throw new E("code_w_scope total size is too long, clips outer document");I=new st(b,z)}else if(N===mh){let f=C.getInt32LE(t,e);if(e+=4,f<=0||f>t.length-e||t[e+f-1]!==0)throw new E("bad string length in bson");let g=S.toUTF8(t,e,e+f-1,U);e=e+f;let b=S.allocateUnsafe(12);for(let H=0;H<12;H++)b[H]=t[e+H];let k=new ot(b);e=e+12,I=new Xe(g,k)}else throw new E(`Detected unknown BSON type ${N.toString(16)} for fieldname "${$}"`);$==="__proto__"?Object.defineProperty(O,$,{value:I,writable:!0,enumerable:!0,configurable:!0}):O[$]=I}if(A!==e-F)throw n?new E("corrupt array bson"):new E("corrupt object bson");if(!B)return O;if(ma(O)){let N=Object.assign({},O);return delete N.$ref,delete N.$id,delete N.$db,new Xe(O.$ref,O.$id,O.$db,N)}return O}var Jr=/\x00/,Xo=new Set(["$db","$ref","$id","$clusterTime"]);function $n(t,e,r,n){t[n++]=ra;let i=S.encodeUTF8Into(t,e,n);n=n+i+1,t[n-1]=0;let s=S.encodeUTF8Into(t,r,n+4);return C.setInt32LE(t,n,s+1),n=n+4+s,t[n++]=0,n}function jn(t,e,r,n){let s=!Object.is(r,-0)&&Number.isSafeInteger(r)&&r<=Qr&&r>=Gr?rr:ci;t[n++]=s;let o=S.encodeUTF8Into(t,e,n);return n=n+o,t[n++]=0,s===rr?n+=C.setInt32LE(t,n,r):n+=C.setFloat64LE(t,n,r),n}function zn(t,e,r,n){t[n++]=mi;let i=S.encodeUTF8Into(t,e,n);return n+=i,t[n++]=0,n+=C.setBigInt64LE(t,n,r),n}function Zt(t,e,r,n){t[n++]=di;let i=S.encodeUTF8Into(t,e,n);return n=n+i,t[n++]=0,n}function Hn(t,e,r,n){t[n++]=sa;let i=S.encodeUTF8Into(t,e,n);return n=n+i,t[n++]=0,t[n++]=r?1:0,n}function Wn(t,e,r,n){t[n++]=oa;let i=S.encodeUTF8Into(t,e,n);n=n+i,t[n++]=0;let s=T.fromNumber(r.getTime()),o=s.getLowBits(),u=s.getHighBits();return n+=C.setInt32LE(t,n,o),n+=C.setInt32LE(t,n,u),n}function Vn(t,e,r,n){t[n++]=Hr;let i=S.encodeUTF8Into(t,e,n);if(n=n+i,t[n++]=0,r.source&&r.source.match(Jr)!=null)throw new E("value "+r.source+" must not contain null bytes");return n=n+S.encodeUTF8Into(t,r.source,n),t[n++]=0,r.ignoreCase&&(t[n++]=105),r.global&&(t[n++]=115),r.multiline&&(t[n++]=109),t[n++]=0,n}function Jn(t,e,r,n){t[n++]=Hr;let i=S.encodeUTF8Into(t,e,n);if(n=n+i,t[n++]=0,r.pattern.match(Jr)!=null)throw new E("pattern "+r.pattern+" must not contain null bytes");n=n+S.encodeUTF8Into(t,r.pattern,n),t[n++]=0;let s=r.options.split("").sort().join("");return n=n+S.encodeUTF8Into(t,s,n),t[n++]=0,n}function Qn(t,e,r,n){r===null?t[n++]=di:r._bsontype==="MinKey"?t[n++]=ha:t[n++]=fa;let i=S.encodeUTF8Into(t,e,n);return n=n+i,t[n++]=0,n}function Gn(t,e,r,n){t[n++]=ia;let i=S.encodeUTF8Into(t,e,n);return n=n+i,t[n++]=0,n+=r.serializeInto(t,n),n}function Yn(t,e,r,n){t[n++]=fi;let i=S.encodeUTF8Into(t,e,n);n=n+i,t[n++]=0;let s=r.length;if(n+=C.setInt32LE(t,n,s),t[n++]=gh,s<=16)for(let o=0;o<s;o++)t[n+o]=r[o];else t.set(r,n);return n=n+s,n}function Xn(t,e,r,n,i,s,o,u,l){if(l.has(r))throw new E("Cannot convert circular structure to BSON");l.add(r),t[n++]=Array.isArray(r)?na:hi;let a=S.encodeUTF8Into(t,e,n);n=n+a,t[n++]=0;let c=Yr(t,r,i,n,s+1,o,u,l);return l.delete(r),c}function Kn(t,e,r,n){t[n++]=ca;let i=S.encodeUTF8Into(t,e,n);n=n+i,t[n++]=0;for(let s=0;s<16;s++)t[n+s]=r.bytes[s];return n+16}function Zn(t,e,r,n){t[n++]=r._bsontype==="Long"?mi:ua;let i=S.encodeUTF8Into(t,e,n);n=n+i,t[n++]=0;let s=r.getLowBits(),o=r.getHighBits();return n+=C.setInt32LE(t,n,s),n+=C.setInt32LE(t,n,o),n}function ei(t,e,r,n){r=r.valueOf(),t[n++]=rr;let i=S.encodeUTF8Into(t,e,n);return n=n+i,t[n++]=0,n+=C.setInt32LE(t,n,r),n}function ti(t,e,r,n){t[n++]=ci;let i=S.encodeUTF8Into(t,e,n);return n=n+i,t[n++]=0,n+=C.setFloat64LE(t,n,r.value),n}function ri(t,e,r,n){t[n++]=pi;let i=S.encodeUTF8Into(t,e,n);n=n+i,t[n++]=0;let s=r.toString(),o=S.encodeUTF8Into(t,s,n+4)+1;return C.setInt32LE(t,n,o),n=n+4+o-1,t[n++]=0,n}function ni(t,e,r,n,i=!1,s=0,o=!1,u=!0,l){if(r.scope&&typeof r.scope=="object"){t[n++]=la;let a=S.encodeUTF8Into(t,e,n);n=n+a,t[n++]=0;let c=n,h=r.code;n=n+4;let d=S.encodeUTF8Into(t,h,n+4)+1;C.setInt32LE(t,n,d),t[n+4+d-1]=0,n=n+d+4;let p=Yr(t,r.scope,i,n,s+1,o,u,l);n=p-1;let m=p-c;c+=C.setInt32LE(t,c,m),t[n++]=0}else{t[n++]=pi;let a=S.encodeUTF8Into(t,e,n);n=n+a,t[n++]=0;let c=r.code.toString(),h=S.encodeUTF8Into(t,c,n+4)+1;C.setInt32LE(t,n,h),n=n+4+h-1,t[n++]=0}return n}function ii(t,e,r,n){t[n++]=fi;let i=S.encodeUTF8Into(t,e,n);n=n+i,t[n++]=0;let s=r.buffer,o=r.position;if(r.sub_type===J.SUBTYPE_BYTE_ARRAY&&(o=o+4),n+=C.setInt32LE(t,n,o),t[n++]=r.sub_type,r.sub_type===J.SUBTYPE_BYTE_ARRAY&&(o=o-4,n+=C.setInt32LE(t,n,o)),o<=16)for(let u=0;u<o;u++)t[n+u]=s[u];else t.set(s,n);return n=n+r.position,n}function si(t,e,r,n){t[n++]=aa;let i=S.encodeUTF8Into(t,e,n);n=n+i,t[n++]=0;let s=S.encodeUTF8Into(t,r.value,n+4)+1;return C.setInt32LE(t,n,s),n=n+4+s-1,t[n++]=0,n}function oi(t,e,r,n,i,s,o){t[n++]=hi;let u=S.encodeUTF8Into(t,e,n);n=n+u,t[n++]=0;let l=n,a={$ref:r.collection||r.namespace,$id:r.oid};r.db!=null&&(a.$db=r.db),a=Object.assign(a,r.fields);let c=Yr(t,a,!1,n,i+1,s,!0,o),h=c-l;return l+=C.setInt32LE(t,n,h),c}function Yr(t,e,r,n,i,s,o,u){if(u==null){if(e==null)return t[0]=5,t[1]=0,t[2]=0,t[3]=0,t[4]=0,5;if(Array.isArray(e))throw new E("serialize does not support an array as the root input");if(typeof e!="object")throw new E("serialize does not support non-object as the root input");if("_bsontype"in e&&typeof e._bsontype=="string")throw new E("BSON types cannot be serialized as a document");if(tr(e)||er(e)||At(e)||Zo(e))throw new E("date, regexp, typedarray, and arraybuffer cannot be BSON documents");u=new Set}u.add(e);let l=n+4;if(Array.isArray(e))for(let c=0;c<e.length;c++){let h=`${c}`,d=e[c];if(typeof d?.toBSON=="function"&&(d=d.toBSON()),typeof d=="string")l=$n(t,h,d,l);else if(typeof d=="number")l=jn(t,h,d,l);else if(typeof d=="bigint")l=zn(t,h,d,l);else if(typeof d=="boolean")l=Hn(t,h,d,l);else if(d instanceof Date||tr(d))l=Wn(t,h,d,l);else if(d===void 0)l=Zt(t,h,d,l);else if(d===null)l=Zt(t,h,d,l);else if(At(d))l=Yn(t,h,d,l);else if(d instanceof RegExp||er(d))l=Vn(t,h,d,l);else if(typeof d=="object"&&d._bsontype==null)l=Xn(t,h,d,l,r,i,s,o,u);else{if(typeof d=="object"&&d[Symbol.for("@@mdb.bson.version")]!==xt)throw new Lt;if(d._bsontype==="ObjectId")l=Gn(t,h,d,l);else if(d._bsontype==="Decimal128")l=Kn(t,h,d,l);else if(d._bsontype==="Long"||d._bsontype==="Timestamp")l=Zn(t,h,d,l);else if(d._bsontype==="Double")l=ti(t,h,d,l);else if(typeof d=="function"&&s)l=ri(t,h,d,l);else if(d._bsontype==="Code")l=ni(t,h,d,l,r,i,s,o,u);else if(d._bsontype==="Binary")l=ii(t,h,d,l);else if(d._bsontype==="BSONSymbol")l=si(t,h,d,l);else if(d._bsontype==="DBRef")l=oi(t,h,d,l,i,s,u);else if(d._bsontype==="BSONRegExp")l=Jn(t,h,d,l);else if(d._bsontype==="Int32")l=ei(t,h,d,l);else if(d._bsontype==="MinKey"||d._bsontype==="MaxKey")l=Qn(t,h,d,l);else if(typeof d._bsontype<"u")throw new E(`Unrecognized or invalid _bsontype: ${String(d._bsontype)}`)}}else if(e instanceof Map||ui(e)){let c=e.entries(),h=!1;for(;!h;){let d=c.next();if(h=!!d.done,h)continue;let p=d.value[0],m=d.value[1];typeof m?.toBSON=="function"&&(m=m.toBSON());let w=typeof m;if(typeof p=="string"&&!Xo.has(p)){if(p.match(Jr)!=null)throw new E("key "+p+" must not contain null bytes");if(r){if(p[0]==="$")throw new E("key "+p+" must not start with '$'");if(p.includes("."))throw new E("key "+p+" must not contain '.'")}}if(w==="string")l=$n(t,p,m,l);else if(w==="number")l=jn(t,p,m,l);else if(w==="bigint")l=zn(t,p,m,l);else if(w==="boolean")l=Hn(t,p,m,l);else if(m instanceof Date||tr(m))l=Wn(t,p,m,l);else if(m===null||m===void 0&&o===!1)l=Zt(t,p,m,l);else if(At(m))l=Yn(t,p,m,l);else if(m instanceof RegExp||er(m))l=Vn(t,p,m,l);else if(w==="object"&&m._bsontype==null)l=Xn(t,p,m,l,r,i,s,o,u);else{if(typeof m=="object"&&m[Symbol.for("@@mdb.bson.version")]!==xt)throw new Lt;if(m._bsontype==="ObjectId")l=Gn(t,p,m,l);else if(w==="object"&&m._bsontype==="Decimal128")l=Kn(t,p,m,l);else if(m._bsontype==="Long"||m._bsontype==="Timestamp")l=Zn(t,p,m,l);else if(m._bsontype==="Double")l=ti(t,p,m,l);else if(m._bsontype==="Code")l=ni(t,p,m,l,r,i,s,o,u);else if(typeof m=="function"&&s)l=ri(t,p,m,l);else if(m._bsontype==="Binary")l=ii(t,p,m,l);else if(m._bsontype==="BSONSymbol")l=si(t,p,m,l);else if(m._bsontype==="DBRef")l=oi(t,p,m,l,i,s,u);else if(m._bsontype==="BSONRegExp")l=Jn(t,p,m,l);else if(m._bsontype==="Int32")l=ei(t,p,m,l);else if(m._bsontype==="MinKey"||m._bsontype==="MaxKey")l=Qn(t,p,m,l);else if(typeof m._bsontype<"u")throw new E(`Unrecognized or invalid _bsontype: ${String(m._bsontype)}`)}}}else{if(typeof e?.toBSON=="function"&&(e=e.toBSON(),e!=null&&typeof e!="object"))throw new E("toBSON function did not return an object");for(let c of Object.keys(e)){let h=e[c];typeof h?.toBSON=="function"&&(h=h.toBSON());let d=typeof h;if(typeof c=="string"&&!Xo.has(c)){if(c.match(Jr)!=null)throw new E("key "+c+" must not contain null bytes");if(r){if(c[0]==="$")throw new E("key "+c+" must not start with '$'");if(c.includes("."))throw new E("key "+c+" must not contain '.'")}}if(d==="string")l=$n(t,c,h,l);else if(d==="number")l=jn(t,c,h,l);else if(d==="bigint")l=zn(t,c,h,l);else if(d==="boolean")l=Hn(t,c,h,l);else if(h instanceof Date||tr(h))l=Wn(t,c,h,l);else if(h===void 0)o===!1&&(l=Zt(t,c,h,l));else if(h===null)l=Zt(t,c,h,l);else if(At(h))l=Yn(t,c,h,l);else if(h instanceof RegExp||er(h))l=Vn(t,c,h,l);else if(d==="object"&&h._bsontype==null)l=Xn(t,c,h,l,r,i,s,o,u);else{if(typeof h=="object"&&h[Symbol.for("@@mdb.bson.version")]!==xt)throw new Lt;if(h._bsontype==="ObjectId")l=Gn(t,c,h,l);else if(d==="object"&&h._bsontype==="Decimal128")l=Kn(t,c,h,l);else if(h._bsontype==="Long"||h._bsontype==="Timestamp")l=Zn(t,c,h,l);else if(h._bsontype==="Double")l=ti(t,c,h,l);else if(h._bsontype==="Code")l=ni(t,c,h,l,r,i,s,o,u);else if(typeof h=="function"&&s)l=ri(t,c,h,l);else if(h._bsontype==="Binary")l=ii(t,c,h,l);else if(h._bsontype==="BSONSymbol")l=si(t,c,h,l);else if(h._bsontype==="DBRef")l=oi(t,c,h,l,i,s,u);else if(h._bsontype==="BSONRegExp")l=Jn(t,c,h,l);else if(h._bsontype==="Int32")l=ei(t,c,h,l);else if(h._bsontype==="MinKey"||h._bsontype==="MaxKey")l=Qn(t,c,h,l);else if(typeof h._bsontype<"u")throw new E(`Unrecognized or invalid _bsontype: ${String(h._bsontype)}`)}}}u.delete(e),t[l++]=0;let a=l-n;return n+=C.setInt32LE(t,n,a),l}function Jh(t){return t!=null&&typeof t=="object"&&"_bsontype"in t&&typeof t._bsontype=="string"}var Qh={$oid:ot,$binary:J,$uuid:J,$symbol:ar,$numberInt:Ct,$numberDecimal:ir,$numberDouble:Bt,$numberLong:T,$minKey:or,$maxKey:sr,$regex:at,$regularExpression:at,$timestamp:Dt};function Ea(t,e={}){if(typeof t=="number"){let n=t<=Qr&&t>=Gr,i=t<=ea&&t>=ta;if(e.relaxed||e.legacy)return t;if(Number.isInteger(t)&&!Object.is(t,-0)){if(n)return new Ct(t);if(i)return e.useBigInt64?BigInt(t):T.fromNumber(t)}return new Bt(t)}if(t==null||typeof t!="object")return t;if(t.$undefined)return null;let r=Object.keys(t).filter(n=>n.startsWith("$")&&t[n]!=null);for(let n=0;n<r.length;n++){let i=Qh[r[n]];if(i)return i.fromExtendedJSON(t,e)}if(t.$date!=null){let n=t.$date,i=new Date;if(e.legacy)if(typeof n=="number")i.setTime(n);else if(typeof n=="string")i.setTime(Date.parse(n));else if(typeof n=="bigint")i.setTime(Number(n));else throw new Vr(`Unrecognized type for EJSON date: ${typeof n}`);else if(typeof n=="string")i.setTime(Date.parse(n));else if(T.isLong(n))i.setTime(n.toNumber());else if(typeof n=="number"&&e.relaxed)i.setTime(n);else if(typeof n=="bigint")i.setTime(Number(n));else throw new Vr(`Unrecognized type for EJSON date: ${typeof n}`);return i}if(t.$code!=null){let n=Object.assign({},t);return t.$scope&&(n.$scope=Ea(t.$scope)),st.fromExtendedJSON(t)}if(ma(t)||t.$dbPointer){let n=t.$ref?t:t.$dbPointer;if(n instanceof Xe)return n;let i=Object.keys(n).filter(o=>o.startsWith("$")),s=!0;if(i.forEach(o=>{["$ref","$id","$db"].indexOf(o)===-1&&(s=!1)}),s)return Xe.fromExtendedJSON(n)}return t}function Gh(t,e){return t.map((r,n)=>{e.seenObjects.push({propertyName:`index ${n}`,obj:null});try{return Me(r,e)}finally{e.seenObjects.pop()}})}function Ko(t){let e=t.toISOString();return t.getUTCMilliseconds()!==0?e:e.slice(0,-5)+"Z"}function Me(t,e){if(t instanceof Map||ui(t)){let r=Object.create(null);for(let[n,i]of t){if(typeof n!="string")throw new E("Can only serialize maps with string keys");r[n]=i}return Me(r,e)}if((typeof t=="object"||typeof t=="function")&&t!==null){let r=e.seenObjects.findIndex(n=>n.obj===t);if(r!==-1){let n=e.seenObjects.map(c=>c.propertyName),i=n.slice(0,r).map(c=>`${c} -> `).join(""),s=n[r],o=" -> "+n.slice(r+1,n.length-1).map(c=>`${c} -> `).join(""),u=n[n.length-1],l=" ".repeat(i.length+s.length/2),a="-".repeat(o.length+(s.length+u.length)/2-1);throw new E(`Converting circular structure to EJSON:
    ${i}${s}${o}${u}
    ${l}\\${a}/`)}e.seenObjects[e.seenObjects.length-1].obj=t}if(Array.isArray(t))return Gh(t,e);if(t===void 0)return null;if(t instanceof Date||tr(t)){let r=t.getTime(),n=r>-1&&r<2534023188e5;return e.legacy?e.relaxed&&n?{$date:t.getTime()}:{$date:Ko(t)}:e.relaxed&&n?{$date:Ko(t)}:{$date:{$numberLong:t.getTime().toString()}}}if(typeof t=="number"&&(!e.relaxed||!isFinite(t))){if(Number.isInteger(t)&&!Object.is(t,-0)){if(t>=Gr&&t<=Qr)return{$numberInt:t.toString()};if(t>=ta&&t<=ea)return{$numberLong:t.toString()}}return{$numberDouble:Object.is(t,-0)?"-0.0":t.toString()}}if(typeof t=="bigint")return e.relaxed?Number(BigInt.asIntN(64,t)):{$numberLong:BigInt.asIntN(64,t).toString()};if(t instanceof RegExp||er(t)){let r=t.flags;if(r===void 0){let i=t.toString().match(/[gimuy]*$/);i&&(r=i[0])}return new at(t.source,r).toExtendedJSON(e)}return t!=null&&typeof t=="object"?Xh(t,e):t}var Yh={Binary:t=>new J(t.value(),t.sub_type),Code:t=>new st(t.code,t.scope),DBRef:t=>new Xe(t.collection||t.namespace,t.oid,t.db,t.fields),Decimal128:t=>new ir(t.bytes),Double:t=>new Bt(t.value),Int32:t=>new Ct(t.value),Long:t=>T.fromBits(t.low!=null?t.low:t.low_,t.low!=null?t.high:t.high_,t.low!=null?t.unsigned:t.unsigned_),MaxKey:()=>new sr,MinKey:()=>new or,ObjectId:t=>new ot(t),BSONRegExp:t=>new at(t.pattern,t.options),BSONSymbol:t=>new ar(t.value),Timestamp:t=>Dt.fromBits(t.low,t.high)};function Xh(t,e){if(t==null||typeof t!="object")throw new E("not an object instance");let r=t._bsontype;if(typeof r>"u"){let n={};for(let i of Object.keys(t)){e.seenObjects.push({propertyName:i,obj:null});try{let s=Me(t[i],e);i==="__proto__"?Object.defineProperty(n,i,{value:s,writable:!0,enumerable:!0,configurable:!0}):n[i]=s}finally{e.seenObjects.pop()}}return n}else{if(t!=null&&typeof t=="object"&&typeof t._bsontype=="string"&&t[Symbol.for("@@mdb.bson.version")]!==xt)throw new Lt;if(Jh(t)){let n=t;if(typeof n.toExtendedJSON!="function"){let i=Yh[t._bsontype];if(!i)throw new E("Unrecognized or invalid _bsontype: "+t._bsontype);n=i(n)}return r==="Code"&&n.scope?n=new st(n.code,Me(n.scope,e)):r==="DBRef"&&n.oid&&(n=new Xe(Me(n.collection,e),Me(n.oid,e),Me(n.db,e),Me(n.fields,e))),n.toExtendedJSON(e)}else throw new E("_bsontype must be a string, but was: "+typeof r)}}function wa(t,e){let r={useBigInt64:e?.useBigInt64??!1,relaxed:e?.relaxed??!0,legacy:e?.legacy??!1};return JSON.parse(t,(n,i)=>{if(n.indexOf("\0")!==-1)throw new E(`BSON Document field names cannot contain null bytes, found: ${JSON.stringify(n)}`);return Ea(i,r)})}function Sa(t,e,r,n){r!=null&&typeof r=="object"&&(n=r,r=0),e!=null&&typeof e=="object"&&!Array.isArray(e)&&(n=e,e=void 0,r=0);let i=Object.assign({relaxed:!0,legacy:!1},n,{seenObjects:[{propertyName:"(root)",obj:null}]}),s=Me(t,i);return JSON.stringify(s,e,r)}function Kh(t,e){return e=e||{},JSON.parse(Sa(t,e))}function Zh(t,e){return e=e||{},wa(JSON.stringify(t),e)}var lr=Object.create(null);lr.parse=wa;lr.stringify=Sa;lr.serialize=Kh;lr.deserialize=Zh;Object.freeze(lr);function ai(t,e){try{return C.getNonnegativeInt32LE(t,e)}catch(r){throw new Fe("BSON size cannot be negative",e,{cause:r})}}function li(t,e){let r=e;for(;t[r]!==0;r++);if(r===t.length-1)throw new Fe("Null terminator not found",e);return r}function ef(t,e=0){if(e??=0,t.length<5)throw new Fe(`Input must be at least 5 bytes, got ${t.length} bytes`,e);let r=ai(t,e);if(r>t.length-e)throw new Fe(`Parsed documentSize (${r} bytes) does not match input length (${t.length} bytes)`,e);if(t[e+r-1]!==0)throw new Fe("BSON documents must end in 0x00",e+r);let n=[],i=e+4;for(;i<=r+e;){let s=t[i];if(i+=1,s===0){if(i-e!==r)throw new Fe("Invalid 0x00 type byte",i);break}let o=i,u=li(t,i)-o;i+=u+1;let l;if(s===1||s===18||s===9||s===17)l=8;else if(s===16)l=4;else if(s===7)l=12;else if(s===19)l=16;else if(s===8)l=1;else if(s===10||s===6||s===127||s===255)l=0;else if(s===11)l=li(t,li(t,i)+1)+1-i;else if(s===3||s===4||s===15)l=ai(t,i);else if(s===2||s===5||s===12||s===13||s===14)l=ai(t,i)+4,s===5&&(l+=1),s===12&&(l+=12);else throw new Fe(`Invalid 0x${s.toString(16).padStart(2,"0")} type byte`,i);if(l>r)throw new Fe("value reports length larger than document",i);n.push([s,o,u,i,l]),i+=l}return n}var Xr=Object.create(null);Xr.parseToElements=ef;Xr.ByteUtils=S;Xr.NumberUtils=C;Object.freeze(Xr);var ba=1024*1024*17,jr=S.allocate(ba);function Kr(t,e={}){let r=typeof e.checkKeys=="boolean"?e.checkKeys:!1,n=typeof e.serializeFunctions=="boolean"?e.serializeFunctions:!1,i=typeof e.ignoreUndefined=="boolean"?e.ignoreUndefined:!0,s=typeof e.minInternalBufferSize=="number"?e.minInternalBufferSize:ba;jr.length<s&&(jr=S.allocate(s));let o=Yr(jr,t,r,0,0,n,i,null),u=S.allocateUnsafe(o);return u.set(jr.subarray(0,o),0),u}function Ta(t,e={}){return Wh(S.toLocalBufferType(t),e)}var rn=Y(Oi()),Cf=3e4,cr=10,Df=5,Uf=2e4,Mf=3e4,kf=za.default.get("PowerSyncRemote"),Pf={socketUrlTransformer:t=>t.replace(/^https?:\/\//,function(e){return e==="https://"?"wss://":"ws://"}),fetchImplementation:Ni.fetch.bind(globalThis)},nn=class{connector;logger;credentials=null;options;constructor(e,r=kf,n){this.connector=e,this.logger=r,this.options={...Pf,...n??{}}}get fetch(){return this.options.fetchImplementation}async getCredentials(){let{expiresAt:e}=this.credentials??{};return e&&e>new Date(new Date().valueOf()+Cf)?this.credentials:(this.credentials=await this.connector.fetchCredentials(),this.credentials)}async buildRequest(e){let r=await this.getCredentials();if(r!=null&&(r.endpoint==null||r.endpoint==""))throw new Error("PowerSync endpoint not configured");if(r?.token==null||r?.token==""){let n=new Error("Not signed in");throw n.status=401,n}return{url:r.endpoint+e,headers:{"content-type":"application/json",Authorization:`Token ${r.token}`}}}async post(e,r,n={}){let i=await this.buildRequest(e),s=await(0,Ni.fetch)(i.url,{method:"POST",headers:{...n,...i.headers},body:JSON.stringify(r)});if(!s.ok)throw new Error(`Received ${s.status} - ${s.statusText} when posting to ${e}: ${await s.text()}}`);return s.json()}async get(e,r){let n=await this.buildRequest(e),i=await this.fetch(n.url,{method:"GET",headers:{...r,...n.headers}});if(!i.ok)throw new Error(`Received ${i.status} - ${i.statusText} when getting from ${e}: ${await i.text()}}`);return i.json()}async postStreaming(e,r,n={},i){let s=await this.buildRequest(e),o=await this.fetch(s.url,{method:"POST",headers:{...n,...s.headers},body:JSON.stringify(r),signal:i,cache:"no-store"}).catch(u=>{throw this.logger.error(`Caught ex when POST streaming to ${e}`,u),u});if(!o.ok){let u=await o.text();this.logger.error(`Could not POST streaming to ${e} - ${o.status} - ${o.statusText}: ${u}`);let l=new Error(`HTTP ${o.statusText}: ${u}`);throw l.status=o.status,l}return o}async socketStream(e){let{path:r}=e,n=await this.buildRequest(r),i=new Wa.RSocketConnector({transport:new Va.WebsocketClientTransport({url:this.options.socketUrlTransformer(n.url)}),setup:{keepAlive:Uf,lifetime:Mf,dataMimeType:"application/bson",metadataMimeType:"application/bson",payload:{data:null,metadata:rn.Buffer.from(Kr({token:n.headers.Authorization}))}}}),s;try{s=await i.connect()}catch(d){throw new Error(`Could not connect to PowerSync instance: ${JSON.stringify(d)}`)}let o=new Ht({logger:this.logger,pressure:{lowWaterMark:Df}}),u=!1,l=()=>{u||(u=!0,s.close())},a=cr,c=await new Promise((d,p)=>{let m=!1,w=s.requestStream({data:rn.Buffer.from(Kr(e.data)),metadata:rn.Buffer.from(Kr({path:r}))},cr,{onError:F=>{F.message!=="Closed. "&&this.logger.error(F),u=!0,o.close(),m||p(F)},onNext:F=>{m||(m=!0,d(w));let{data:A}=F;if(a--,!A)return;let O=Ta(A);o.enqueueData(O)},onComplete:()=>{o.close()},onExtension:()=>{}})}),h=o.registerListener({lowWater:async()=>{cr-a>0&&(c.request(cr-a),a=cr)},closed:()=>{l(),h?.()}});return e.abortSignal?.aborted?o.close():e.abortSignal?.addEventListener("abort",()=>{o.close()}),o}async postStream(e){let{data:r,path:n,headers:i,abortSignal:s}=e,o=await this.buildRequest(n),u=new AbortController,l=!1;s?.addEventListener("abort",()=>{l||u.abort(s.reason??new Se("Cancelling network request before it resolves. Abort signal has been received."))});let a=await this.fetch(o.url,{method:"POST",headers:{...i,...o.headers},body:JSON.stringify(r),signal:u.signal,cache:"no-store",...e.fetchOptions}).catch(A=>{throw A.name=="AbortError"?new Se(`Pending fetch request to ${o.url} has been aborted.`):A});if(!a)throw new Error("Fetch request was aborted");if(l=!0,!a.ok||!a.body){let A=await a.text();this.logger.error(`Could not POST streaming to ${n} - ${a.status} - ${a.statusText}: ${A}`);let O=new Error(`HTTP ${a.statusText}: ${A}`);throw O.status=a.status,O}let c=a.body.getReader(),h=async()=>{try{await c.cancel()}catch{}c.releaseLock()};s?.addEventListener("abort",()=>{h()});let d=new ReadableStream({start:A=>{(async()=>{for(;!s?.aborted;)try{let{done:V,value:_}=await c.read();if(V)break;A.enqueue(_)}catch(V){this.logger.error("Caught exception when reading sync stream",V);break}s?.aborted||await h(),A.close()})()}}),p=(0,Ha.default)(new Response(d).body),m=new Ht({logger:this.logger}),w=p.getReader(),F=m.registerListener({lowWater:async()=>{try{let{done:A,value:O}=await w.read();if(A){m.close(),F?.();return}m.enqueueData(O)}catch(A){throw m.close(),A}},closed:()=>{h(),F?.()}});return m}};var ct;(function(t){t.TEXT="TEXT",t.INTEGER="INTEGER",t.REAL="REAL"})(ct||(ct={}));var em={type:ct.TEXT},tm={type:ct.INTEGER},rm={type:ct.REAL};var sn=class extends Nr{constructor(e){super(e)}get webOptions(){return this.options}obtainLock(e){let r=`streaming-sync-${e.type}-${this.webOptions.identifier}`;return e.type==mt.SYNC&&console.debug("requesting lock for ",r),navigator.locks.request(r,{signal:e.signal},e.callback)}};var on=class extends nn{};var Qa=Y(_e());function $f(t,e=!0){return e?new SharedWorker(new URL("./SharedWASQLiteDB.worker.js",import.meta.url),{name:`shared-DB-worker-${t}`,type:"module"}).port:new Worker(new URL("./WASQLiteDB.worker.js",import.meta.url),{name:`DB-worker-${t}`,type:"module"})}function Ja(t,e=!0){return et($f(t,e))}var Z=function(t,e,r,n){function i(s){return s instanceof r?s:new r(function(o){o(s)})}return new(r||(r=Promise))(function(s,o){function u(c){try{a(n.next(c))}catch(h){o(h)}}function l(c){try{a(n.throw(c))}catch(h){o(h)}}function a(c){c.done?s(c.value):i(c.value).then(u,l)}a((n=n.apply(t,e||[])).next())})},an=class extends oe{constructor(e){super(),this.options=e,this._execute=(r,n)=>Z(this,void 0,void 0,function*(){yield this.initialized;let i=yield this.workerMethods.execute(r,n);return Object.assign(Object.assign({},i),{rows:Object.assign(Object.assign({},i.rows),{item:s=>i.rows._array[s]})})}),this._executeBatch=(r,n)=>Z(this,void 0,void 0,function*(){yield this.initialized;let i=yield this.workerMethods.executeBatch(r,n);return Object.assign(Object.assign({},i),{rows:void 0})}),this.logger=Qa.default.get("WASQLite"),this.dbGetHelpers=null,this.workerMethods=null,this.initialized=this.init(),this.dbGetHelpers=this.generateDBHelpers({execute:this._execute.bind(this)})}get name(){return this.options.dbFilename}get flags(){var e;return(e=this.options.flags)!==null&&e!==void 0?e:{}}getWorker(){}init(){return Z(this,void 0,void 0,function*(){let{enableMultiTabs:e}=this.flags;e||this.logger.warn("Multiple tabs are not enabled in this browser");let r=this.options.workerPort?et(this.options.workerPort):Ja(this.options.dbFilename,e);this.workerMethods=yield r(this.options.dbFilename),this.workerMethods.registerOnTableChange(gn((n,i,s)=>{this.iterateListeners(o=>{var u;return(u=o.tablesUpdated)===null||u===void 0?void 0:u.call(o,{opType:n,table:i,rowId:s})})}))})}execute(e,r){return Z(this,void 0,void 0,function*(){return this.writeLock(n=>n.execute(e,r))})}executeBatch(e,r){return Z(this,void 0,void 0,function*(){return this.writeLock(n=>this._executeBatch(e,r))})}close(){var e,r;(r=(e=this.workerMethods)===null||e===void 0?void 0:e.close)===null||r===void 0||r.call(e)}getAll(e,r){return Z(this,void 0,void 0,function*(){return yield this.initialized,this.dbGetHelpers.getAll(e,r)})}getOptional(e,r){return Z(this,void 0,void 0,function*(){return yield this.initialized,this.dbGetHelpers.getOptional(e,r)})}get(e,r){return Z(this,void 0,void 0,function*(){return yield this.initialized,this.dbGetHelpers.get(e,r)})}readLock(e,r){return Z(this,void 0,void 0,function*(){return yield this.initialized,this.acquireLock(()=>Z(this,void 0,void 0,function*(){return e(this.generateDBHelpers({execute:this._execute}))}))})}writeLock(e,r){return Z(this,void 0,void 0,function*(){return yield this.initialized,this.acquireLock(()=>Z(this,void 0,void 0,function*(){return e(this.generateDBHelpers({execute:this._execute}))}))})}acquireLock(e){return navigator.locks.request(`db-lock-${this.options.dbFilename}`,e)}readTransaction(e,r){return Z(this,void 0,void 0,function*(){return this.readLock(this.wrapTransaction(e))})}writeTransaction(e,r){return this.writeLock(this.wrapTransaction(e))}wrapTransaction(e){return r=>Z(this,void 0,void 0,function*(){yield this._execute("BEGIN TRANSACTION");let n=!1,i=()=>Z(this,void 0,void 0,function*(){return n?{rowsAffected:0}:(n=!0,this._execute("COMMIT"))}),s=()=>(n=!0,this._execute("ROLLBACK"));try{let o=yield e(Object.assign(Object.assign({},r),{commit:i,rollback:s}));return n||(yield i()),o}catch(o){throw this.logger.debug("Caught ex in transaction",o),yield s(),o}})}generateDBHelpers(e){return Object.assign(Object.assign({},e),{getAll(r,n){return Z(this,void 0,void 0,function*(){var i,s;return(s=(i=(yield e.execute(r,n)).rows)===null||i===void 0?void 0:i._array)!==null&&s!==void 0?s:[]})},getOptional(r,n){return Z(this,void 0,void 0,function*(){var i,s;return(s=(i=(yield e.execute(r,n)).rows)===null||i===void 0?void 0:i.item(0))!==null&&s!==void 0?s:null})},get(r,n){return Z(this,void 0,void 0,function*(){var i;let o=(i=(yield e.execute(r,n)).rows)===null||i===void 0?void 0:i.item(0);if(!o)throw new Error("Result set is empty");return o})}})}};var Pe=Y(_e()),jf=function(t,e,r,n){function i(s){return s instanceof r?s:new r(function(o){o(s)})}return new(r||(r=Promise))(function(s,o){function u(c){try{a(n.next(c))}catch(h){o(h)}}function l(c){try{a(n.throw(c))}catch(h){o(h)}}function a(c){c.done?s(c.value):i(c.value).then(u,l)}a((n=n.apply(t,e||[])).next())})},ln=class{constructor(e){this.clients=e,this.TRACE=Pe.default.TRACE,this.DEBUG=Pe.default.DEBUG,this.INFO=Pe.default.INFO,this.TIME=Pe.default.TIME,this.WARN=Pe.default.WARN,this.ERROR=Pe.default.ERROR,this.OFF=Pe.default.OFF}trace(...e){console.trace(...e);let r=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.trace(...r))}debug(...e){console.debug(...e);let r=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.debug(...r))}info(...e){console.info(...e);let r=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.info(...r))}log(...e){console.log(...e);let r=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.log(...r))}warn(...e){console.warn(...e);let r=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.warn(...r))}error(...e){console.error(...e);let r=this.sanitizeArgs(e);this.iterateClients(n=>n.clientProvider.error(...r))}time(e){console.time(e),this.iterateClients(r=>r.clientProvider.time(e))}timeEnd(e){console.timeEnd(e),this.iterateClients(r=>r.clientProvider.timeEnd(e))}setLevel(e){}getLevel(){return Pe.default.INFO}enabledFor(e){return!0}iterateClients(e){return jf(this,void 0,void 0,function*(){for(let r of this.clients)try{yield e(r)}catch(n){console.error("Caught exception when iterating client",n)}})}sanitizeArgs(e){return e.map(n=>{try{return structuredClone(n)}catch(i){return console.error(i),"Could not serialize log params. Check shared worker logs for more details."}})}};var we=function(t,e,r,n){function i(s){return s instanceof r?s:new r(function(o){o(s)})}return new(r||(r=Promise))(function(s,o){function u(c){try{a(n.next(c))}catch(h){o(h)}}function l(c){try{a(n.throw(c))}catch(h){o(h)}}function a(c){c.done?s(c.value):i(c.value).then(u,l)}a((n=n.apply(t,e||[])).next())})},un;(function(t){t.CLOSE_CLIENT="close-client"})(un||(un={}));var cn=class extends oe{constructor(){super(),this.ports=[],this.isInitialized=new Promise(e=>{let r=this.registerListener({initialized:()=>{e(),r?.()}})}),this.syncStatus=new ge({}),this.broadCastLogger=new ln(this.ports)}waitForStatus(e){return we(this,void 0,void 0,function*(){return yield this.waitForReady(),this.syncStreamClient.waitForStatus(e)})}get lastSyncedAt(){var e;return(e=this.syncStreamClient)===null||e===void 0?void 0:e.lastSyncedAt}get isConnected(){var e,r;return(r=(e=this.syncStreamClient)===null||e===void 0?void 0:e.isConnected)!==null&&r!==void 0?r:!1}waitForReady(){return we(this,void 0,void 0,function*(){return this.isInitialized})}init(e,r){return we(this,void 0,void 0,function*(){var n,i;if(this.syncStreamClient)return;let s=!((i=(n=r.streamOptions)===null||n===void 0?void 0:n.flags)===null||i===void 0)&&i.broadcastLogs?this.broadCastLogger:Ga.default.get("shared-sync");self.onerror=o=>{s.error("Uncaught exception in PowerSync shared sync worker",o)},this.syncStreamClient=new sn(Object.assign(Object.assign({adapter:new Ar(new an({dbFilename:r.dbName,workerPort:e,flags:{enableMultiTabs:!0},logger:s}),new dt,s),remote:new on({fetchCredentials:()=>we(this,void 0,void 0,function*(){let o=this.ports[this.ports.length-1];return new Promise((u,l)=>we(this,void 0,void 0,function*(){let a=new AbortController;this.fetchCredentialsController={controller:a,activePort:o},a.signal.onabort=l;try{u(yield o.clientProvider.fetchCredentials())}catch(c){l(c)}finally{this.fetchCredentialsController=void 0}}))})}),uploadCrud:()=>we(this,void 0,void 0,function*(){let o=this.ports[this.ports.length-1];return new Promise((u,l)=>we(this,void 0,void 0,function*(){let a=new AbortController;this.uploadDataController={controller:a,activePort:o},a.signal.onabort=()=>u();try{u(yield o.clientProvider.uploadCrud())}catch(c){l(c)}finally{this.uploadDataController=void 0}}))})},r.streamOptions),{logger:s})),this.syncStreamClient.registerListener({statusChanged:o=>{this.updateAllStatuses(o.toJSON())}}),this.iterateListeners(o=>{var u;return(u=o.initialized)===null||u===void 0?void 0:u.call(o)})})}dispose(){return we(this,void 0,void 0,function*(){var e,r;return yield this.waitForReady(),(e=this.statusListener)===null||e===void 0||e.call(this),(r=this.syncStreamClient)===null||r===void 0?void 0:r.dispose()})}connect(e){return we(this,void 0,void 0,function*(){return yield this.waitForReady(),navigator.locks.request("shared-sync-connect",()=>{var r;return(r=this.syncStreamClient)===null||r===void 0?void 0:r.connect(e)})})}disconnect(){return we(this,void 0,void 0,function*(){return yield this.waitForReady(),navigator.locks.request("shared-sync-connect",()=>{var e;return(e=this.syncStreamClient)===null||e===void 0?void 0:e.disconnect()})})}addPort(e){var r;let n={port:e,clientProvider:et(e)};this.ports.push(n);let i=(r=this.syncStreamClient)===null||r===void 0?void 0:r.syncStatus;i&&n.clientProvider.statusChanged(i.toJSON())}removePort(e){let r=this.ports.findIndex(i=>i.port==e);if(r<0){console.warn(`Could not remove port ${e} since it is not present in active ports.`);return}this.ports[r].clientProvider[mn](),this.ports.splice(r,1),[this.fetchCredentialsController,this.uploadDataController].forEach(i=>{i?.activePort.port==e&&i.controller.abort(new Se("Closing pending requests after client port is removed"))})}triggerCrudUpload(){this.waitForReady().then(()=>{var e;return(e=this.syncStreamClient)===null||e===void 0?void 0:e.triggerCrudUpload()})}obtainLock(e){return we(this,void 0,void 0,function*(){return yield this.waitForReady(),this.syncStreamClient.obtainLock(e)})}hasCompletedSync(){return we(this,void 0,void 0,function*(){return yield this.waitForReady(),this.syncStreamClient.hasCompletedSync()})}getWriteCheckpoint(){return we(this,void 0,void 0,function*(){return yield this.waitForReady(),this.syncStreamClient.getWriteCheckpoint()})}updateAllStatuses(e){this.syncStatus=new ge(e),this.ports.forEach(r=>r.clientProvider.statusChanged(e))}_testUpdateAllStatuses(e){this.syncStreamClient||console.warn("no stream client has been initialized yet"),this.syncStreamClient.syncStatus=new ge(e),this.updateAllStatuses(e)}};var Ya=Y(_e()),Xa=Y(Oi());typeof self.Buffer>"u"&&(self.Buffer=Xa.Buffer);var zf=self;Ya.default.useDefaults();var Ai=new cn;zf.onconnect=function(t){let e=t.ports[0];e.addEventListener("message",r=>{let n=r.data;n?.event==un.CLOSE_CLIENT&&(console.log("closing shared for port",e),Ai.removePort(e))}),yr(Ai,e),Ai.addPort(e)};
